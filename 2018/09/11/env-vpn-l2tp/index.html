<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="tools,Mac,">





  <link rel="alternate" href="/atom.xml" title="老司机种菜" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="l2tp VPN搭建l2tp server搭建完成使用方法步骤即可翻墙 写在前面本脚本适用环境： 系统支持：CentOS6+，Debian7+，Ubuntu12+ 内存要求：≥128M 更新日期：2017 年 02 月 25 日 关于本脚本名词解释如下  L2TP（Layer 2 Tunneling Protocol） IPSec（Internet Protocol Security） IKEv2">
<meta name="keywords" content="tools,Mac">
<meta property="og:type" content="article">
<meta property="og:title" content="l2tp VPN搭建">
<meta property="og:url" content="http://wodekouwei.com/2018/09/11/env-vpn-l2tp/index.html">
<meta property="og:site_name" content="老司机种菜">
<meta property="og:description" content="l2tp VPN搭建l2tp server搭建完成使用方法步骤即可翻墙 写在前面本脚本适用环境： 系统支持：CentOS6+，Debian7+，Ubuntu12+ 内存要求：≥128M 更新日期：2017 年 02 月 25 日 关于本脚本名词解释如下  L2TP（Layer 2 Tunneling Protocol） IPSec（Internet Protocol Security） IKEv2">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-02-27T10:45:37.828Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="l2tp VPN搭建">
<meta name="twitter:description" content="l2tp VPN搭建l2tp server搭建完成使用方法步骤即可翻墙 写在前面本脚本适用环境： 系统支持：CentOS6+，Debian7+，Ubuntu12+ 内存要求：≥128M 更新日期：2017 年 02 月 25 日 关于本脚本名词解释如下  L2TP（Layer 2 Tunneling Protocol） IPSec（Internet Protocol Security） IKEv2">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wodekouwei.com/2018/09/11/env-vpn-l2tp/">





  <title> l2tp VPN搭建 | 老司机种菜 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2021aa5f03a4203621d42ef374e0d5f7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">老司机种菜</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2018/09/11/env-vpn-l2tp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                l2tp VPN搭建
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-11T22:25:48+08:00">
                2018-09-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/env/" itemprop="url" rel="index">
                    <span itemprop="name">env</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2018/09/11/env-vpn-l2tp/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="l2tp-VPN搭建"><a href="#l2tp-VPN搭建" class="headerlink" title="l2tp VPN搭建"></a>l2tp VPN搭建</h2><h3 id="l2tp-server搭建"><a href="#l2tp-server搭建" class="headerlink" title="l2tp server搭建"></a>l2tp server搭建</h3><p>完成<code>使用方法</code>步骤即可翻墙</p>
<h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>本脚本适用环境：
系统支持：CentOS6+，Debian7+，Ubuntu12+
内存要求：≥128M
更新日期：2017 年 02 月 25 日
关于本脚本名词解释如下</p>
<ul>
<li>L2TP（Layer 2 Tunneling Protocol）</li>
<li>IPSec（Internet Protocol Security）</li>
<li>IKEv2 (Internet Key Exchange v2)
能实现 IPsec 的目前总体上有 openswan，libreswan，strongswan 这3种。
libreswan 是基于 openswan 的 fork，所以现在各个发行版基本已经看不到 openswan 的身影了。当然也有使用 strongswan 的。</li>
</ul>
<p>之所以要更新 L2TP 一键安装脚本，是因为随着各个 Linux 发行版不断推陈出新，原有的脚本已经不适应现在的需求。
本脚本通过编译安装最新版 libreswan 来实现 IPSec（CentOS7 下则是全部 yum 安装），yum 或 apt-get 来安装 xl2tpd，再根据各个发行版的使用方法不同，部署防火墙规则。</p>
<p>基于 OpenVZ 虚拟化技术的 VPS 需要开启TUN/TAP才能正常使用，购买 VPS 时请先咨询服务商是否支持开启 TUN/TAP。</p>
<p>OpenVZ 虚拟的 VPS 需要系统内核支持 IPSec 才行。也就是说，母服务器的内核如果不支持的话那就没办法，只能换 VPS。
因此，一般不建议在 OpenVZ 的 VPS 上安装本脚本。脚本如果检测到该 VPS 为 OpenVZ 架构，会出现警告提醒。</p>
<p>如何检测是否支持TUN模块？
执行命令：
<code>cat /dev/net/tun</code>
如果返回信息为：<code>cat: /dev/net/tun: File descriptor in bad state</code> 说明正常</p>
<p>如何检测是否支持ppp模块？
执行命令：
<code>cat /dev/ppp</code>
如果返回信息为：<code>cat: /dev/ppp: No such device or address</code> 说明正常
当然，脚本在安装时也会执行检查，如果不适用于安装，脚本会予以提示。</p>
<p>搬瓦工使用的是OpenVZ架构,就算检测到支持TUN模块也不能成功翻墙,新出了KVM架构的VPS,价格稍微贵些</p>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><blockquote>
<p>一键安装脚本:<a href="https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/README-zh.md" target="_blank" rel="noopener">https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/README-zh.md</a>
root 用户登录后，运行以下命令：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget --no-check-certificate https://raw.githubusercontent.com/teddysun/across/master/l2tp.sh</span><br><span class="line">chmod +x l2tp.sh</span><br><span class="line">./l2tp.sh</span><br></pre></td></tr></table></figure>

<p>Please input IP-Range:
(Default Range: 192.168.18):
输入本地IP段范围（本地电脑连接到VPS后给分配的一个本地IP地址），直接回车意味着输入默认值192.168.18</p>
<p>Please input PSK:
(Default PSK: teddysun.com):
PSK意为预共享密钥，即指定一个密钥将来在连接时需要用到，直接回车意味着输入默认值teddysun.com</p>
<p>Please input Username:
(Default Username: teddysun):
Username意为用户名，即第一个默认用户。直接回车意味着输入默认值teddysun</p>
<p>Please input teddysun’s password:
(Default Password: Q4SKhu2EXQ):
输入用户的密码，默认会随机生成一个10位包含大小写字母和数字的密码，当然你也可以指定密码。</p>
<p>ServerIP:your_server_main_IP
显示你的 VPS 的主 IP（如果是多 IP 的 VPS 也只显示一个）</p>
<p>Server Local IP:192.168.18.1
显示你的 VPS 的本地 IP（默认即可）</p>
<p>Client Remote IP Range:192.168.18.2-192.168.18.254
显示 IP 段范围</p>
<p>PSK:teddysun.com
显示 PSK</p>
<p>Press any key to start…or Press Ctrl+c to cancel
按下任意按键继续，如果想取消安装，请按Ctrl+c键</p>
<p>安装完成后，脚本会执行 ipsec verify 命令并提示如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">If there are no [FAILED] above, then you can connect to your</span><br><span class="line">L2TP VPN Server with the default Username/Password is below:</span><br><span class="line"></span><br><span class="line">ServerIP:your_server_IP</span><br><span class="line">PSK:your PSK</span><br><span class="line">Username:your usename</span><br><span class="line">Password:your password</span><br><span class="line"></span><br><span class="line">If you want to modify user settings, please use command(s):</span><br><span class="line">l2tp -a (Add a user)</span><br><span class="line">l2tp -d (Delete a user)</span><br><span class="line">l2tp -l (List all users)</span><br><span class="line">l2tp -m (Modify a user password)</span><br><span class="line">Welcome to visit https://teddysun.com/448.html</span><br><span class="line">Enjoy it!</span><br></pre></td></tr></table></figure>

<p>其他事项:</p>
<ol>
<li>脚本在安装完成后，已自动启动进程，并加入了开机自启动。</li>
<li>脚本会改写 iptables 或 firewalld 的规则。</li>
<li>脚本安装时，会即时将安装日志写到 /root/l2tp.log 文件里，如果你安装失败，可以通过此文件来寻找错误信息。</li>
</ol>
<p>安装完成需要修改路由配置才能翻墙,要不会导致客户端能连上但是不能翻墙.创建脚本set_iptables.sh,输入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.10.10.0/24 -o $eth -j MASQUERADE</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.10.10.0/24 -j SNAT --to-source 119.28.59.230</span><br></pre></td></tr></table></figure>

<p>$eth一般换成eth0,可以使用ifconfig查看,119.28.59.230换成自己服务器公网地址</p>
<h4 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h4><h5 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h5><p>安卓6.0系统无法成功连接l2tp，查了谷歌之后发现好像是安卓是sha256加密
我是这么做的，目前正常连接一小时，没有断线，mac ios android
需要在 <code>/etc/ipsec.conf</code> 的 <code>conn L2TP-PSK-noNAT</code> 下加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha2-truncbug=yes</span><br></pre></td></tr></table></figure>

<p>然后重启 IPSec 和 xl2tpd 服务，重新连接就可以了。
可以解决安卓 6.0 的 vpn 无法连接问题。</p>
<h5 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h5><p>在<code>/etc/ipsec.conf</code> 的 <code>conn L2TP-PSK-noNAT</code> 下加入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">leftnexthop defaultroute</span><br><span class="line">rightnexthop defaultroute</span><br></pre></td></tr></table></figure>

<p>然后重启 IPSec 和 xl2tpd 服务应该可以解决同一局域下多人连接的时候，出现连接不上的情况。
如果还是不行，就得看下这个链接里面的配置：
<a href="https://segmentfault.com/a/1190000005626927" target="_blank" rel="noopener">https://segmentfault.com/a/1190000005626927</a>
我就是根据这个里面的配置和你的对比改好了。</p>
<h4 id="安装完成后配置文件"><a href="#安装完成后配置文件" class="headerlink" title="安装完成后配置文件"></a>安装完成后配置文件</h4><p><strong>(不需要手动配置,学习用)</strong></p>
<h5 id="l2tp-etc-xl2tpd-xl2tpd-conf"><a href="#l2tp-etc-xl2tpd-xl2tpd-conf" class="headerlink" title="l2tp/etc/xl2tpd/xl2tpd.conf"></a>l2tp<code>/etc/xl2tpd/xl2tpd.conf</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">ipsec saref = no</span><br><span class="line"></span><br><span class="line">[lns default]</span><br><span class="line">ip range = 10.152.2.2-10.152.2.254</span><br><span class="line">local ip = 10.152.2.1</span><br><span class="line">require chap = yes</span><br><span class="line">refuse pap = yes</span><br><span class="line">require authentication = yes</span><br><span class="line">ppp debug = yes</span><br><span class="line">pppoptfile = /etc/ppp/options.xl2tpd</span><br><span class="line">length bit = yes</span><br></pre></td></tr></table></figure>

<p>配置说明如下：</p>
<ul>
<li>ip range = 可以连接VPN服务的客户端IP地址范围</li>
<li>local ip = VPN 服务器的IP，必须在客户端IP范围之外</li>
<li>refuse pap = 拒绝 pap 认证</li>
<li>ppp debug = 测试时打开<h5 id="l2tp-etc-xl2tpd-l2tp-secrets"><a href="#l2tp-etc-xl2tpd-l2tp-secrets" class="headerlink" title="l2tp/etc/xl2tpd/l2tp-secrets"></a>l2tp<code>/etc/xl2tpd/l2tp-secrets</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* * exampleforchallengestring</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>配置密码</p>
<h5 id="l2tp-etc-ppp-options-xl2tpd"><a href="#l2tp-etc-ppp-options-xl2tpd" class="headerlink" title="l2tp/etc/ppp/options.xl2tpd"></a>l2tp<code>/etc/ppp/options.xl2tpd</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">refuse-mschap-v2</span><br><span class="line">refuse-mschap</span><br><span class="line">ms-dns 8.8.8.8</span><br><span class="line">ms-dns 8.8.4.4</span><br><span class="line">asyncmap 0</span><br><span class="line">auth</span><br><span class="line">crtscts</span><br><span class="line">idle 1800</span><br><span class="line">mtu 1200</span><br><span class="line">mru 1200</span><br><span class="line">lock</span><br><span class="line">hide-password</span><br><span class="line">local</span><br><span class="line">#debug</span><br><span class="line">name l2tpd</span><br><span class="line">proxyarp</span><br><span class="line">lcp-echo-interval 30</span><br><span class="line">lcp-echo-failure 4</span><br></pre></td></tr></table></figure>

<ul>
<li>ms-dns 选项设置要给客户端分配的 DNS 服务器，当客户端连接时，就会被分配这些 DNS。如果要加入多个 DNS，就每行一个，分别写几行。</li>
</ul>
<p>如果你要给客户端推送wins设置，可以分别设置如下选项。</p>
<p>mtu 和 mru 按照openswan.org的说法，减小 mru/mtu 的大小非常重要。因为  l2tp/ipsec 会封装几次，可能导致性能下降，减小这个配置的大小可以一次性传输全部的包。</p>
<p>proxyarp 可以将连接的客户端的IP地址和以太网地址加入的系统的ARP表中。这会影响到本地局域网内其它客户端。</p>
<p>name l2tpd 用在 PPP验证文件里面。</p>
<h5 id="ipsec-etc-ppp-chap-secrets"><a href="#ipsec-etc-ppp-chap-secrets" class="headerlink" title="ipsec/etc/ppp/chap-secrets"></a>ipsec<code>/etc/ppp/chap-secrets</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user1 l2tpd chooseagoodpassword *</span><br><span class="line">user2 * chooseagoodpassword *</span><br></pre></td></tr></table></figure>

<p>每行包括如下字段：</p>
<ul>
<li>客户端 = 用户名称</li>
<li>服务器 = 在上面的 /etc/ppp/options.xl2tpd 定义的名字</li>
<li>密码 = 用户密码，你应该设置一个足够复杂的密码</li>
<li>IP 地址 = * 表示用户可以从任何地址连接，否则设置用户只能从特定的地址连接</li>
</ul>
<h5 id="ipsec-etc-ipsec-conf"><a href="#ipsec-etc-ipsec-conf" class="headerlink" title="ipsec/etc/ipsec.conf"></a>ipsec<code>/etc/ipsec.conf</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">config setup</span><br><span class="line">        nat_traversal=yes</span><br><span class="line">        virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:!10.152.2.0/24</span><br><span class="line">        # 这里包含的网络地址允许配置为远程客户端所在的子网。换句话说，</span><br><span class="line">        # 这些地址范围应该是你的NAT路由器后面的客户端的地址。</span><br><span class="line">        oe=off</span><br><span class="line">        protostack=netkey</span><br><span class="line"></span><br><span class="line">conn L2TP-PSK-NAT</span><br><span class="line">        rightsubnet=vhost:%priv</span><br><span class="line">        also=L2TP-PSK-noNAT</span><br><span class="line"></span><br><span class="line">conn L2TP-PSK-noNAT</span><br><span class="line">        authby=secret</span><br><span class="line">        pfs=no</span><br><span class="line">        auto=add</span><br><span class="line">        keyingtries=3</span><br><span class="line">        rekey=no</span><br><span class="line">        # Apple 的 iOS 不会发送 delete 提醒，</span><br><span class="line">        # 所以我们需要通过死亡对端（dead peer）检测来识别断掉的客户端</span><br><span class="line">        dpddelay=30</span><br><span class="line">        dpdtimeout=120</span><br><span class="line">        dpdaction=clear</span><br><span class="line">        # 设置 ikelifetime 和 keylife 和 Windows 的默认设置一致</span><br><span class="line">        ikelifetime=8h</span><br><span class="line">        keylife=1h</span><br><span class="line">        type=transport</span><br><span class="line">        # 替换 IP 地址为你的本地IP （一般是，私有地址、NAT内的地址）</span><br><span class="line">        left=x.x.x.x</span><br><span class="line">        # 用于升级过的 Windows 2000/XP 客户端</span><br><span class="line">        leftprotoport=17/1701</span><br><span class="line">        # 要支持老的客户端，需要设置 leftprotoport=17/%any</span><br><span class="line">        right=%any</span><br><span class="line">        rightprotoport=17/%any</span><br><span class="line">        # 强制所有连接都NAT，因为 iOS</span><br><span class="line">        forceencaps=yes</span><br></pre></td></tr></table></figure>

<p>注意你的ipsec.conf文件，”config setup” 和 “L2TP-PSK-NAT”、 “L2TP-PSK-NAT”应该顶着行头写，而其它行应该以8个空格缩进。</p>
<h5 id="ipsec-etc-ipsec-secrets"><a href="#ipsec-etc-ipsec-secrets" class="headerlink" title="ipsec/etc/ipsec.secrets"></a>ipsec<code>/etc/ipsec.secrets</code></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x.x.x.x   %any:  PSK &quot;somegoodpassword&quot;</span><br></pre></td></tr></table></figure>

<p>这里x.x.x.x 替换为你的服务器的IP地址，并设置一个复杂的密码</p>
<h5 id="etc-init-d"><a href="#etc-init-d" class="headerlink" title="/etc/init.d"></a><code>/etc/init.d</code></h5><p>在<code>/etc/init.d</code>下创建一个名为<code>ipsec.vpn</code>的文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">case &quot;$1&quot; in</span><br><span class="line">  start)</span><br><span class="line">    echo &quot;Starting my Ipsec VPN&quot;</span><br><span class="line">    iptables  -t nat   -A POSTROUTING -o eth0 -s 10.152.2.0/24 -j MASQUERADE</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">    for each in /proc/sys/net/ipv4/conf/*</span><br><span class="line">    do</span><br><span class="line">      echo 0 &gt; $each/accept_redirects</span><br><span class="line">      echo 0 &gt; $each/send_redirects</span><br><span class="line">    done</span><br><span class="line">    /etc/init.d/ipsec start</span><br><span class="line">    /etc/init.d/xl2tpd start</span><br><span class="line">;;</span><br><span class="line">  stop)</span><br><span class="line">    echo &quot;Stopping my Ipsec VPN&quot;</span><br><span class="line">    iptables --table nat --flush</span><br><span class="line">    echo 0 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">    /etc/init.d/ipsec stop</span><br><span class="line">    /etc/init.d/xl2tpd stop</span><br><span class="line">;;</span><br><span class="line">  restart)</span><br><span class="line">    echo &quot;Restarting my Ipsec VPN&quot;</span><br><span class="line">    iptables  -t nat   -A POSTROUTING -o eth0 -s 10.152.2.0/24 -j MASQUERADE</span><br><span class="line">    echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">    for each in /proc/sys/net/ipv4/conf/*</span><br><span class="line">    do</span><br><span class="line">      echo 0 &gt; $each/accept_redirects</span><br><span class="line">      echo 0 &gt; $each/send_redirects</span><br><span class="line">    done</span><br><span class="line">    /etc/init.d/ipsec restart</span><br><span class="line">    /etc/init.d/xl2tpd restart</span><br><span class="line">;;</span><br><span class="line">  *)</span><br><span class="line">    echo &quot;Usage: /etc/init.d/ipsec.vpn  &#123;start|stop|restart&#125;&quot;</span><br><span class="line">    exit 1</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure>

<p>这会配置防火墙转发。记得修改上面文件的本地IP地址池10.152.2.0/24为你自己的。
给这个文件设置可执行权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 755 ipsec.vpn</span><br></pre></td></tr></table></figure>

<p>禁止默认的 ipsec 服务脚本运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-rc.d -f ipsec remove</span><br></pre></td></tr></table></figure>

<p>然后，启用我们刚才定制的这个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-rc.d ipsec.vpn defaults</span><br></pre></td></tr></table></figure>

<h4 id="l2tp-sh脚本命令"><a href="#l2tp-sh脚本命令" class="headerlink" title="l2tp.sh脚本命令"></a>l2tp.sh脚本命令</h4><p>如果你要想对用户进行操作，可以使用如下命令：</p>
<ul>
<li>l2tp -a 新增用户</li>
<li>l2tp -d 删除用户</li>
<li>l2tp -m 修改现有的用户的密码</li>
<li>l2tp -l 列出所有用户名和密码</li>
<li>l2tp -h 列出帮助信息</li>
</ul>
<h4 id="ipsec-amp-xl2tpd命令-用"><a href="#ipsec-amp-xl2tpd命令-用" class="headerlink" title="ipsec &amp; xl2tpd命令(用)"></a>ipsec &amp; xl2tpd命令(用)</h4><ul>
<li><p>ipsec status （查看 IPSec 运行状态）</p>
</li>
<li><p>ipsec verify （查看 IPSec 检查结果）</p>
</li>
<li><p>/etc/init.d/ipsec start|stop|restart|status （CentOS6 下使用）</p>
</li>
<li><p>/etc/init.d/xl2tpd start|stop|restart （CentOS6 下使用）</p>
</li>
<li><p>systemctl start|stop|restart|status ipsec （CentOS7 下使用）</p>
</li>
<li><p>systemctl start|stop|restart xl2tpd （CentOS7 下使用）</p>
</li>
<li><p>service ipsec start|stop|restart|status （Debian/Ubuntu 下使用）</p>
</li>
<li><p>service xl2tpd start|stop|restart （Debian/Ubuntu 下使用）</p>
</li>
<li><p><code>ipsec whack --trafficstatus</code>:查看链接客户端信息</p>
</li>
</ul>
<h4 id="排除故障"><a href="#排除故障" class="headerlink" title="排除故障"></a>排除故障</h4><p>如果遇到了问题，以下命令可以帮助你找到问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i ppp0</span><br><span class="line">sudo tail -f /var/log/auth.log</span><br><span class="line">sudo tail -f /var/log/syslog</span><br></pre></td></tr></table></figure>

<p>你可以可以在服务器上使用如下命令来监控：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i eth0 host aaa.bbb.ccc.ddd and not port ssh</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="https://linux.cn/article-3409-1.html" target="_blank" rel="noopener">参考</a></p>
</blockquote>
<h3 id="l2tp-客户端连接-主要是ubuntu"><a href="#l2tp-客户端连接-主要是ubuntu" class="headerlink" title="l2tp 客户端连接(主要是ubuntu)"></a>l2tp 客户端连接(主要是ubuntu)</h3><p>以下步骤是在 <a href="https://gist.github.com/psanford/42c550a1a6ad3cb70b13e4aaa94ddb1c" target="_blank" rel="noopener">Peter Sanford 的工作</a> 基础上修改。这些命令必须在你的 VPN 客户端上使用 <code>root</code> 账户运行。</p>
<p>参考自:<a href="https://github.com/hwdsl2/setup-ipsec-vpn" target="_blank" rel="noopener">https://github.com/hwdsl2/setup-ipsec-vpn</a> 下doc下的clients-zh.md,客户端和服务器配置教程工具都下载到了<code>Doc/vpn_doc</code>
要配置 VPN 客户端，首先安装以下软件包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Ubuntu &amp; Debian</span><br><span class="line">apt-get update</span><br><span class="line">apt-get -y install strongswan xl2tpd</span><br><span class="line"></span><br><span class="line"># CentOS &amp; RHEL</span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install strongswan xl2tpd</span><br><span class="line"></span><br><span class="line"># Fedora</span><br><span class="line">yum -y install strongswan xl2tpd</span><br></pre></td></tr></table></figure>

<p>创建 VPN 变量 （替换为你自己的值）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VPN_SERVER_IP=&apos;your_vpn_server_ip&apos;</span><br><span class="line">VPN_IPSEC_PSK=&apos;your_ipsec_pre_shared_key&apos;</span><br><span class="line">VPN_USER=&apos;your_vpn_username&apos;</span><br><span class="line">VPN_PASSWORD=&apos;your_vpn_password&apos;</span><br></pre></td></tr></table></figure>

<p>配置 strongSwan：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/ipsec.conf &lt;&lt;EOF</span><br><span class="line"># ipsec.conf - strongSwan IPsec configuration file</span><br><span class="line"></span><br><span class="line"># basic configuration</span><br><span class="line"></span><br><span class="line">config setup</span><br><span class="line">  # strictcrlpolicy=yes</span><br><span class="line">  # uniqueids = no</span><br><span class="line"></span><br><span class="line"># Add connections here.</span><br><span class="line"></span><br><span class="line"># Sample VPN connections</span><br><span class="line"></span><br><span class="line">conn %default</span><br><span class="line">  ikelifetime=60m</span><br><span class="line">  keylife=20m</span><br><span class="line">  rekeymargin=3m</span><br><span class="line">  keyingtries=1</span><br><span class="line">  keyexchange=ikev1</span><br><span class="line">  authby=secret</span><br><span class="line">  ike=aes128-sha1-modp1024,3des-sha1-modp1024!</span><br><span class="line">  esp=aes128-sha1-modp1024,3des-sha1-modp1024!</span><br><span class="line"></span><br><span class="line">conn myvpn</span><br><span class="line">  keyexchange=ikev1</span><br><span class="line">  left=%defaultroute</span><br><span class="line">  auto=add</span><br><span class="line">  authby=secret</span><br><span class="line">  type=transport</span><br><span class="line">  leftprotoport=17/1701</span><br><span class="line">  rightprotoport=17/1701</span><br><span class="line">  right=$VPN_SERVER_IP</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/ipsec.secrets &lt;&lt;EOF</span><br><span class="line">: PSK &quot;$VPN_IPSEC_PSK&quot;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 600 /etc/ipsec.secrets</span><br><span class="line"></span><br><span class="line"># For CentOS/RHEL &amp; Fedora ONLY</span><br><span class="line">mv /etc/strongswan/ipsec.conf /etc/strongswan/ipsec.conf.old 2&gt;/dev/null</span><br><span class="line">mv /etc/strongswan/ipsec.secrets /etc/strongswan/ipsec.secrets.old 2&gt;/dev/null</span><br><span class="line">ln -s /etc/ipsec.conf /etc/strongswan/ipsec.conf</span><br><span class="line">ln -s /etc/ipsec.secrets /etc/strongswan/ipsec.secrets</span><br></pre></td></tr></table></figure>

<p>配置 xl2tpd：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/xl2tpd/xl2tpd.conf &lt;&lt;EOF</span><br><span class="line">[lac myvpn]</span><br><span class="line">lns = $VPN_SERVER_IP</span><br><span class="line">ppp debug = yes</span><br><span class="line">pppoptfile = /etc/ppp/options.l2tpd.client</span><br><span class="line">length bit = yes</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/ppp/options.l2tpd.client &lt;&lt;EOF</span><br><span class="line">ipcp-accept-local</span><br><span class="line">ipcp-accept-remote</span><br><span class="line">refuse-eap</span><br><span class="line">require-chap</span><br><span class="line">noccp</span><br><span class="line">noauth</span><br><span class="line">mtu 1280</span><br><span class="line">mru 1280</span><br><span class="line">noipdefault</span><br><span class="line">defaultroute</span><br><span class="line">usepeerdns</span><br><span class="line">connect-delay 5000</span><br><span class="line">name $VPN_USER</span><br><span class="line">password $VPN_PASSWORD</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod 600 /etc/ppp/options.l2tpd.client</span><br></pre></td></tr></table></figure>

<p>至此 VPN 客户端配置已完成。按照下面的步骤进行连接。</p>
<p>创建 xl2tpd 控制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/run/xl2tpd</span><br><span class="line">touch /var/run/xl2tpd/l2tp-control</span><br></pre></td></tr></table></figure>

<p>重启服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service strongswan restart</span><br><span class="line">service xl2tpd restart</span><br></pre></td></tr></table></figure>

<p>开始 IPsec 连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Ubuntu &amp; Debian</span><br><span class="line">ipsec up myvpn</span><br><span class="line"></span><br><span class="line"># CentOS/RHEL &amp; Fedora</span><br><span class="line">strongswan up myvpn</span><br></pre></td></tr></table></figure>

<p>开始 L2TP 连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;c myvpn&quot; &gt; /var/run/xl2tpd/l2tp-control</span><br></pre></td></tr></table></figure>

<p>运行 <code>ifconfig</code> 并且检查输出。现在你应该看到一个新的网络接口 <code>ppp0</code>。</p>
<p>检查你现有的默认路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip route</span><br></pre></td></tr></table></figure>

<p>在输出中查找以下行： <code>default via X.X.X.X ...</code>。记下这个网关 IP，并且在下面的两个命令中使用。</p>
<p>从新的默认路由中排除你的 VPN 服务器 IP （替换为你自己的值）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add YOUR_VPN_SERVER_IP gw X.X.X.X</span><br></pre></td></tr></table></figure>

<p>如果你的 VPN 客户端是一个远程服务器，则必须从新的默认路由中排除你本地电脑的公有 IP，以避免 SSH 会话被断开 （替换为你自己的公有 IP，可在 <a href="https://www.ipchicken.com" target="_blank" rel="noopener">这里</a>查看）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add YOUR_LOCAL_PC_PUBLIC_IP gw X.X.X.X</span><br></pre></td></tr></table></figure>

<p>添加一个新的默认路由，并且开始通过 VPN 服务器发送数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add default dev ppp0</span><br></pre></td></tr></table></figure>

<p>至此 VPN 连接已成功完成。检查 VPN 是否正常工作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -qO- http://ipv4.icanhazip.com; echo</span><br></pre></td></tr></table></figure>

<p>以上命令应该返回 <code>你的 VPN 服务器 IP</code>。</p>
<p>要停止通过 VPN 服务器发送数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route del default dev ppp0</span><br></pre></td></tr></table></figure>

<p>要断开连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Ubuntu &amp; Debian</span><br><span class="line">echo &quot;d myvpn&quot; &gt; /var/run/xl2tpd/l2tp-control</span><br><span class="line">ipsec down myvpn</span><br><span class="line"></span><br><span class="line"># CentOS/RHEL &amp; Fedora</span><br><span class="line">echo &quot;d myvpn&quot; &gt; /var/run/xl2tpd/l2tp-control</span><br><span class="line">strongswan down myvpn</span><br></pre></td></tr></table></figure>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://images.wodekouwei.com/Pay/weixin_qingkouwei.png" alt="轻口味 WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://images.wodekouwei.com/Pay/zhifubao_qingkouwei.jpg" alt="轻口味 Alipay">
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/tools/" rel="tag"># tools</a>
          
            <a href="/tags/Mac/" rel="tag"># Mac</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/10/env-mac-boost/" rel="next" title="macOS 中Boost的安装和使用">
                <i class="fa fa-chevron-left"></i> macOS 中Boost的安装和使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/11/env-vpn-introduce/" rel="prev" title="vpn(Virtual Private Network)虚拟专用网络介绍">
                vpn(Virtual Private Network)虚拟专用网络介绍 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg" alt="轻口味">
          <p class="site-author-name" itemprop="name">轻口味</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">190</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">63</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/qingkouwei" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/LightTaste" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/turnpp/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  豆瓣
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/shen-jun-wei-9/" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/ossrs/srs" title="SRS" target="_blank">SRS</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#l2tp-VPN搭建"><span class="nav-number">1.</span> <span class="nav-text">l2tp VPN搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#l2tp-server搭建"><span class="nav-number">1.1.</span> <span class="nav-text">l2tp server搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#写在前面"><span class="nav-number">1.1.1.</span> <span class="nav-text">写在前面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用方法"><span class="nav-number">1.1.2.</span> <span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#常见问题"><span class="nav-number">1.1.3.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#问题1"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">问题1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#问题2"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">问题2</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装完成后配置文件"><span class="nav-number">1.1.4.</span> <span class="nav-text">安装完成后配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#l2tp-etc-xl2tpd-xl2tpd-conf"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">l2tp/etc/xl2tpd/xl2tpd.conf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#l2tp-etc-xl2tpd-l2tp-secrets"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">l2tp/etc/xl2tpd/l2tp-secrets</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#l2tp-etc-ppp-options-xl2tpd"><span class="nav-number">1.1.4.3.</span> <span class="nav-text">l2tp/etc/ppp/options.xl2tpd</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ipsec-etc-ppp-chap-secrets"><span class="nav-number">1.1.4.4.</span> <span class="nav-text">ipsec/etc/ppp/chap-secrets</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ipsec-etc-ipsec-conf"><span class="nav-number">1.1.4.5.</span> <span class="nav-text">ipsec/etc/ipsec.conf</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ipsec-etc-ipsec-secrets"><span class="nav-number">1.1.4.6.</span> <span class="nav-text">ipsec/etc/ipsec.secrets</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#etc-init-d"><span class="nav-number">1.1.4.7.</span> <span class="nav-text">/etc/init.d</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#l2tp-sh脚本命令"><span class="nav-number">1.1.5.</span> <span class="nav-text">l2tp.sh脚本命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ipsec-amp-xl2tpd命令-用"><span class="nav-number">1.1.6.</span> <span class="nav-text">ipsec &amp; xl2tpd命令(用)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#排除故障"><span class="nav-number">1.1.7.</span> <span class="nav-text">排除故障</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#l2tp-客户端连接-主要是ubuntu"><span class="nav-number">1.2.</span> <span class="nav-text">l2tp 客户端连接(主要是ubuntu)</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">轻口味</span>
</div>

<div>
<a href="http://www.miitbeian.gov.cn/">京ICP备17018543号</a>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </div></footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "bb46b146831e4e34808d09cd94c85f50",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  
  


  

</body>
</html>
