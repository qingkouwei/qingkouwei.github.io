<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="老司机种菜" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="老司机种菜">
<meta property="og:url" content="http://wodekouwei.com/index.html">
<meta property="og:site_name" content="老司机种菜">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="老司机种菜">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wodekouwei.com/"/>





  <title> 老司机种菜 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2021aa5f03a4203621d42ef374e0d5f7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">老司机种菜</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/04/04/util-gerrit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/04/04/util-gerrit/" itemprop="url">
                  gerrit工具介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-04T10:56:50+08:00">
                2019-04-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Gerrit的gerrit query命令就是要查询Gerrit的changes数据库。</p>
<p>默认，查询结果是根据changes的更新时间，由近及远排序。</p>
<p>对于有多个patch set的change，默认查询结果只包含最后的patch set。</p>
<p>如果查询结果有很大，则默认只返回有限个查询结果，可以设置limit:参数指定查询结果包含的changes数量。</p>
<h3 id="1-gerrit-query命令用法："><a href="#1-gerrit-query命令用法：" class="headerlink" title="1. gerrit query命令用法："></a>1. gerrit query命令用法：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ssh -p &lt;port&gt; &lt;host&gt; gerrit query</div><div class="line">  [--format &#123;TEXT | JSON&#125;]</div><div class="line">  [--current-patch-set]</div><div class="line">  [--patch-sets | --all-approvals]</div><div class="line">  [--files]</div><div class="line">  [--comments]</div><div class="line">  [--commit-message]</div><div class="line">  [--dependencies]</div><div class="line">  [--submit-records]</div><div class="line">  [--all-reviewers]</div><div class="line">  [--start &lt;n&gt; | -S &lt;n&gt;]</div><div class="line">  &lt;query&gt;</div><div class="line">  [limit:&lt;n&gt;]</div></pre></td></tr></table></figure>
<p>常见选项说明：</p>
<ul>
<li>–format=TEXT，默认</li>
<li>–format=JSON</li>
<li>–current-patch-set，给出当前patch set的信息</li>
<li>–patch-sets，给出所有patch set的信息</li>
<li>–commit-message，给出change的完整commit message</li>
<li>–all-reviewers，给出所有reviewer的name和email
<code>&lt;query&gt;</code>说明：</li>
<li>status:open等价于status:pending, is:open, is:pending</li>
<li>owner:self等价于is:owner</li>
<li>reviewer:self等价于is:reviewer</li>
<li>project:bbauto/bba或p:bbauto/bba</li>
<li>projects:bb</li>
<li>branch:develop或branch:refs/heads/develop</li>
<li>change:2311176或change:I03369813660369e983b56dcabe4cb48839be4de0</li>
<li>commit:4e8ea8d43ab22273e4949348e1e7316f88cd54e3</li>
<li>ref:refs/changes/76/2311176/1</li>
<li>message:my_commit_message</li>
<li>is:visible</li>
<li>label:Code-Review=2或label:Code-Review=+2或label:Code-Review+2</li>
<li>label:Verified+1
补充：</li>
<li>属性值除了bare words (数字、大小写字母和@-_.)之外，必须使用””或{}包含</li>
<li>多个属性之间默认为and关系，还有or关系，或者取反not/-</li>
</ul>
<p>查询Gerrit指定状态的patch set,并保存到文件。采用分段查看首先查看最近500条的，再查看最近500-1000条的。</p>
<p><code>alias gerrit=&quot;ssh -p 29418 gerrit.yourdomain.com gerrit&quot;</code>
<code>gerrit review &lt;id&gt; --abandon</code> 放弃某个commit(id是commit id不是change id)</p>
<p><code>ssh -p 29418 192.168.1.127 gerrit review --submit a6b548272aa754857b4</code> 提交某个commit
循环放弃脚本:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">alias gerrit=&quot;ssh -p 29418 gerrit.lianjia.com gerrit&quot; </div><div class="line"></div><div class="line">for c in $(gerrit query project:mars --start 500 --current-patch-set| grep &quot;revision&quot;);do</div><div class="line">    if [ $c != &apos;revision:&apos; ];then</div><div class="line">        gerrit review $c --abandon;</div><div class="line">        echo $c</div><div class="line">    fi</div><div class="line">done</div></pre></td></tr></table></figure></p>
<h3 id="2-参考文献："><a href="#2-参考文献：" class="headerlink" title="2.参考文献："></a>2.参考文献：</h3><p><a href="https://gerrit-documentation.storage.googleapis.com/Documentation/2.13.7/cmd-query.html" target="_blank" rel="external">https://gerrit-documentation.storage.googleapis.com/Documentation/2.13.7/cmd-query.html</a>
<a href="https://gerrit-documentation.storage.googleapis.com/Documentation/2.13.7/json.html" target="_blank" rel="external">https://gerrit-documentation.storage.googleapis.com/Documentation/2.13.7/json.html</a>
<a href="https://gerrit-documentation.storage.googleapis.com/Documentation/2.13.7/user-search.html" target="_blank" rel="external">https://gerrit-documentation.storage.googleapis.com/Documentation/2.13.7/user-search.html</a></p>
<h3 id="3-gerrit-不经代码审核直接push进库的方法"><a href="#3-gerrit-不经代码审核直接push进库的方法" class="headerlink" title="3.gerrit 不经代码审核直接push进库的方法"></a>3.gerrit 不经代码审核直接push进库的方法</h3><h4 id="需求"><a href="#需求" class="headerlink" title="需求:"></a>需求:</h4><p>gerrit 代码审核将代码入库权限收起,可以有效控制代码质量.</p>
<p>但同时弊端也是明显的: 对于频繁改动的项目(比如新项目),每段代码都审核会明显拖慢工作效率.</p>
<p>这时可以给某个组配置不经审核直接push权限.</p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法:"></a>方法:</h4><p>管理员账号,到 projects -&gt; access 页面下配置 reference 权限.
其他 reference 的权限配置依旧, 给如下 reference 增加权限:
refs/for/refs/heads/master
配置 submit 权限给某个具体的组即可.</p>
<p>该组用户需要忽略审核时,执行如下命令:
git push origin HEAD:refs/for/master%submit
就是在原有 push 命令基础上加上 %submit 这个后缀即可.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/27/tips-android-sqlite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/27/tips-android-sqlite/" itemprop="url">
                  tips-android-sqlite
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-27T09:57:57+08:00">
                2019-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">08-30 20:27:36.751 E/CursorWindow(  760): Could not allocate CursorWindow &apos;/data/data/com.android.providers.media/databases/external.db&apos; of size 2097152 due to error -12.</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760): *** Uncaught remote exception!  (Exceptions are not yet supported across processes.)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760): android.database.CursorWindowAllocationException: Cursor window allocation of 2048 kb failed. # Open Cursors=781 (# cursors opened by pid 3105=781)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at android.database.CursorWindow.&lt;init&gt;(CursorWindow.java:104)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at android.database.AbstractWindowedCursor.clearOrCreateWindow(AbstractWindowedCursor.java:198)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at android.database.sqlite.SQLiteCursor.fillWindow(SQLiteCursor.java:162)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at android.database.sqlite.SQLiteCursor.getCount(SQLiteCursor.java:156)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at android.database.CursorToBulkCursorAdaptor.count(CursorToBulkCursorAdaptor.java:184)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at android.content.ContentProviderNative.onTransact(ContentProviderNative.java:117)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at android.os.Binder.execTransact(Binder.java:338)</div><div class="line">08-30 20:27:36.771 E/JavaBinder(  760):  at dalvik.system.NativeStart.run(Native Method)</div></pre></td></tr></table></figure>
<p>错误原因
CursorWindow缓存数据达到最大限制（2Ｍ不同的机器和SQLite版本其值可能不同）后，仍有查询结果集需要缓存，在申请内存分配时申请失败发生了OOM内存溢出；SQLite查询出的数据集cursor，都由native层的CursorWindow进行数据管理，包括内存空间的申请和数据的填充。CursorWindow实际上是共享内存的抽象，以实现跨进程，跨应用数据共享（ContentProvider作为数据通道，也支持跨进程，跨应用的数据访问）
在ContentProvider端透过SQLiteDatabase的封装查询到的数据集保存在CursorWindow所指向的共享内存中，然后通过Binder把这片共享内存传递到ContentResolver端，即查询端。这样客户就可以通过Cursor来访问这块共享内存中的数据集了。
解决办法
保证CursorWindow不会达到最大限制）：</p>
<ol>
<li>只查询需要的字段；根据UI显示需要，或实际需要查询的字段进行查询，尽量不会表查询</li>
<li>二进制文件不要存在数据库中；数据库仅适用于保存一些较短文字，整数，布尔，浮点数等一些，易于查询和操作的轻量级的数据，目的也是在于快速搜索和查询。对于像图片，较长的文字（如文章）等大数据，最好直接以文件形式存储在硬盘中，然后在数据库保存它们的访问路径</li>
<li>对于大数据量的查询采用分段查询方式；无论表中的一条记录数据量如何的小，当条数达到5000级或者万级或者更多的时候，还是会达到最大的限制</li>
<li>正确的关闭Cursor，释放CursorWindow中不用的资源（需手动调用释放native中的资源，类似3.0之前的Bitmap需要手动释放。调用close的必要性：</li>
</ol>
<p><a href="https://blog.csdn.net/u011453773/article/details/50731250" target="_blank" rel="external">从源码看ANDROID中SQLITE是怎么通过CURSORWINDOW读DB的</a></p>
<h3 id="Sqlite性能优化"><a href="#Sqlite性能优化" class="headerlink" title="Sqlite性能优化"></a>Sqlite性能优化</h3><p>(1)编译SQL语句
Sqlite想要执行操作，需要将程序中的sql语句编译成对应的SQLiteStatement,比如select * from record这一句，被执行100次就需要编译100次。对于批量处理插入或者更新的操作，我们可以使用显示编译来做到重用SQLiteStatement。</p>
<p>想要做到重用SQLiteStatement也比较简单，基本如下：</p>
<p>编译sql语句获得SQLiteStatement对象，参数使用?代替 
在循环中对SQLiteStatement对象进行具体数据绑定，bind方法中的index从1开始，不是0</p>
<p>如下向person表中插入100条数据：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public void insertBatchPreCompile() &#123;</div><div class="line">        long start = SystemClock.currentThreadTimeMillis();</div><div class="line">        String sql = &quot;insert into &quot; + TAB_PERSON + &quot; values (?,&apos;test&apos;,&apos;1&apos;);&quot;;</div><div class="line">        SQLiteStatement sqLiteStatement = getReadableDatabase().compileStatement(sql);</div><div class="line">        int count = 0;</div><div class="line">        while (count &lt; 100) &#123;</div><div class="line">            count++;</div><div class="line">            sqLiteStatement.clearBindings();</div><div class="line">            sqLiteStatement.bindLong(1, count);</div><div class="line">            sqLiteStatement.executeInsert();</div><div class="line">        &#125;</div><div class="line">        Log.e(TAG, &quot;insert recompile use time &quot; + (SystemClock.currentThreadTimeMillis() - start));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>（2）显示使用事务
在Android中，无论是使用SQLiteDatabase的insert,delete等方法还是execSQL都开启了事务，来确保每一次操作都具有原子性，使得结果要么是操作之后的正确结果，要么是操作之前的结果。</p>
<p>然而事务的实现是依赖于名为rollback journal文件，借助这个临时文件来完成原子操作和回滚功能。既然属于文件，就符合Unix的文件范型(Open-Read/Write- Close)，因而对于批量的修改操作会出现反复打开文件读写再关闭的操作。然而好在，我们可以显式使用事务，将批量的数据库更新带来的journal文件打开关闭降低到1次。</p>
<p>具体的实现代码如下：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public void insertWithTransaction() &#123;</div><div class="line">        long start = SystemClock.currentThreadTimeMillis();</div><div class="line">        int count = 0;</div><div class="line">        try &#123;</div><div class="line">            getWritableDatabase().beginTransaction();</div><div class="line">            while (count++ &lt; 100) &#123;</div><div class="line">                insert(count, &quot;test&quot;, 1);</div><div class="line">            &#125;</div><div class="line">            getWritableDatabase().setTransactionSuccessful();</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; finally &#123;</div><div class="line">            getWritableDatabase().endTransaction();</div><div class="line">        &#125;</div><div class="line">        Log.e(TAG, &quot;insert traceaction use time &quot; + (SystemClock.currentThreadTimeMillis() - start));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>使用这两种方式分别优化，对比效果如下： </p>
<p>从图中可以看到在插入100条的情况下，使用预编译的方式可以稍微提升性能，但是使用事务，能够使性能提升大概8倍，所以可以看出频繁的IO操作还是比较耗时的。同时使用两种方式进行优化，可以提升17倍，优化效果非常明显。</p>
<p>（3）建立索引
a.索引的概念
索引，使用索引可快速访问数据库表中的特定信息。索引是对数据库表中一列或多列的值进行排序的一种结构。</p>
<p>在关系数据库中，索引是一种与表有关的数据库结构，它可以使对应于表的SQL语句执行得更快。索引的作用相当于图书的目录，可以根据目录中的页码快速找到所需的内容。当表中有大量记录时，若要对表进行查询，第一种搜索信息方式是全表搜索，是将所有记录一一取出，和查询条件进行一一对比，然后返回满足条件的记录，这样做会消耗大量数据库系统时间，并造成大量磁盘I/O操作；第二种就是在表中建立索引，然后在索引中找到符合查询条件的索引值，最后通过保存在索引中的ROWID（相当于页码）快速找到表中对应的记录。 
索引是一个单独的、物理的数据库结构，它是某个表中一列或若干列值的集合和相应的指向表中物理标识这些值的数据页的逻辑指针清单。</p>
<p>索引提供指向存储在表的指定列中的数据值的指针，然后根据您指定的排序顺序对这些指针排序。数据库使用索引的方式与您使用书籍中的索引的方式很相似：它搜索索引以找到特定值，然后顺指针找到包含该值的行。</p>
<p>b.建立索引
创建索引的基本语法：</p>
<p>CREATE INDEX index_name ON table_name;
1
创建单列索引</p>
<p>CREATE INDEX index_name ON table_name;
1
c.索引的利弊
毋庸置疑，索引加速了我们检索数据表的速度。然而正如西方谚语 “There are two sides of a coin”，索引亦有缺点：</p>
<p>对于增加，更新和删除来说，使用了索引会变慢，比如你想要删除字</p>
<p>列表内容典中的一个字，那么你同时也需要删除这个字在拼音索引和部首索引中的信息。
建立索引会增加数据库的大小，比如字典中的拼音索引和部首索引实际上是会增加字典的页数，让字典变厚的。
为数据量比较小的表建立索引，往往会事倍功半。
所以使用索引需要考虑实际情况进行利弊权衡，对于查询操作量级较大，业务对要求查询要求较高的，还是推荐使用索引的。</p>
<p>（4）查询数据优化
按需获取列信息</p>
<p>db.query(TableDefine.TABLE_RECORD, null, null, null, null, null, null) ;
1
其中上面方法的第二个参数类型为String[]，意思是返回结果参考的colum信息，传递null表明需要获取全部的column数据。如果我们不需要所有列的信息，最好指定一下需要的列。</p>
<p>提前获取索引 
例如下面的代码，我们可以把获取列索引的代码cursor.getColumnIndex(TableDefine.COLUMN_INSERT_TIME)放到循环外，这样不需要每次获取。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> private void badQueryWithLoop(SQLiteDatabase db) &#123;</div><div class="line">    Cursor cursor = db.query(TableDefine.TABLE_RECORD, new String[]&#123;TableDefine.COLUMN_INSERT_TIME&#125;, null, null, null, null, null) ;</div><div class="line">    while (cursor.moveToNext()) &#123;</div><div class="line">        long insertTime = cursor.getLong(cursor.getColumnIndex(TableDefine.COLUMN_INSERT_TIME));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>（5）ContentValues的容量调整
SQLiteDatabase提供了方便的ContentValues简化了我们处理列名与值的映射，ContentValues内部采用了 HashMap来存储Key-Value数据，ContentValues的初始容量是8，如果当添加的数据超过8之前，则会进行双倍扩容操作，因此建议对ContentValues填入的内容进行估量，设置合理的初始化容量，减少不必要的内部扩容操作。</p>
<p>（6）及时关闭Cursor
（7）耗时异步化
数据库的操作，属于本地IO，通常比较耗时，如果处理不好，很容易导致ANR,因此建议将这些耗时操作放入异步线程中处理</p>
<p><a href="https://blog.csdn.net/u014608640/article/details/52511310" target="_blank" rel="external">Android 性能优化之数据库优化(一)</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/27/tips-android-file/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/27/tips-android-file/" itemprop="url">
                  tips-android-file
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-27T09:51:43+08:00">
                2019-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>文件句柄泄露
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">10-27 00:35:32.141  7437  7437 E AndroidRuntime: FATAL EXCEPTION: main</div><div class="line"></div><div class="line">10-27 00:35:32.141  7437  7437 E AndroidRuntime: Process: com.Android56, PID: 7437</div><div class="line"></div><div class="line">10-27 00:35:32.141  7437  7437 E AndroidRuntime: java.lang.RuntimeException: Could not read input channel file descriptors from parcel.</div><div class="line"></div><div class="line">10-27 00:35:32.141  7437  7437 E AndroidRuntime:    at android.view.InputChannel.nativeReadFromParcel(Native Method)</div><div class="line"></div><div class="line">10-27 00:35:32.141  7437  7437 E AndroidRuntime:    at android.view.InputChannel.readFromParcel(InputChannel.java:148)</div><div class="line"></div><div class="line">10-27 00:35:32.141  7437  7437 E AndroidRuntime:    at android.view.InputChannel$1.createFromParcel(InputChannel.java:39)</div></pre></td></tr></table></figure></p>
<p>这里有一句Could not read input channel file descriptors from parcel，然后我们在这句话的上面又发现一个有价值的信息。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Caused by: java.io.IOException: Too many open files</div></pre></td></tr></table></figure></p>
<p>通过网上搜索，基本判断这是一个文件句柄泄漏的问题。
那么我们该如何查找文件句柄泄漏的地方呢。
首先我们需要做到监控文件句柄数，由于android是linux的内核，所以，系统为每一个进程都有一个文件句柄的目录。
我们先通过ps命令，获取到我们app的进程id。
然后找到一个root过的手机，或者使用andorid模拟器，然后用adb连接到手机，通过shell命令进入到/proc/进程id/fd这个目录。由于linux关于系统的管理都是用文件方式，所以这个文件夹下面就是所有被打开的句柄。
我们可以在app运行的过程中，不断的进入到这个目录中，然后用ls -l 命令列出所有的文件句柄，这样就能看到文件句柄有哪些是增长的。然后再根据不同类型的文件句柄，初步定位是什么在泄漏。
在排查的过程中，为了方便获取某个进程的句柄数，我写了一个简单的shell脚本。有需要的同学可以拿去使用。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">echo &apos;查询进程占用文件句柄数&apos;</div><div class="line">set `adb shell ps |grep com.Android56 |grep -v channel |grep -v Daemon`</div><div class="line">pidnum=$2</div><div class="line">index=0</div><div class="line">while true</div><div class="line">do</div><div class="line">index=$[index+1]</div><div class="line">echo &apos;##################&apos;</div><div class="line">echo &apos;第&apos;$index&apos;次查询&apos;</div><div class="line">echo &apos;总句柄&apos;</div><div class="line">adb shell ls -l /proc/$pidnum/fd |grep &quot;&quot; -c</div><div class="line">echo &apos;anon句柄&apos;</div><div class="line">adb shell ls -l /proc/$pidnum/fd |grep anon -c</div><div class="line">echo &apos;##################&apos;</div><div class="line">sleep 2</div><div class="line">done</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/26/tool-markdown/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/26/tool-markdown/" itemprop="url">
                  markdown语法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-26T22:00:20+08:00">
                2019-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Markdown Preview Enhanced 内部支持 mermaid, PlantUML, WaveDrom, GraphViz，Vega &amp; Vega-lite，Ditaa 图像渲染。 
你也可以通过使用 Code Chunk 来渲染 TikZ, Python Matplotlib, Plotly 等图像。</p>
<h3 id="基本流程图"><a href="#基本流程图" class="headerlink" title="基本流程图"></a>基本流程图</h3><p>Markdown常用的元素有以下几种：</p>
<ul>
<li>start</li>
<li>end</li>
<li>operation</li>
<li>condition</li>
<li>inputoutput</li>
<li>subroutine</li>
</ul>
<p>以简单的登录场景为例，流程图代码</p>
<div id="flowchart-0" class="flow-chart"></div>

<p>注意：冒号和名称之间需要有一个空格。</p>
<p>方向调整
绘制流程图有时会出现比较一言难尽的情况</p>
<div id="flowchart-1" class="flow-chart"></div>
这种情况下可以使用left、right和bottom关键字来调整线条的位置使流程图更加清晰，例如此处给operation4元素添加right关键字，就可以分离重叠的线条。
<div id="flowchart-2" class="flow-chart"></div>
如果给condition元素添加这些关键字的话会调整整个分支的方向：
<div id="flowchart-3" class="flow-chart"></div>

<p>状态标记
Markdown会使用不同的颜色来标记状态，状态主要有以下几种：</p>
<ul>
<li>past</li>
<li>current</li>
<li>future</li>
<li>approved</li>
<li>rejected</li>
<li>invalid</li>
</ul>
<p>以软件生命周期的一部分为例：</p>
<div id="flowchart-4" class="flow-chart"></div>
箭头高亮
可以通过高亮某些箭头来标记出主流程：
<div id="flowchart-5" class="flow-chart"></div>

<p>流程图语法详解
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">## 操作块(格式为:变量=&gt;操作块: 备注名)</div><div class="line">st=&gt; start: 开始</div><div class="line">e=&gt;end: 结束</div><div class="line">#普通操作块 opration</div><div class="line">op1=&gt;opration: 第一个操作块</div><div class="line">op2=&gt;opration: 第二个操作块</div><div class="line">#判断块 condition</div><div class="line">cond1=&gt;condition: 第一个判断</div><div class="line">cond2=&gt;condition: 第二个判断</div><div class="line">  </div><div class="line">#输入输出块 inputoutput[平行四边形]</div><div class="line">io1=&gt;inputoutput: 输入输出块1</div><div class="line">io2=&gt;inputoutput: 输入输出块2</div><div class="line">#子任务块</div><div class="line">sub1=&gt;subroutine: 子任务1</div><div class="line">sub2=&gt;subroutine: 子任务2</div><div class="line">  </div><div class="line">## 判断和位置控制</div><div class="line">#判断流程控制</div><div class="line">cond1(yes)-&gt;op1  #yes 的时候回到 op1</div><div class="line">cond1(no)-&gt;e   #no 的时候 去结束</div><div class="line">  </div><div class="line">#位置指定</div><div class="line">cond1(no)-&gt;op2(right)-&gt;op1 #控制 op2 位置置于右边，再由op2 返回 op1 (好像不能向左)</div><div class="line">#还可以这样 cond1(no,right)</div><div class="line">cond1(yes)-&gt;e </div><div class="line">  </div><div class="line">## 流程控制</div><div class="line">#分着写</div><div class="line">st-&gt;op1</div><div class="line">op1-&gt;e</div><div class="line">  </div><div class="line">#合着写</div><div class="line">st-&gt;op1-&gt;e</div><div class="line">  </div><div class="line">#判断也是一样：</div><div class="line">st-&gt;cond</div><div class="line">cond(yes)-&gt;io</div><div class="line">cond(no)-&gt;op1</div></pre></td></tr></table></figure></p>
<h3 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h3><p>注意:其实时序图使用platuml也可以画的很美观
<a href="http://plantuml.com/zh/sequence-diagram" target="_blank" rel="external">platuml-sequence</a></p>
<ul>
<li>sequence代码块中的内容将会被js-sequence-diagrams渲染</li>
<li>支持两个主题simple(default)和hand</li>
</ul>
<div id="sequence-0"></div>

<h3 id="Mermaid"><a href="#Mermaid" class="headerlink" title="Mermaid"></a>Mermaid</h3><p>Mermaid可以用来渲染流程图和时序图</p>
<ul>
<li>mermaid代码块中的内容将会被渲染mermaid图像</li>
<li><a href="https://mermaidjs.github.io/" target="_blank" rel="external">mermaid-docs图像文档</a></li>
</ul>
<p>注意:{code_block=true}会影藏图像
Mermaid 是一个用于画流程图、状态图、时序图、甘特图的库，使用 JS 进行本地渲染，广泛集成于许多 Markdown 编辑器中。</p>
<p>定义节点
|表述|说明|
|—|—|
|id[文字]|    矩形节点|
|id(文字)|    圆角矩形节点|
|id((文字))    |圆形节点|
|id&gt;文字]|    旗帜状节点|
|id{文字}|    菱形节点|
定义连线
|表述|    说明|
|—|—|
|&gt;|    添加尾部箭头|
|-|    不添加尾部箭头|
|–    |单线|
|–text–|    单线上加文字|
|==|    粗线|
|==text==|    粗线加文字|
|-.-|    虚线|
|-.text.-|    虚线加文字|</p>
<p>流程图方向有下面几个值</p>
<ul>
<li>TB 从上到下</li>
<li>BT 从下到上</li>
<li>RL 从右到左</li>
<li>LR 从左到右</li>
<li>TD 同TB</li>
</ul>
<p>子流程图
格式
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">subgraph title</div><div class="line">    graph definition</div><div class="line">end</div></pre></td></tr></table></figure></p>
<p>示例:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">graph TB</div><div class="line">    c1--&gt;a2</div><div class="line">    subgraph one</div><div class="line">    a1--&gt;a2</div><div class="line">    end</div><div class="line">    subgraph two</div><div class="line">    b1--&gt;b2</div><div class="line">    end</div><div class="line">    subgraph three</div><div class="line">    c1--&gt;c2</div><div class="line">    end</div></pre></td></tr></table></figure></p>
<p>自定义样式</p>
<p>语法：style id 具体样式
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">graph LR</div><div class="line">    id1(Start)--&gt;id2(Stop)</div><div class="line">    style id1 fill:#f9f,stroke:#333,stroke-width:4px,fill-opacity:0.5</div><div class="line">    style id2 fill:#ccf,stroke:#f66,stroke-width:2px,stroke-dasharray: 10,5</div></pre></td></tr></table></figure></p>
<h3 id="plantuml创建各种图形"><a href="#plantuml创建各种图形" class="headerlink" title="plantuml创建各种图形"></a>plantuml创建各种图形</h3><ul>
<li>可以安装graphviz来辅助生成各种图形</li>
<li>puml或plantuml代码中的内容将会被PlantUML渲染
注意：也可以为图像的容器添加属性，例如居中{align=”center”}</li>
</ul>
<h3 id="使用graphviz来绘制各种图形"><a href="#使用graphviz来绘制各种图形" class="headerlink" title="使用graphviz来绘制各种图形"></a>使用graphviz来绘制各种图形</h3><p>使用Viz.js来渲染dot语言图形。</p>
<ul>
<li>viz或者dot代码块中的内容将会被<a href="https://github.com/mdaines/viz.js" target="_blank" rel="external">Viz.js</a>渲染</li>
<li>可以通过{engine=”…”}来选择不同的渲染引擎。引擎circo,dot,neato,osage,或者twopi.</li>
</ul>
<p>注意:默认的dot是二叉树，twopi是依赖树，两种常用的类型</p>
<h3 id="vega和vega-lite的支持的静态图像"><a href="#vega和vega-lite的支持的静态图像" class="headerlink" title="vega和vega-lite的支持的静态图像"></a>vega和vega-lite的支持的静态图像</h3><ul>
<li>vega代码块中的内容会被vega渲染</li>
<li>vega-lite代码中的内容会被vega-lite渲染</li>
<li>支持JSON和YAML的数据源输入
<a href="https://vega.github.io/vega-lite/examples/" target="_blank" rel="external">vega-lite-docs</a>
<a href="https://www.jianshu.com/p/a9bd83b768d5" target="_blank" rel="external">vega-docs</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;$schema&quot;: &quot;https://vega.github.io/schema/vega-lite/v2.json&quot;,</div><div class="line">  &quot;description&quot;: &quot;A simple bar chart with embedded data.&quot;,</div><div class="line">  &quot;data&quot;: &#123;</div><div class="line">    &quot;values&quot;: [</div><div class="line">      &#123;&quot;a&quot;: &quot;A&quot;,&quot;b&quot;: 28&#125;, &#123;&quot;a&quot;: &quot;B&quot;,&quot;b&quot;: 55&#125;, &#123;&quot;a&quot;: &quot;C&quot;,&quot;b&quot;: 43&#125;,</div><div class="line">      &#123;&quot;a&quot;: &quot;D&quot;,&quot;b&quot;: 91&#125;, &#123;&quot;a&quot;: &quot;E&quot;,&quot;b&quot;: 81&#125;, &#123;&quot;a&quot;: &quot;F&quot;,&quot;b&quot;: 53&#125;,</div><div class="line">      &#123;&quot;a&quot;: &quot;G&quot;,&quot;b&quot;: 19&#125;, &#123;&quot;a&quot;: &quot;H&quot;,&quot;b&quot;: 87&#125;, &#123;&quot;a&quot;: &quot;I&quot;,&quot;b&quot;: 52&#125;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;mark&quot;: &quot;bar&quot;,</div><div class="line">  &quot;encoding&quot;: &#123;</div><div class="line">    &quot;x&quot;: &#123;&quot;field&quot;: &quot;a&quot;, &quot;type&quot;: &quot;ordinal&quot;&#125;,</div><div class="line">    &quot;y&quot;: &#123;&quot;field&quot;: &quot;b&quot;, &quot;type&quot;: &quot;quantitative&quot;&#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><a href="https://shd101wyy.github.io/markdown-preview-enhanced/#/zh-cn/diagrams" target="_blank" rel="external">https://shd101wyy.github.io/markdown-preview-enhanced/#/zh-cn/diagrams</a></p>
<h3 id="hexo中支持流程图"><a href="#hexo中支持流程图" class="headerlink" title="hexo中支持流程图"></a>hexo中支持流程图</h3><ol>
<li>hexo-filter-mermaid-diagrams:
brew install yarn
进入到博客的根目录，一定要在博客的根目录执行<code>yarn add hexo-filter-mermaid-diagrams</code>
执行完成后在博客根目录下的node_modules种看下有没有hexo-filter-mermaid-diagrams这个插件文件夹，如果没有，说明没安装成功，安装成功后执行下一步，打开博客根目录下面的_config.yml文件，在底部插入以下代码：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># mermaid chart</div><div class="line">mermaid: ## mermaid url https://github.com/knsv/mermaid</div><div class="line">  enable: true  # default true</div><div class="line">  version: &quot;7.1.2&quot; # default v7.1.2</div><div class="line">  options:  # find more api options from https://github.com/knsv/mermaid/blob/master/src/mermaidAPI.js</div><div class="line">    #startOnload: true  // default true</div></pre></td></tr></table></figure>
</li>
</ol>
<p>完成上一步操作之后打开主题目录的themes/next/layout/_partials/footer.swig，这里因为我用的是next主题，其他主题应该大同小异，在footer.swig文件最后加上以下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;% if theme.mermaid.enable %&#125;</div><div class="line">  &lt;script src=&apos;https://unpkg.com/mermaid@&#123;&#123; theme.mermaid.version &#125;&#125;/dist/mermaid.min.js&apos;&gt;&lt;/script&gt;</div><div class="line">  &lt;script&gt;</div><div class="line">    if (window.mermaid) &#123;</div><div class="line">      mermaid.initialize(&#123;theme: &apos;forest&apos;&#125;);</div><div class="line">    &#125;</div><div class="line">  &lt;/script&gt;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>添加完成后，回到博客根目录的_config.yml，把external_link的值改为false，默认的为true，这一步绝大多数教程中都没有写
Hexo中引入Mermaid流程图：<a href="https://tyloafer.github.io/2018/04/21/hexo-mermaid/" target="_blank" rel="external">点击查看</a>
hexo-filter-mermaid-diagrams插件开发杂谈:<a href="https://webappdevelp.github.io/2018/0%E4%B8%89/hexo-filter-mermaid-diagrams%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%E6%9D%82%E8%B0%88/" target="_blank" rel="external">点击查看</a>
插件官方位置:<a href="https://www.npmjs.com/package/hexo-filter-mermaid-diagrams" target="_blank" rel="external">点击查看</a>
插件官方使用教程:<a href="https://mermaidjs.github.io/flowchart.html" target="_blank" rel="external">点击查看</a></p>
<ol>
<li>hexo-filter-flowchart
npm install –save hexo-filter-flowchart</li>
<li>hexo-filter-sequence
npm install –save hexo-filter-sequence
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">start=>start: 开始
loginInfo=>inputoutput: 登录数据
verifyLogin=>subroutine: 登录验证
isSuccess=>condition: 验证成功？
respondSuccess=>operation: 响应成功
responseFailure=>operation: 响应失败
end=>end: 结束

start->loginInfo->verifyLogin->isSuccess
isSuccess(yes)->respondSuccess->end
isSuccess(no)->responseFailure->end</textarea><textarea id="flowchart-0-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script><textarea id="flowchart-1-code" style="display: none">start=>start: start
operation1=>operation: operation1
isSuccess=>condition: success?
operation2=>operation: operation2
operation3=>operation: operation3
operation4=>operation: operation4
end=>end: 结束

start->operation1->isSuccess
isSuccess(yes)->operation2->end
isSuccess(no)->operation3->operation4->operation1</textarea><textarea id="flowchart-1-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-1-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-1-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-1", options);</script><textarea id="flowchart-2-code" style="display: none">start=>start: start
operation1=>operation: operation1
isSuccess=>condition: success?
operation2=>operation: operation2
operation3=>operation: operation3
operation4=>operation: operation4
end=>end: 结束

start->operation1->isSuccess
isSuccess(yes)->operation2->end
isSuccess(no)->operation3->operation4(right)->operation1</textarea><textarea id="flowchart-2-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-2-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-2-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-2", options);</script><textarea id="flowchart-3-code" style="display: none">start=>start: start
operation1=>operation: operation1
isSuccess=>condition: success?
operation2=>operation: operation2
operation3=>operation: operation3
operation4=>operation: operation4
end=>end: 结束

start->operation1->isSuccess
isSuccess(yes)->operation2->end
isSuccess(no,left)->operation3->operation4(left)->operation1</textarea><textarea id="flowchart-3-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-3-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-3-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-3", options);</script><textarea id="flowchart-4-code" style="display: none">start=>start: 开始|past
requirementAnalysis=>operation: 需求分析|past
design=>operation: 软件设计|past
coding=>operation: 编码|past
selfTestingPased=>condition: 自测通过？|approved
debug=>operation: debug|invalid
submitTestingPased=>condition: 提测通过？|rejected
modifyBug=>operation: 修bug|current
deploy=>operation: 部署|future
end=>end: 结束|future

start->requirementAnalysis->design->coding->selfTestingPased
selfTestingPased(no)->debug(right)->selfTestingPased
selfTestingPased(yes)->submitTestingPased
submitTestingPased(yes)->deploy->end
submitTestingPased(no)->modifyBug(right)->submitTestingPased</textarea><textarea id="flowchart-4-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-4-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-4-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-4", options);</script><textarea id="flowchart-5-code" style="display: none">start=>start: 开始
loginInfo=>inputoutput: 登录数据
verifyLogin=>subroutine: 登录验证
isSuccess=>condition: 验证成功？
respondSuccess=>operation: 响应成功
responseFailure=>operation: 响应失败
end=>end: 结束

start->loginInfo->verifyLogin->isSuccess
isSuccess(yes)->respondSuccess->end
isSuccess(no)->responseFailure->end

start@>loginInfo({"stroke":"Red"})@>verifyLogin({"stroke":"Red"})@>isSuccess({"stroke":"Red"})@>respondSuccess({"stroke":"Red"})@>end({"stroke":"Red","stroke-width":6,"arrow-end":"classic-wide-long"})</textarea><textarea id="flowchart-5-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-5-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-5-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-5", options);</script><script src="https://cdnjs.cloudflare.com/ajax/libs/webfont/1.6.27/webfontloader.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js"></script><textarea id="sequence-0-code" style="display: none">bgbiao-> bianbian: good morning
note left of bgbiao: man
bianbian -> bgbiao: eat something
note right of bianbian: woman
  
note over bgbiao: test</textarea><textarea id="sequence-0-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("sequence-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("sequence-0-options").value));  var diagram = Diagram.parse(code);  diagram.drawSVG("sequence-0", options);</script></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/13/tips-net-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/13/tips-net-socket/" itemprop="url">
                  tips-net-socket
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-13T20:05:55+08:00">
                2019-03-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div></pre></td><td class="code"><pre><div class="line">FCNTL(2)                    BSD System Calls Manual                   FCNTL(2)</div><div class="line"></div><div class="line">NAME</div><div class="line">     fcntl -- file control</div><div class="line"></div><div class="line">SYNOPSIS</div><div class="line">     #include &lt;fcntl.h&gt;</div><div class="line"></div><div class="line">     int</div><div class="line">     fcntl(int fildes, int cmd, ...);</div><div class="line"></div><div class="line">DESCRIPTION</div><div class="line">     fcntl() provides for control over descriptors.  The argument fildes is a descriptor to be operated on</div><div class="line">     by cmd as follows:</div><div class="line"></div><div class="line">     F_DUPFD            Return a new descriptor as follows:</div><div class="line"></div><div class="line">                            o   Lowest numbered available descriptor greater than or equal to arg.</div><div class="line">                            o   Same object references as the original descriptor.</div><div class="line">                            o   New descriptor shares the same file offset if the object was a file.</div><div class="line">                            o   Same access mode (read, write or read/write).</div><div class="line">                            o   Same file status flags (i.e., both file descriptors share the same file</div><div class="line">                                status flags).</div><div class="line">                            o   The close-on-exec flag associated with the new file descriptor is cleared</div><div class="line">                                so that the descriptor remains open across an execv(2) system call.</div><div class="line"></div><div class="line">     F_DUPFD_CLOEXEC    Like F_DUPFD, except that the close-on-exec flag associated with the new file</div><div class="line">                        descriptor is set.</div><div class="line"></div><div class="line">     F_GETFD            Get the flags associated with the file descriptor fildes, as described below (arg</div><div class="line">                        is ignored).</div><div class="line"></div><div class="line">     F_SETFD            Set the file descriptor flags to arg.</div><div class="line"></div><div class="line">     F_GETFL            Get descriptor status flags, as described below (arg is ignored).</div><div class="line"></div><div class="line">     F_SETFL            Set descriptor status flags to arg.</div><div class="line"></div><div class="line">     F_GETOWN           Get the process ID or process group currently receiving SIGIO and SIGURG signals;</div><div class="line">                        process groups are returned as negative values (arg is ignored).</div><div class="line"></div><div class="line">     F_SETOWN           Set the process or process group to receive SIGIO and SIGURG signals; process</div><div class="line">                        groups are specified by supplying arg as negative, otherwise arg is interpreted as</div><div class="line">                        a process ID.</div><div class="line"></div><div class="line">     F_GETPATH          Get the path of the file descriptor Fildes.  The argument must be a buffer of size</div><div class="line">                        MAXPATHLEN or greater.</div><div class="line"></div><div class="line">     F_PREALLOCATE      Preallocate file storage space. Note: upon success, the space that is allocated</div><div class="line">                        can be the size requested, larger than the size requested, or (if the</div><div class="line">                        F_ALLOCATEALL flag is not provided) smaller than the space requested.</div><div class="line"></div><div class="line">     F_PUNCHHOLE        Deallocate a region and replace it with a hole. Subsequent reads of the affected</div><div class="line">                        region will return bytes of zeros that are usually not backed by physical blocks.</div><div class="line">                        This will not change the actual file size. Holes must be aligned to file system</div><div class="line">                        block boundaries. This will fail on file systems that do not support this inter-</div><div class="line">                        face.</div><div class="line"></div><div class="line">     F_SETSIZE          Truncate a file without zeroing space.  The calling process must have root privi-</div><div class="line">                        leges.</div><div class="line"></div><div class="line">     F_RDADVISE         Issue an advisory read async with no copy to user.</div><div class="line"></div><div class="line">     F_RDAHEAD          Turn read ahead off/on.  A zero value in arg disables read ahead.  A non-zero</div><div class="line">                        value in arg turns read ahead on.</div><div class="line"></div><div class="line">     F_READBOOTSTRAP    Read bootstrap from disk.</div><div class="line"></div><div class="line">     F_WRITEBOOTSTRAP   Write bootstrap on disk.  The calling process must have root privileges.</div><div class="line"></div><div class="line">     F_NOCACHE          Turns data caching off/on. A non-zero value in arg turns data caching off.  A</div><div class="line">                        value of zero in arg turns data caching on.</div><div class="line"></div><div class="line">     F_LOG2PHYS         Get disk device information.  Currently this only returns the disk device address</div><div class="line">                        that corresponds to the current file offset. Note that the system may return -1 as</div><div class="line">                        the disk device address if the file is not backed by physical blocks. This is sub-</div><div class="line">                        ject to change.</div><div class="line"></div><div class="line">     F_LOG2PHYS_EXT     Variant of F_LOG2PHYS that uses the passed in file offset and length.</div><div class="line"></div><div class="line">     F_FULLFSYNC        Does the same thing as fsync(2) then asks the drive to flush all buffered data to</div><div class="line">                        the permanent storage device (arg is ignored).  This is currently implemented on</div><div class="line">                        HFS, MS-DOS (FAT), and Universal Disk Format (UDF) file systems.  The operation</div><div class="line">                        may take quite a while to complete.  Certain FireWire drives have also been known</div><div class="line">                        to ignore the request to flush their buffered data.</div><div class="line"></div><div class="line">     F_SETNOSIGPIPE     Determines whether a SIGPIPE signal will be generated when a write fails on a pipe</div><div class="line">                        or socket for which there is no reader.  If arg is non-zero, SIGPIPE generation is</div><div class="line">                        disabled for descriptor fildes, while an arg of zero enables it (the default).</div><div class="line"></div><div class="line">     F_GETNOSIGPIPE     Returns whether a SIGPIPE signal will be generated when a write fails on a pipe or</div><div class="line">                        socket for which there is no reader.  The semantics of the return value match</div><div class="line">                        those of the arg of F_SETNOSIGPIPE.</div><div class="line"></div><div class="line">     The flags for the F_GETFD and F_SETFD commands are as follows:</div><div class="line"></div><div class="line">           FD_CLOEXEC   Close-on-exec; the given file descriptor will be automatically closed in the suc-</div><div class="line">                        cessor process image when one of the execv(2) or posix_spawn(2) family of system</div><div class="line">                        calls is invoked.</div><div class="line"></div><div class="line">     The flags for the F_GETFL and F_SETFL commands are as follows:</div><div class="line"></div><div class="line">           O_NONBLOCK   Non-blocking I/O; if no data is available to a read call, or if a write operation</div><div class="line">                        would block, the read or write call returns -1 with the error EAGAIN.</div><div class="line"></div><div class="line">           O_APPEND     Force each write to append at the end of file; corresponds to the O_APPEND flag of</div><div class="line">                        open(2).</div><div class="line"></div><div class="line">           O_ASYNC      Enable the SIGIO signal to be sent to the process group when I/O is possible,</div><div class="line">                        e.g., upon availability of data to be read.</div><div class="line"></div><div class="line">     Several commands are available for doing advisory file locking; they all operate on the following</div><div class="line">     structure:</div><div class="line"></div><div class="line">             struct flock &#123;</div><div class="line">                 off_t       l_start;    /* starting offset */</div><div class="line">                 off_t       l_len;      /* len = 0 means until end of file */</div><div class="line">                 pid_t       l_pid;      /* lock owner */</div><div class="line">                 short       l_type;     /* lock type: read/write, etc. */</div><div class="line">                 short       l_whence;   /* type of l_start */</div><div class="line">             &#125;;</div><div class="line"></div><div class="line">     The commands available for advisory record locking are as follows:</div><div class="line"></div><div class="line">     F_GETLK    Get the first lock that blocks the lock description pointed to by the third argument, arg,</div><div class="line">                taken as a pointer to a struct flock (see above).  The information retrieved overwrites</div><div class="line">                the information passed to fcntl in the flock structure.  If no lock is found that would</div><div class="line">                prevent this lock from being created, the structure is left unchanged by this function</div><div class="line">                call except for the lock type which is set to F_UNLCK.</div><div class="line"></div><div class="line">     F_SETLK    Set or clear a file segment lock according to the lock description pointed to by the third</div><div class="line">                argument, arg, taken as a pointer to a struct flock (see above).  F_SETLK is used to</div><div class="line">                establish shared (or read) locks (F_RDLCK) or exclusive (or write) locks, (F_WRLCK), as</div><div class="line">                well as remove either type of lock (F_UNLCK).  If a shared or exclusive lock cannot be</div><div class="line">                set, fcntl returns immediately with EAGAIN.</div><div class="line"></div><div class="line">     F_SETLKW   This command is the same as F_SETLK except that if a shared or exclusive lock is blocked</div><div class="line">                by other locks, the process waits until the request can be satisfied.  If a signal that is</div><div class="line">                to be caught is received while fcntl is waiting for a region, the fcntl will be inter-</div><div class="line">                rupted if the signal handler has not specified the SA_RESTART (see sigaction(2)).</div><div class="line"></div><div class="line">     When a shared lock has been set on a segment of a file, other processes can set shared locks on that</div><div class="line">     segment or a portion of it.  A shared lock prevents any other process from setting an exclusive lock</div><div class="line">     on any portion of the protected area.  A request for a shared lock fails if the file descriptor was</div><div class="line">     not opened with read access.</div><div class="line"></div><div class="line">     An exclusive lock prevents any other process from setting a shared lock or an exclusive lock on any</div><div class="line">     portion of the protected area.  A request for an exclusive lock fails if the file was not opened with</div><div class="line">     write access.</div><div class="line"></div><div class="line">     The value of l_whence is SEEK_SET, SEEK_CUR, or SEEK_END to indicate that the relative offset,</div><div class="line">     l_start bytes, will be measured from the start of the file, current position, or end of the file,</div><div class="line">     respectively.  The value of l_len is the number of consecutive bytes to be locked.  If l_len is nega-</div><div class="line">     tive, the result is undefined.  The l_pid field is only used with F_GETLK to return the process ID of</div><div class="line">     the process holding a blocking lock.  After a successful F_GETLK request, the value of l_whence is</div><div class="line">     SEEK_SET.</div><div class="line"></div><div class="line">     Locks may start and extend beyond the current end of a file, but may not start or extend before the</div><div class="line">     beginning of the file.  A lock is set to extend to the largest possible value of the file offset for</div><div class="line">     that file if l_len is set to zero. If l_whence and l_start point to the beginning of the file, and</div><div class="line">     l_len is zero, the entire file is locked.  If an application wishes only to do entire file locking,</div><div class="line">     the flock(2) system call is much more efficient.</div><div class="line"></div><div class="line">     There is at most one type of lock set for each byte in the file.  Before a successful return from an</div><div class="line">     F_SETLK or an F_SETLKW request when the calling process has previously existing locks on bytes in the</div><div class="line">     region specified by the request, the previous lock type for each byte in the specified region is</div><div class="line">     replaced by the new lock type.  As specified above under the descriptions of shared locks and exclu-</div><div class="line">     sive locks, an F_SETLK or an F_SETLKW request fails or blocks respectively when another process has</div><div class="line">     existing locks on bytes in the specified region and the type of any of those locks conflicts with the</div><div class="line">     type specified in the request.</div><div class="line"></div><div class="line">     This interface follows the completely stupid semantics of System V and IEEE Std 1003.1-1988</div><div class="line">     (``POSIX.1&apos;&apos;) that require that all locks associated with a file for a given process are removed when</div><div class="line">     any file descriptor for that file is closed by that process.  This semantic means that applications</div><div class="line">     must be aware of any files that a subroutine library may access.  For example if an application for</div><div class="line">     updating the password file locks the password file database while making the update, and then calls</div><div class="line">     getpwname(3) to retrieve a record, the lock will be lost because getpwname(3) opens, reads, and</div><div class="line">     closes the password database.  The database close will release all locks that the process has associ-</div><div class="line">     ated with the database, even if the library routine never requested a lock on the database.  Another</div><div class="line">     minor semantic problem with this interface is that locks are not inherited by a child process created</div><div class="line">     using the fork(2) function.  The flock(2) interface has much more rational last close semantics and</div><div class="line">     allows locks to be inherited by child processes.  Flock(2) is recommended for applications that want</div><div class="line">     to ensure the integrity of their locks when using library routines or wish to pass locks to their</div><div class="line">     children.  Note that flock(2) and fcntl(2) locks may be safely used concurrently.</div><div class="line"></div><div class="line">     All locks associated with a file for a given process are removed when the process terminates.</div><div class="line"></div><div class="line">     A potential for deadlock occurs if a process controlling a locked region is put to sleep by attempt-</div><div class="line">     ing to lock the locked region of another process.  This implementation detects that sleeping until a</div><div class="line">     locked region is unlocked would cause a deadlock and fails with an EDEADLK error.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">     The F_PREALLOCATE command operates on the following structure:</div><div class="line"></div><div class="line">             typedef struct fstore &#123;</div><div class="line">                 u_int32_t fst_flags;      /* IN: flags word */</div><div class="line">                 int       fst_posmode;    /* IN: indicates offset field */</div><div class="line">                 off_t     fst_offset;     /* IN: start of the region */</div><div class="line">                 off_t     fst_length;     /* IN: size of the region */</div><div class="line">                 off_t     fst_bytesalloc; /* OUT: number of bytes allocated */</div><div class="line">             &#125; fstore_t;</div><div class="line"></div><div class="line">     The flags (fst_flags) for the F_PREALLOCATE command are as follows:</div><div class="line"></div><div class="line">           F_ALLOCATECONTIG   Allocate contiguous space.</div><div class="line"></div><div class="line">           F_ALLOCATEALL      Allocate all requested space or no space at all.</div><div class="line"></div><div class="line">     The position modes (fst_posmode) for the F_PREALLOCATE command indicate how to use the offset field.</div><div class="line">     The modes are as follows:</div><div class="line"></div><div class="line">           F_PEOFPOSMODE   Allocate from the physical end of file.</div><div class="line"></div><div class="line">           F_VOLPOSMODE    Allocate from the volume offset.</div><div class="line"></div><div class="line">     The F_PUNCHHOLE command operates on the following structure:</div><div class="line"></div><div class="line">             typedef struct fpunchhole &#123;</div><div class="line">                 u_int32_t fp_flags;     /* unused */</div><div class="line">                 u_int32_t reserved;     /* (to maintain 8-byte alignment) */</div><div class="line">                 off_t     fp_offset;    /* IN: start of the region */</div><div class="line">                 off_t     fp_length;    /* IN: size of the region */</div><div class="line">             &#125; fpunchhole_t;</div><div class="line"></div><div class="line">     The F_RDADVISE command operates on the following structure which holds information passed from the</div><div class="line">     user to the system:</div><div class="line"></div><div class="line">             struct radvisory &#123;</div><div class="line">                off_t   ra_offset;  /* offset into the file */</div><div class="line">                int     ra_count;   /* size of the read     */</div><div class="line">             &#125;;</div><div class="line"></div><div class="line">     The F_READBOOTSTRAP and F_WRITEBOOTSTRAP commands operate on the following structure.</div><div class="line"></div><div class="line">             typedef struct fbootstraptransfer &#123;</div><div class="line">                 off_t fbt_offset;       /* IN: offset to start read/write */</div><div class="line">                 size_t fbt_length;      /* IN: number of bytes to transfer */</div><div class="line">                 void *fbt_buffer;       /* IN: buffer to be read/written */</div><div class="line">             &#125; fbootstraptransfer_t;</div><div class="line"></div><div class="line">     The F_LOG2PHYS command operates on the following structure:</div><div class="line"></div><div class="line">             struct log2phys &#123;</div><div class="line">                 u_int32_t l2p_flags;        /* unused so far */</div><div class="line">                 off_t     l2p_contigbytes;  /* unused so far */</div><div class="line">                 off_t     l2p_devoffset;    /* bytes into device */</div><div class="line">             &#125;;</div><div class="line"></div><div class="line">     The F_LOG2PHYS_EXT command operates on the same structure as F_LOG2PHYS but treats it as an in/out:</div><div class="line"></div><div class="line">             struct log2phys &#123;</div><div class="line">                 u_int32_t l2p_flags;        /* unused so far */</div><div class="line">                 off_t     l2p_contigbytes;  /* IN: number of bytes to be queried;</div><div class="line">                                                OUT: number of contiguous bytes allocated at this position */</div><div class="line">                 off_t     l2p_devoffset;    /* IN: bytes into file;</div><div class="line">                                                OUT: bytes into device */</div><div class="line">             &#125;;</div><div class="line"></div><div class="line">     If fildes is a socket, then the F_SETNOSIGPIPE and F_GETNOSIGPIPE commands are directly analogous,</div><div class="line">     and fully interoperate with the SO_NOSIGPIPE option of setsockopt(2) and getsockopt(2) respectively.</div><div class="line"></div><div class="line">RETURN VALUES</div><div class="line">     Upon successful completion, the value returned depends on cmd as follows:</div><div class="line"></div><div class="line">           F_DUPFD    A new file descriptor.</div><div class="line"></div><div class="line">           F_GETFD    Value of flag (only the low-order bit is defined).</div><div class="line"></div><div class="line">           F_GETFL    Value of flags.</div><div class="line"></div><div class="line">           F_GETOWN   Value of file descriptor owner.</div><div class="line"></div><div class="line">           other      Value other than -1.</div><div class="line"></div><div class="line">     Otherwise, a value of -1 is returned and errno is set to indicate the error.</div><div class="line"></div><div class="line">ERRORS</div><div class="line">     The fcntl() system call will fail if:</div><div class="line"></div><div class="line">     [EAGAIN]           The argument cmd is F_SETLK, the type of lock (l_type) is a shared lock (F_RDLCK)</div><div class="line">                        or exclusive lock (F_WRLCK), and the segment of a file to be locked is already</div><div class="line">                        exclusive-locked by another process; or the type is an exclusive lock and some</div><div class="line">                        portion of the segment of a file to be locked is already shared-locked or exclu-</div><div class="line">                        sive-locked by another process.</div><div class="line"></div><div class="line">     [EACCESS]          The argument cmd is either F_SETSIZE or F_WRITEBOOTSTRAP and the calling process</div><div class="line">                        does not have root privileges.</div><div class="line"></div><div class="line">     [EBADF]            Fildes is not a valid open file descriptor.</div><div class="line"></div><div class="line">                        The argument cmd is F_SETLK or F_SETLKW, the type of lock (l_type) is a shared</div><div class="line">                        lock (F_RDLCK), and fildes is not a valid file descriptor open for reading.</div><div class="line"></div><div class="line">                        The argument cmd is F_SETLK or F_SETLKW, the type of lock (l_type) is an exclusive</div><div class="line">                        lock (F_WRLCK), and fildes is not a valid file descriptor open for writing.</div><div class="line"></div><div class="line">                        The argument cmd is F_PREALLOCATE and the calling process does not have file write</div><div class="line">                        permission.</div><div class="line"></div><div class="line">                        The argument cmd is F_LOG2PHYS or F_LOG2PHYS_EXT and fildes is not a valid file</div><div class="line">                        descriptor open for reading.</div><div class="line"></div><div class="line">     [EDEADLK]          The argument cmd is F_SETLKW, and a deadlock condition was detected.</div><div class="line"></div><div class="line">     [EINTR]            The argument cmd is F_SETLKW, and the function was interrupted by a signal.</div><div class="line"></div><div class="line">     [EINVAL]           Cmd is F_DUPFD and arg is negative or greater than the maximum allowable number</div><div class="line">                        (see getdtablesize(2)).</div><div class="line"></div><div class="line">                        The argument cmd is F_GETLK, F_SETLK, or F_SETLKW and the data to which arg points</div><div class="line">                        is not valid, or fildes refers to a file that does not support locking.</div><div class="line"></div><div class="line">                        The argument cmd is F_PREALLOCATE and the fst_posmode is not a valid mode, or when</div><div class="line">                        F_PEOFPOSMODE is set and fst_offset is a non-zero value, or when F_VOLPOSMODE is</div><div class="line">                        set and fst_offset is a negative or zero value.</div><div class="line"></div><div class="line">                        The argument cmd is F_PUNCHHOLE and either fp_offset or fp_length are negative, or</div><div class="line">                        both fp_offset and fp_length are not multiples of the file system block size.</div><div class="line"></div><div class="line">                        The argument cmd is either F_READBOOTSTRAP or F_WRITEBOOTSTRAP and the operation</div><div class="line">                        was attempted on a non-HFS disk type.</div><div class="line"></div><div class="line">     [EMFILE]           Cmd is F_DUPFD and the maximum allowed number of file descriptors are currently</div><div class="line">                        open.</div><div class="line"></div><div class="line">     [EMFILE]           The argument cmd is F_DUPED and the maximum number of file descriptors permitted</div><div class="line">                        for the process are already in use, or no file descriptors greater than or equal</div><div class="line">                        to arg are available.</div><div class="line"></div><div class="line">     [ENOLCK]           The argument cmd is F_SETLK or F_SETLKW, and satisfying the lock or unlock request</div><div class="line">                        would result in the number of locked regions in the system exceeding a system-</div><div class="line">                        imposed limit.</div><div class="line"></div><div class="line">     [ENOSPC]           The argument cmd is F_PREALLOCATE and either there is no space available on the</div><div class="line">                        volume containing fildes or fst_flags contains F_ALLOCATEALL and there is not</div><div class="line">                        enough space available on the volume containing fildes to satisfy the entire</div><div class="line">                        request.</div><div class="line"></div><div class="line">                        The argument cmd is F_PUNCHHOLE and there is not enough space available on the</div><div class="line">                        volume containing fildes to satisfy the request. As an example, a filesystem that</div><div class="line">                        supports cloned files may return this error if punching a hole requires the cre-</div><div class="line">                        ation of a clone and there is not enough space available to do so.</div><div class="line"></div><div class="line">     [EOVERFLOW]        A return value would overflow its representation.  For example, cmd is F_GETLK,</div><div class="line">                        F_SETLK, or F_SETLKW and the smallest (or, if l_len is non-zero, the largest) off-</div><div class="line">                        set of a byte in the requested segment will not fit in an object of type off_t.</div><div class="line"></div><div class="line">     [EPERM]            The argument cmd is F_PUNCHHOLE and the calling process does not have file write</div><div class="line">                        permission.</div><div class="line"></div><div class="line">     [ESRCH]            Cmd is F_SETOWN and the process ID given as argument is not in use.</div><div class="line"></div><div class="line">SEE ALSO</div><div class="line">     close(2), execve(2), flock(2), getdtablesize(2), open(2), pipe(2), socket(2), setsockopt(2),</div><div class="line">     sigaction(3)</div><div class="line"></div><div class="line">HISTORY</div><div class="line">     The fcntl() function call appeared in 4.2BSD.</div><div class="line"></div><div class="line">4.2 Berkeley Distribution       August 24, 2017      4.2 Berkeley Distribution</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">GETSOCKOPT(2)               BSD System Calls Manual              GETSOCKOPT(2)</div><div class="line"></div><div class="line">NAME</div><div class="line">     getsockopt, setsockopt -- get and set options on sockets</div><div class="line"></div><div class="line">SYNOPSIS</div><div class="line">     #include &lt;sys/socket.h&gt;</div><div class="line"></div><div class="line">     int</div><div class="line">     getsockopt(int socket, int level, int option_name, void *restrict option_value,</div><div class="line">         socklen_t *restrict option_len);</div><div class="line"></div><div class="line">     int</div><div class="line">     setsockopt(int socket, int level, int option_name, const void *option_value, socklen_t option_len);</div><div class="line"></div><div class="line">DESCRIPTION</div><div class="line">     getsockopt() and setsockopt() manipulate the options associated with a socket.  Options may exist at</div><div class="line">     multiple protocol levels; they are always present at the uppermost ``socket&apos;&apos; level.</div><div class="line"></div><div class="line">     When manipulating socket options the level at which the option resides and the name of the option</div><div class="line">     must be specified.  To manipulate options at the socket level, level is specified as SOL_SOCKET.  To</div><div class="line">     manipulate options at any other level the protocol number of the appropriate protocol controlling the</div><div class="line">     option is supplied.  For example, to indicate that an option is to be interpreted by the TCP proto-</div><div class="line">     col, level should be set to the protocol number of TCP; see getprotoent(3).</div><div class="line"></div><div class="line">     The parameters option_value and option_len are used to access option values for setsockopt().  For</div><div class="line">     getsockopt() they identify a buffer in which the value for the requested option(s) are to be</div><div class="line">     returned.  For getsockopt(), option_len is a value-result parameter, initially containing the size of</div><div class="line">     the buffer pointed to by option_value, and modified on return to indicate the actual size of the</div><div class="line">     value returned.  If no option value is to be supplied or returned, option_value may be NULL.</div><div class="line"></div><div class="line">     option_name and any specified options are passed uninterpreted to the appropriate protocol module for</div><div class="line">     interpretation.  The include file &lt;sys/socket.h&gt; contains definitions for socket level options,</div><div class="line">     described below.  Options at other protocol levels vary in format and name; consult the appropriate</div><div class="line">     entries in section 4 of the manual.</div><div class="line"></div><div class="line">     Most socket-level options utilize an int parameter for option_value.  For setsockopt(), the parameter</div><div class="line">     should be non-zero to enable a boolean option, or zero if the option is to be disabled.  SO_LINGER</div><div class="line">     uses a struct linger parameter, defined in &lt;sys/socket.h&gt;, which specifies the desired state of the</div><div class="line">     option and the linger interval (see below).  SO_SNDTIMEO and SO_RCVTIMEO use a struct timeval parame-</div><div class="line">     ter, defined in &lt;sys/time.h&gt;.</div><div class="line"></div><div class="line">     The following options are recognized at the socket level.  Except as noted, each may be examined with</div><div class="line">     getsockopt() and set with setsockopt().</div><div class="line"></div><div class="line">           SO_DEBUG        enables recording of debugging information</div><div class="line">           SO_REUSEADDR    enables local address reuse</div><div class="line">           SO_REUSEPORT    enables duplicate address and port bindings</div><div class="line">           SO_KEEPALIVE    enables keep connections alive</div><div class="line">           SO_DONTROUTE    enables routing bypass for outgoing messages</div><div class="line">           SO_LINGER       linger on close if data present</div><div class="line">           SO_BROADCAST    enables permission to transmit broadcast messages</div><div class="line">           SO_OOBINLINE    enables reception of out-of-band data in band</div><div class="line">           SO_SNDBUF       set buffer size for output</div><div class="line">           SO_RCVBUF       set buffer size for input</div><div class="line">           SO_SNDLOWAT     set minimum count for output</div><div class="line">           SO_RCVLOWAT     set minimum count for input</div><div class="line">           SO_SNDTIMEO     set timeout value for output</div><div class="line">           SO_RCVTIMEO     set timeout value for input</div><div class="line">           SO_TYPE         get the type of the socket (get only)</div><div class="line">           SO_ERROR        get and clear error on the socket (get only)</div><div class="line">           SO_NOSIGPIPE    do not generate SIGPIPE, instead return EPIPE</div><div class="line">           SO_NREAD        number of bytes to be read (get only)</div><div class="line">           SO_NWRITE       number of bytes written not yet sent by the protocol (get only)</div><div class="line">           SO_LINGER_SEC   linger on close if data present with timeout in seconds</div><div class="line"></div><div class="line">     SO_DEBUG enables debugging in the underlying protocol modules.</div><div class="line"></div><div class="line">     SO_REUSEADDR indicates that the rules used in validating addresses supplied in a bind(2) call should</div><div class="line">     allow reuse of local addresses.</div><div class="line"></div><div class="line">     SO_REUSEPORT allows completely duplicate bindings by multiple processes if they all set SO_REUSEPORT</div><div class="line">     before binding the port.  This option permits multiple instances of a program to each receive UDP/IP</div><div class="line">     multicast or broadcast datagrams destined for the bound port.</div><div class="line"></div><div class="line">     SO_KEEPALIVE enables the periodic transmission of messages on a connected socket.  Should the con-</div><div class="line">     nected party fail to respond to these messages, the connection is considered broken and processes</div><div class="line">     using the socket are notified via a SIGPIPE signal when attempting to send data.</div><div class="line"></div><div class="line">     SO_DONTROUTE indicates that outgoing messages should bypass the standard routing facilities.</div><div class="line">     Instead, messages are directed to the appropriate network interface according to the network portion</div><div class="line">     of the destination address.</div><div class="line"></div><div class="line">     SO_LINGER controls the action taken when unsent messages are queued on socket and a close(2) is per-</div><div class="line">     formed.  If the socket promises reliable delivery of data and SO_LINGER is set, the system will block</div><div class="line">     the process on the close attempt until it is able to transmit the data or until it decides it is</div><div class="line">     unable to deliver the information (a timeout period, termed the linger interval, is specified in the</div><div class="line">     setsockopt() call when SO_LINGER is requested).  If SO_LINGER is disabled and a close is issued, the</div><div class="line">     system will process the close in a manner that allows the process to continue as quickly as possible.</div><div class="line"></div><div class="line">     SO_LINGER_SEC is the same option as SO_LINGER except the linger time is in seconds for SO_LINGER_SEC.</div><div class="line"></div><div class="line">     The option SO_BROADCAST requests permission to send broadcast datagrams on the socket.  Broadcast was</div><div class="line">     a privileged operation in earlier versions of the system.</div><div class="line"></div><div class="line">     With protocols that support out-of-band data, the SO_OOBINLINE option requests that out-of-band data</div><div class="line">     be placed in the normal data input queue as received; it will then be accessible with recv or read</div><div class="line">     calls without the MSG_OOB flag.  Some protocols always behave as if this option is set.</div><div class="line"></div><div class="line">     SO_SNDBUF and SO_RCVBUF are options to adjust the normal buffer sizes allocated for output and input</div><div class="line">     buffers, respectively.  The buffer size may be increased for high-volume connections, or may be</div><div class="line">     decreased to limit the possible backlog of incoming data.  The system places an absolute limit on</div><div class="line">     these values.</div><div class="line"></div><div class="line">     SO_SNDLOWAT is an option to set the minimum count for output operations.  Most output operations</div><div class="line">     process all of the data supplied by the call, delivering data to the protocol for transmission and</div><div class="line">     blocking as necessary for flow control.  Nonblocking output operations will process as much data as</div><div class="line">     permitted (subject to flow control) without blocking, but will process no data if flow control does</div><div class="line">     not allow the smaller of the low-water mark value or the entire request to be processed.  A select(2)</div><div class="line">     operation testing the ability to write to a socket will return true only if the low-water mark amount</div><div class="line">     could be processed.  The default value for SO_SNDLOWAT is set to a convenient size for network effi-</div><div class="line">     ciency, often 2048.</div><div class="line"></div><div class="line">     SO_RCVLOWAT is an option to set the minimum count for input operations.  In general, receive calls</div><div class="line">     will block until any (non-zero) amount of data is received, then return with the smaller of the</div><div class="line">     amount available or the amount requested.  The default value for SO_RCVLOWAT is 1.  If SO_RCVLOWAT is</div><div class="line">     set to a larger value, blocking receive calls normally wait until they have received the smaller of</div><div class="line">     the low-water mark value or the requested amount.  Receive calls may still return less than the low-</div><div class="line">     water mark if an error occurs, a signal is caught, or the type of data next in the receive queue is</div><div class="line">     different than that returned.</div><div class="line"></div><div class="line">     SO_SNDTIMEO is an option to set a timeout value for output operations.  It accepts a struct timeval</div><div class="line">     parameter with the number of seconds and microseconds used to limit waits for output operations to</div><div class="line">     complete.  If a send operation has blocked for this much time, it returns with a partial count or</div><div class="line">     with the error EWOULDBLOCK if no data were sent.  In the current implementation, this timer is</div><div class="line">     restarted each time additional data are delivered to the protocol, implying that the limit applies to</div><div class="line">     output portions ranging in size from the low-water mark to the high-water mark for output.</div><div class="line"></div><div class="line">     SO_RCVTIMEO is an option to set a timeout value for input operations.  It accepts a struct timeval</div><div class="line">     parameter with the number of seconds and microseconds used to limit waits for input operations to</div><div class="line">     complete.  In the current implementation, this timer is restarted each time additional data are</div><div class="line">     received by the protocol, and thus the limit is in effect an inactivity timer.  If a receive opera-</div><div class="line">     tion has been blocked for this much time without receiving additional data, it returns with a short</div><div class="line">     count or with the error EWOULDBLOCK if no data were received.  The struct timeval parameter must rep-</div><div class="line">     resent a positive time interval; otherwise, setsockopt() returns with the error EDOM.</div><div class="line"></div><div class="line">     SO_NOSIGPIPE is an option that prevents SIGPIPE from being raised when a write fails on a socket to</div><div class="line">     which there is no reader; instead, the write to the socket returns with the error EPIPE when there is</div><div class="line">     no reader.</div><div class="line"></div><div class="line">     Finally, SO_TYPE, SO_ERROR, SO_NREAD, and SO_NWRITE are options used only with getsockopt().</div><div class="line"></div><div class="line">     SO_TYPE returns the type of the socket, such as SOCK_STREAM; it is useful for servers that inherit</div><div class="line">     sockets on startup.</div><div class="line"></div><div class="line">     SO_ERROR returns any pending error on the socket and clears the error status.  It may be used to</div><div class="line">     check for asynchronous errors on connected datagram sockets or for other asynchronous errors.</div><div class="line"></div><div class="line">     SO_NREAD returns the amount of data in the input buffer that is available to be received.  For data-</div><div class="line">     gram oriented sockets, SO_NREAD returns the size of the first packet -- this differs from the ioctl()</div><div class="line">     command FIONREAD that returns the total amount of data available.</div><div class="line"></div><div class="line">     SO_NWRITE returns the amount of data in the output buffer not yet sent by the protocol.</div><div class="line"></div><div class="line">RETURN VALUES</div><div class="line">     Upon successful completion, the value 0 is returned; otherwise the value -1 is returned and the</div><div class="line">     global variable errno is set to indicate the error.</div><div class="line"></div><div class="line">ERRORS</div><div class="line">     The getsockopt() and setsockopt() system calls will succeed unless:</div><div class="line"></div><div class="line">     [EBADF]            The argument socket is not a valid file descriptor.</div><div class="line"></div><div class="line">     [EFAULT]           The address pointed to by option_value is not in a valid part of the process</div><div class="line">                        address space.  For getsockopt(), this error may also be returned if option_len is</div><div class="line">                        not in a valid part of the process address space.</div><div class="line"></div><div class="line">     [EINVAL]           The option is invalid at the level indicated.</div><div class="line"></div><div class="line">     [ENOBUFS]          Insufficient system resources available for the call to complete.</div><div class="line"></div><div class="line">     [ENOMEM]           Insufficient memory available for the system call to complete.</div><div class="line"></div><div class="line">     [ENOPROTOOPT]      The option is unknown at the level indicated.</div><div class="line"></div><div class="line">     [ENOTSOCK]         The argument socket is not a socket (e.g., a plain file).</div><div class="line"></div><div class="line">     The setsockopt() system call will succeed unless:</div><div class="line"></div><div class="line">     [EDOM]             The argument option_value is out of bounds.</div><div class="line"></div><div class="line">     [EISCONN]          socket is already connected and a specified option cannot be set while this is the</div><div class="line">                        case.</div><div class="line"></div><div class="line">     [EINVAL]           The socket has been shut down.</div><div class="line"></div><div class="line">LEGACY SYNOPSIS</div><div class="line">     #include &lt;sys/types.h&gt;</div><div class="line">     #include &lt;sys/socket.h&gt;</div><div class="line"></div><div class="line">     The include file &lt;sys/types.h&gt; is necessary.</div><div class="line"></div><div class="line">SEE ALSO</div><div class="line">     socket(2), bind(2), ioctl(2), getprotoent(3), protocols(5)</div><div class="line"></div><div class="line">BUGS</div><div class="line">     Several of the socket options should be handled at lower levels of the system.</div><div class="line"></div><div class="line">HISTORY</div><div class="line">     The getsockopt() system call appeared in 4.2BSD.</div><div class="line"></div><div class="line">4.3-Reno Berkeley Distribution  April 19, 1994  4.3-Reno Berkeley Distribution</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/12/tips-net-mars-heartbeat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/12/tips-net-mars-heartbeat/" itemprop="url">
                  Android微信智能心跳方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T15:54:04+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前言：在13年11月中旬时，因为基础组件组人手紧张，Leo安排我和春哥去广州轮岗支援。刚到广州的时候，Ray让我和春哥对Line和WhatsApp的心跳机制进行分析。我和春哥抓包测试了差不多两个多礼拜，在我们基本上摸清了Line和WhatsApp的心跳机制后，Ray才告诉我们真正的任务——对微信的固定心跳进行优化，并告诉我们这不是一件容易的事情。于是我和春哥开始构思第一个方案，我们开始想用统计的方法来解决问题，当我们拿着第一个方案和Ray讨论时，发现不能优雅应对Ray的所有提问：1、测试环境的准确性，失败到底是因为网络的特性导致还是因为用户当前的环境变化导致的暂时失败。2、临界值界定，如果方案选中的心跳值是临界值，我们该怎么办。Ray和组件组同事在网络方面有极其丰富的经验，虽然他没有给我们指出明确的方向，但提出的问题帮助我们更快的补齐需要面对的核心问题。这两个问题让我和春哥意识到如果能很好的解决，就可以给出一个比较好的心跳方案。第一个问题我和春哥开始就意识到，第二个问题我们确实在一开始时疏忽了。但直接解决这两个问题确实不容易，这着实让我和春哥迷茫了几天，有两三天在纺园我都没怎么睡着，因为想不到更好的方法。直到有一天思路发生了一些转变，既然最优解比较复杂，为什么不绕过去，使用有损服务理念找次优解呢。让复杂的事情简单化，好了，想到这里突然有一种拨开云雾的感觉。</p>
<p>思路对了，方案就可以做到简单并且可靠，大家可以看到最终的方案是比较简单的，并且效果还挺好的。在方案描述之前大概讲一下减低问题复杂度的方法：</p>
<ol>
<li>延迟心跳测试法：这是测试结果准确的前提保障，我们认为长连接建立后连续三次成功的短心跳就可以很大程度的保证下一次心跳环境是正常的。</li>
<li>成功一次认定，失败连续累积认定：成功是绝对的，连续失败多次才可能是失败。</li>
<li>临界值避免：我们使用比计算出的心跳稍微小一点的值做为稳定心跳避免临界值。</li>
<li>动态调整：即使在一次完整的智能心跳计算过程中，我们没有找到最好的值，我们还有机会来进行校正。</li>
</ol>
<p>当我和春哥想出第二个简单易行的方案后，我们心里就很有底了，去找Ray讨论，Ray听完后一次通过，然后Ray约了Harvey，给Harvey讲完后，Harvey说听起来可以，可以试试。</p>
<p>然后就开始动手，分析竞品加确定方案花了差不多两个月。写心跳的主要代码，只花了一天时间，我记得那天是年会后的一天。回过头来再看这个方案花费的时间还是值得的，后来灰度的统计数据显示，70%用户都可以达到我们的心跳上限。</p>
<p>搞完智能心跳后一段时间在广州没事干，我就跟Ray商量，Ray让我去测试下WebView的性能瓶颈。然后我跟周斯基一起来做这件事，搞完了安卓客户端WebView性能瓶颈测试后，因为怀孕的老婆一个人在深圳，领导就安排我先回深圳了。春哥坚守着把GCM部分完成后才回深圳。</p>
<p>等我们的心跳版本正式发布后，一年前我在公司km上分享了智能心跳方案，吸引不少做push的同事加入了讨论，感觉这方面的交流还是很有必要的。</p>
<p>好了，废话了很多，下面分享一下微信的智能心跳方案细节。由于字数比较多，建议大家使用PC版微信查看。</p>
<h2 id="1-主要目标"><a href="#1-主要目标" class="headerlink" title="1.主要目标"></a>1.主要目标</h2><p>本方案的主要目标是，在尽量不影响用户收消息及时性的前提下，根据网络类型自适应的找出保活信令TCP连接的尽可能大的心跳间隔，从而达到减少安卓微信因心跳引起的空中信道资源消耗，减少心跳Server的负载，以及减少部分因心跳引起的耗电。</p>
<p>主要方法是参考WhatsApp和Line中有价值的做法，结合影响TCP连接寿命的因素，实现Android微信后台自适应心跳算法，同时使用GCM作为辅助通道增加新消息通知的可靠性。</p>
<h2 id="2-WhatsApp、Line、微信的Push策略分析"><a href="#2-WhatsApp、Line、微信的Push策略分析" class="headerlink" title="2. WhatsApp、Line、微信的Push策略分析"></a>2. WhatsApp、Line、微信的Push策略分析</h2><h3 id="2-1-WhatsApp"><a href="#2-1-WhatsApp" class="headerlink" title="2.1 WhatsApp"></a>2.1 WhatsApp</h3><p>在不支持GCM的设备上，采用和微信类似的长连接+心跳策略，WIFI和手机网络下的心跳间隔都为4分45秒，心跳5次后，主动断开连接再重连。</p>
<p>在支持GCM的设备上，主要靠GCM来激活WhatsApp，WhatsApp启动后，会建立一个与服务器的长连接，直接通过此长连接发送Push消息，这个长连接10分钟无消息就会主动断掉，且这十分钟内不做心跳，断掉后WhatsApp客户端和它的服务器不再有连接。当有消息时候，服务器发现没有长连接会发送GCM消息，手机收到GCM消息后，会重新建立长连接来收取消息，10分钟无消息会再断开，如此循环。</p>
<h3 id="2-2-Line"><a href="#2-2-Line" class="headerlink" title="2.2 Line"></a>2.2 Line</h3><p>从测试中发现Line在国内、台湾、美国使用了不同的策略。</p>
<h4 id="2-2-1美国（使用GCM）："><a href="#2-2-1美国（使用GCM）：" class="headerlink" title="2.2.1美国（使用GCM）："></a>2.2.1美国（使用GCM）：</h4><p>启动时，会保持7分钟心跳（CDMA2000网络）维持长连接半小时，之后主动断开长连接。当有消息时，服务器会发送GCM消息，Line客户端接收到GCM消息后，重新建立长连接，并再次用心跳维持半个小时。</p>
<h4 id="2-2-2国内（不使用GCM）："><a href="#2-2-2国内（不使用GCM）：" class="headerlink" title="2.2.2国内（不使用GCM）："></a>2.2.2国内（不使用GCM）：</h4><p>在国内，同样帐号在相同网络，不同的手机上测出了两种策略：</p>
<ul>
<li>长连接+心跳策略（在Galaxy S3上使用），心跳间隔WIFI下是3分20秒，手机网络是7分钟。</li>
<li>轮询策略（在红米和Nexus S上使用），如图2-1所示。与心跳策略的主要区别用红色标出，客户端在长连接建立后也会定时发送请求，Server会回复并且同时关闭长连接。客户端等待轮询间隔T1后再次建立TCP连接。Line会根据手机的活跃状态动态调整T1，调整范围是从最小1分到最大到2小时半。而长连接存活时间T2比较固定，在WIFI下4分钟，手机网络7分钟。如果在T2时收到新消息会延长T2的时间。
<img src="http://images.wodekouwei.com/tips-net-mars-heartbeat-2019312164217.png" alt="图2-1 Line在国内的轮询策略"></li>
</ul>
<h4 id="2-2-3台湾（不使用GCM）："><a href="#2-2-3台湾（不使用GCM）：" class="headerlink" title="2.2.3台湾（不使用GCM）："></a>2.2.3台湾（不使用GCM）：</h4><p>从IBG同事win和guang提供的测试数据中看到，台湾使用的策略跟国内的轮询策略类似。</p>
<h3 id="2-3-微信"><a href="#2-3-微信" class="headerlink" title="2.3 微信"></a>2.3 微信</h3><p>微信没有使用GCM，自己维护TCP长连接，使用固定心跳。</p>
<h3 id="2-4心跳典型值"><a href="#2-4心跳典型值" class="headerlink" title="2.4心跳典型值"></a>2.4心跳典型值</h3><table>
<thead>
<tr>
<th></th>
<th>WhatsApp</th>
<th>Line</th>
<th>GCM</th>
</tr>
</thead>
<tbody>
<tr>
<td>WIFI</td>
<td>4分45秒</td>
<td>3分20秒</td>
<td>15分钟</td>
</tr>
<tr>
<td>手机网络</td>
<td>4分45秒</td>
<td>7分钟</td>
<td>28分钟</td>
</tr>
</tbody>
</table>
<h3 id="2-5Line、WhatsApp、微信Push策略的优点"><a href="#2-5Line、WhatsApp、微信Push策略的优点" class="headerlink" title="2.5Line、WhatsApp、微信Push策略的优点"></a>2.5Line、WhatsApp、微信Push策略的优点</h3><ol>
<li>微信：当前心跳间隔比竞品短，所以微信在新消息提醒上会最及时。</li>
<li>使用GCM：Line和WhatsApp使用GCM策略的最大优点就是省电，以及减轻系统负荷（减少后台应用数目）。</li>
<li>Line：Line的轮询策略，优点是当Line处于活跃状态时，及时收消息。当Line处于不活跃状态时，省电。</li>
</ol>
<h3 id="2-6Line、WhatsApp微信Push策略的不足"><a href="#2-6Line、WhatsApp微信Push策略的不足" class="headerlink" title="2.6Line、WhatsApp微信Push策略的不足"></a>2.6Line、WhatsApp微信Push策略的不足</h3><ol>
<li>微信当前心跳频率相对竞品较大，在耗电、耗流量，占用信令通道等方面有所影响。</li>
<li>Line的轮询策略，导致的问题是消息可能会延迟接收，测试发现最大延迟间隔到2.5小时。</li>
<li>WhatsApp和Line使用Push拉起一个定时长连接策略，缺点是要依赖Google的Push服务，如果Google的Push服务不稳定，消息也会延迟接收。</li>
<li>在国内的移动和联通2G网络下，由于运营商的策略，GCM长连接频繁断连，WhatsApp的Push消息很不及时，体验非常差。</li>
</ol>
<h2 id="3-GCM研究"><a href="#3-GCM研究" class="headerlink" title="3. GCM研究"></a>3. GCM研究</h2><h3 id="3-1-GCM特点"><a href="#3-1-GCM特点" class="headerlink" title="3.1 GCM特点"></a>3.1 GCM特点</h3><ol>
<li>Android2.2以下的手机不支持GCM，2.2到3.0需要安装Google Store并设置Google帐号，4.04及以上版本不需要设置帐号也能支持。</li>
<li>GCM只传递数据（可以传递小于4kb的数据），对这些数据的处理可以全部由开发者控制。</li>
<li>Android应用不需要运行就可以接收消息(通过Android广播)。</li>
<li>GCM不保证发送的消息的顺序，也不保证消息一定能够推送到手机。</li>
</ol>
<h3 id="3-2-GCM心跳策略以及存在的问题"><a href="#3-2-GCM心跳策略以及存在的问题" class="headerlink" title="3.2 GCM心跳策略以及存在的问题"></a>3.2 GCM心跳策略以及存在的问题</h3><ol>
<li>用心跳保活长连接，心跳间隔为WIFI下15分钟，数据网络下28分钟。</li>
<li>Google可以改变所有Android设备的心跳间隔值（目前还未改变过）。</li>
<li>GCM由于心跳间隔固定，并且较长，所以在NAT aging-time设置较小的网络（如联通2G，或有些WIFI环境下）会导致TCP长连接在下一次心跳前被网关释放。造成Push延迟接收。</li>
</ol>
<h3 id="3-3-GCM的可用性及稳定性"><a href="#3-3-GCM的可用性及稳定性" class="headerlink" title="3.3 GCM的可用性及稳定性"></a>3.3 GCM的可用性及稳定性</h3><p>目前测试发现GCM在国内可用性不高，原因有：</p>
<ol>
<li>Android很多被手机厂商定制化，厂商可能会去掉GCM服务。</li>
<li>Android2.2到3.0之间需要安装Google Store并设置Google帐号。</li>
<li>由于国内2G和移动3G的NAT超时时间都小于GCM心跳时间(28分钟)，TCP长连接必然无法保活，每次都要等28分钟心跳失败重连后才能收到Push。</li>
<li>某些运营商可能限制了5228端口，移动3G/2G下，发现几乎无法连接上GCM服务器，也就无法获得GCM通知，WhatsApp放后台10分钟后，经常很长时间都收不到Push消息。</li>
</ol>
<p>在美国3G网络下抓包的24小时，GCM的连接极其稳定，24小时内GCM长连接未曾断过，在台湾3G网络下抓包14个小时，GCM连接也只断过一次。WhatsApp用户在此类地区网络下客户端可以获得很及时的Push通知。</p>
<p>在中国电信3G下抓包，大部分时间GCM连接都比较稳定，只会因为偶尔的DHCP造成断连现象，由于频率很低(平均数小时才发生一次)，对Push体验的影响不大。</p>
<h3 id="3-4-GCM-Server类型"><a href="#3-4-GCM-Server类型" class="headerlink" title="3.4 GCM Server类型"></a>3.4 GCM Server类型</h3><p>GCM提供两种Server模型：</p>
<ol>
<li>HTTP Server : 使用同步接口发送HTTP请求，一次请求可以发给最多1000个设备。</li>
<li>XMPP Server :使用异步接口发送请求，只支持对单个设备（或同一个用户的多个关联设备发送），发送请求并发数须小于1000，支持设备到云端Server发送数据。需要Google将我们的发送Server加入白名单。</li>
</ol>
<h2 id="4-微信可能的改进点探讨"><a href="#4-微信可能的改进点探讨" class="headerlink" title="4.微信可能的改进点探讨"></a>4.微信可能的改进点探讨</h2><p>微信Push的优化主要有几个优化点：</p>
<ol>
<li>公共Push通道</li>
<li>使用GCM Push作为辅助通道</li>
<li>自适应心跳间隔优化</li>
</ol>
<h3 id="4-1-公共Push通道"><a href="#4-1-公共Push通道" class="headerlink" title="4.1 公共Push通道"></a>4.1 公共Push通道</h3><p>由于GCM在国内的可靠性很低，现在国内Android上的Push基本上是各自为政，很多软件都自己实现Push。导致手机被经常性的唤醒，耗电耗流量严重。</p>
<p>市面上已经有很多第三方的公共推送服务，大家可以选择一个适合自己应用的推送服务。腾讯也有信鸽和维纳斯组件，大家在选择方案的时候可以对比下。</p>
<p>最终因为我们国内外使用一套方案，并且是辅助公道，所以我们选择使用GCM。</p>
<h3 id="4-2-使用GCM-Push作为辅助通道"><a href="#4-2-使用GCM-Push作为辅助通道" class="headerlink" title="4.2 使用GCM Push作为辅助通道"></a>4.2 使用GCM Push作为辅助通道</h3><p>当前使用GCM的成本不大，可以使用GCM作为辅助通道来增加新消息的及时性。</p>
<p>使用GCM作为辅助通道，在支持GCM的设备上微信上传自己的注册GCM ID给微信Server。</p>
<p>微信Server在发现长连接失效的情况下，可以使用GCM 作为辅助通道通知客户端有新消息，客户端收到push通知后做一次sync。</p>
<p>只利用GCM来激活微信，不传递消息的具体数据，要控制给同一设备发送GCM通知的时间间隔(如五分钟)。</p>
<h3 id="4-3-自适应心跳间隔优化"><a href="#4-3-自适应心跳间隔优化" class="headerlink" title="4.3 自适应心跳间隔优化"></a>4.3 自适应心跳间隔优化</h3><h4 id="4-3-1影响TCP连接寿命的因素"><a href="#4-3-1影响TCP连接寿命的因素" class="headerlink" title="4.3.1影响TCP连接寿命的因素"></a>4.3.1影响TCP连接寿命的因素</h4><p>在Android下，不管是GCM，还是微信，都是通过TCP长连接来进行Push消息的，TCP长连接存活，消息Push就及时，所以要对影响TCP连接寿命的因素进行研究。</p>
<h5 id="1、NAT超时"><a href="#1、NAT超时" class="headerlink" title="1、NAT超时"></a>1、NAT超时</h5><p>大部分移动无线网络运营商都在链路一段时间没有数据通讯时，会淘汰 NAT 表中的对应项，造成链路中断（NAT超时的更多描述见附录6.1）。NAT超时是影响TCP连接寿命的一个重要因素(尤其是国内)，所以客户端自动测算NAT超时时间，来动态调整心跳间隔，是一个重要的优化点。</p>
<h5 id="2、DHCP的租期（lease-time）"><a href="#2、DHCP的租期（lease-time）" class="headerlink" title="2、DHCP的租期（lease time）"></a>2、DHCP的租期（lease time）</h5><p>目前测试发现安卓系统对DHCP的处理有Bug，DHCP租期到了不会主动续约并且会继续使用过期IP，这个问题会造成TCP长连接偶然的断连。（租期问题的具体描述见附录6.2）。</p>
<h5 id="3、网络状态变化"><a href="#3、网络状态变化" class="headerlink" title="3、网络状态变化"></a>3、网络状态变化</h5><p>手机网络和WIFI网络切换、网络断开和连上等情况有网络状态的变化，也会使长连接变为无效连接，需要监听响应的网络状态变化事件，重新建立Push长连接。</p>
<h4 id="4-3-2-心跳范围选择"><a href="#4-3-2-心跳范围选择" class="headerlink" title="4.3.2 心跳范围选择"></a>4.3.2 心跳范围选择</h4><h5 id="1、前后台区分处理：为了保证微信收消息及时性的体验，当微信处于前台活跃状态时，使用固定心跳。"><a href="#1、前后台区分处理：为了保证微信收消息及时性的体验，当微信处于前台活跃状态时，使用固定心跳。" class="headerlink" title="1、前后台区分处理：为了保证微信收消息及时性的体验，当微信处于前台活跃状态时，使用固定心跳。"></a>1、前后台区分处理：为了保证微信收消息及时性的体验，当微信处于前台活跃状态时，使用固定心跳。</h5><p>微信进入后台（或者前台关屏）时，先用几次最小心跳维持长链接。然后进入后台自适应心跳计算。这样做的目的是尽量选择用户不活跃的时间段，来减少心跳计算可能产生的消息不及时收取影响。</p>
<h5 id="2、后台自适应心跳选择区间："><a href="#2、后台自适应心跳选择区间：" class="headerlink" title="2、后台自适应心跳选择区间："></a>2、后台自适应心跳选择区间：</h5><p>可根据自身产品的特点选择合适的心跳范围。</p>
<h4 id="4-3-3-状态转换图"><a href="#4-3-3-状态转换图" class="headerlink" title="4.3.3 状态转换图"></a>4.3.3 状态转换图</h4><p><img src="http://images.wodekouwei.com/tips-net-mars-heartbeat-2019312164921.png" alt="tips-net-mars-heartbeat-2019312164921"></p>
<h4 id="4-3-4自适应心跳算法描述"><a href="#4-3-4自适应心跳算法描述" class="headerlink" title="4.3.4自适应心跳算法描述"></a>4.3.4自适应心跳算法描述</h4><h5 id="1、按网络类型区分计算："><a href="#1、按网络类型区分计算：" class="headerlink" title="1、按网络类型区分计算："></a>1、按网络类型区分计算：</h5><p>因为每个网络的NAT时间可能不一致。所以需要区分计算，数据网络按subType做关键字，WIFI按WIFI名做关键字。
对稳定的网络，因为NAT老化时间的存在，在自适应计算态的时候，暂设计以下步骤在当前心跳区间逼近出最大可用的心跳。</p>
<h6 id="a）-变量说明："><a href="#a）-变量说明：" class="headerlink" title="a） 变量说明："></a>a） 变量说明：</h6><ul>
<li>[MinHeart，MaxHeart]——心跳可选区间。</li>
<li>successHeart——当前成功心跳，初始为MinHeart</li>
<li>curHeart——当前心跳初始值为successHeart</li>
<li>heartStep——心跳增加步长</li>
<li>successStep——稳定期后的探测步长</li>
</ul>
<h6 id="b）-最大值探测步骤："><a href="#b）-最大值探测步骤：" class="headerlink" title="b） 最大值探测步骤："></a>b） 最大值探测步骤：</h6><p><img src="http://images.wodekouwei.com/tips-net-mars-heartbeat-2019312165138.png" alt="图4-1 自适应心跳计算流程"></p>
<p>自适应心跳计算流程如图4-1所示，经过该流程，会找到必然使心跳失败的curHeart（或者MaxHeart），为了保险起见，我们选择比前一个成功值稍微小一点的值作为后台稳定期的心跳间隔。</p>
<p>影响手机网络测试的因素太多，为了尽量保证测试结果的可靠性，我们使用延迟心跳测试法。在我们重新建立TCP连接后，先使用 短心跳连续成功三次，我们才认为网络相对稳定，可以使用curHeart进行一次心跳测试。图4-2显示了一次有效心跳测试过程。图4-3显示了在没有达到稳定网络环境时，我们会一直使用固定短心跳直到满足三次连续短心跳成功。</p>
<p>使用延迟心跳测试的好处是，可以剔除偶然失败，和网络变化较大的情况（如地铁），使测试结果相对可靠（五次延迟测试确定结论）。同时在网络波动较大的情况，使用短心跳，保证收取消息相对及时。</p>
<h6 id="c）-运行时的动态调整策略-已经按测算心跳稳定值后"><a href="#c）-运行时的动态调整策略-已经按测算心跳稳定值后" class="headerlink" title="c） 运行时的动态调整策略(已经按测算心跳稳定值后)"></a>c） 运行时的动态调整策略(已经按测算心跳稳定值后)</h6><p><strong>NAT超时值算出来后，在维持心跳的过程中的策略</strong></p>
<ol>
<li>无网络、网络时好时坏、偶然失败、NAT超时变小：在后台稳定期发生心跳发生失败后，我们使用延迟心跳测试法测试五次。如果有一次成功，则保持当前心跳值不变；如果五次测试全失败，重新计算合理心跳值。该过程如图4-4所示，有一点需要注意，每个新建的长连接需要先用短心跳成功维持3次后才用successHeart进行心跳。
<img src="http://images.wodekouwei.com/tips-net-mars-heartbeat-2019312165229.png" alt="图4-2 后台稳定态动态调整心跳策略"></li>
<li>NAT超时变大：以周为周期，每周三将后台稳定态调至自适应计算态，使用心跳延迟法往后探测心跳间隔。</li>
<li>successHeart是NAT超时临界值：因为我们现在选择的是一个比successHeart稍小的值作为稳定值，所以在计算过程中可以避开临界值。当运营商在我们后台稳定期将NAT超时调整为我们当前计算值，那么由于我们每周会去向下探索，所以下一周探测时也可以及时调整正确。</li>
</ol>
<h4 id="4-3-5-冗余Sync和心跳"><a href="#4-3-5-冗余Sync和心跳" class="headerlink" title="4.3.5 冗余Sync和心跳"></a>4.3.5 冗余Sync和心跳</h4><p>在用户的一些主动操作以及联网状态改变时，增加冗余Sync和心跳，确保及时收到消息。</p>
<ol>
<li>当用户点亮屏幕的时候，做一次心跳。</li>
<li>当微信切换到前台时，做一次Sync。</li>
<li>联网时重建信令TCP，做一次Sync</li>
</ol>
<h2 id="5-可能存在的风险及预防措施"><a href="#5-可能存在的风险及预防措施" class="headerlink" title="5. 可能存在的风险及预防措施"></a>5. 可能存在的风险及预防措施</h2><h3 id="5-1-DHCP租期因素"><a href="#5-1-DHCP租期因素" class="headerlink" title="5.1 DHCP租期因素"></a>5.1 DHCP租期因素</h3><ol>
<li>问题：根据目前的测试结果显示，安卓不续约到期的IP Bug，会导致TCP连接在不确定的时间点失效，从而会导致一次心跳失败。</li>
<li>预防：统计后台稳定期的心跳成功率，上报给后台。后台可以按地区分网络监控这个指标的波动，并且后台可以根据不同的波动，动态调整某区域特定网络下可选的心跳区间。</li>
</ol>
<h3 id="5-2-其他影响TCP寿命的因素"><a href="#5-2-其他影响TCP寿命的因素" class="headerlink" title="5.2 其他影响TCP寿命的因素"></a>5.2 其他影响TCP寿命的因素</h3><p>是否有遗漏的因素？欢迎各位联系我反馈。</p>
<h2 id="6-附录"><a href="#6-附录" class="headerlink" title="6 附录"></a>6 附录</h2><h3 id="6-1-附录A——NAT超时介绍"><a href="#6-1-附录A——NAT超时介绍" class="headerlink" title="6.1 附录A——NAT超时介绍"></a>6.1 附录A——NAT超时介绍</h3><p>因为 IP v4 的 IP 量有限，运营商分配给手机终端的 IP 是运营商内网的 IP，手机要连接 Internet，就需要通过运营商的网关做一个网络地址转换(Network Address Translation，NAT)。简单的说运营商的网关需要维护一个外网 IP、端口到内网 IP、端口的对应关系，以确保内网的手机可以跟 Internet 的服务器通讯。
<img src="http://images.wodekouwei.com/tips-net-mars-heartbeat-2019312165718.png" alt="NAT 功能由图中的 GGSN 模块实现"></p>
<p>大部分移动无线网络运营商都在链路一段时间没有数据通讯时，会淘汰 NAT 表中的对应项，造成链路中断。下表列出一些已测试过的网络的NAT超时时间(更多数据由于测试条件所限没有测到)：</p>
<table>
<thead>
<tr>
<th>地区/网络</th>
<th>NAT超时时间</th>
</tr>
</thead>
<tbody>
<tr>
<td>中国移动3G和2G</td>
<td>5分钟</td>
</tr>
<tr>
<td>中国联通2G</td>
<td>5分钟</td>
</tr>
<tr>
<td>中国电信3G</td>
<td>大于28分钟</td>
</tr>
<tr>
<td>美国3G</td>
<td>大于28分钟</td>
</tr>
<tr>
<td>台湾3G</td>
<td>大于28分钟</td>
</tr>
</tbody>
</table>
<p>长连接心跳间隔必须要小于NAT超时时间(aging-time)，如果超过aging-time不做心跳，TCP长连接链路就会中断，Server就无法发送Push给手机，只能等到客户端下次心跳失败后，重建连接才能取到消息。</p>
<h3 id="6-2-附录B——安卓DHCP的租期（lease-time）问题"><a href="#6-2-附录B——安卓DHCP的租期（lease-time）问题" class="headerlink" title="6.2 附录B——安卓DHCP的租期（lease time）问题"></a>6.2 附录B——安卓DHCP的租期（lease time）问题</h3><p>目前测试发现安卓系统对DHCP的处理有Bug：</p>
<ol>
<li>DHCP租期到了不会主动续约并且会继续使用过期IP，详细描述见<a href="http://www.net.princeton.edu/android/android-stops-renewing-lease-keeps-using-IP-address-11236.html。这个问题导致的问题表象是，在超过租期的某个时间点（没有规律）会导致IP过期，老的TCP连接不能正常收发数据。并且系统没有网络变化事件，只有等应用判断主动建立新的TCP连接才引起安卓设备重新向DHCP" target="_blank" rel="external">http://www.net.princeton.edu/android/android-stops-renewing-lease-keeps-using-IP-address-11236.html。这个问题导致的问题表象是，在超过租期的某个时间点（没有规律）会导致IP过期，老的TCP连接不能正常收发数据。并且系统没有网络变化事件，只有等应用判断主动建立新的TCP连接才引起安卓设备重新向DHCP</a> Server申请IP租用。</li>
<li>未到租期的一半时间，安卓设备重新向DHCP Server申请IP租用。从目前测试结果来看，这种现象恢复的比较快。</li>
<li>移动2G/3G，联通2G没有抓到DHCP。</li>
<li>美国3G下抓取24小时，没有抓到DHCP。</li>
</ol>
<blockquote>
<p>转自<a href="https://mp.weixin.qq.com/s/ghnmC8709DvnhieQhkLJpA" target="_blank" rel="external">Android微信智能心跳方案</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/12/tips-net-mars-ip-sort/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/12/tips-net-mars-ip-sort/" itemprop="url">
                  微信终端跨平台组件 Mars 系列（三）连接超时与IP&Port排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T15:53:52+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Mars 是微信官方的终端基础组件，是一个使用 C++ 编写的业务无关、跨平台的基础组件。目前在微信 Android、iOS、Windows、Mac、WP 等多个平台中使用。Mars 主要包括以下几个独立的部分：</p>
<ul>
<li>COMM：基础库，包括socket、线程、消息队列、协程等基础工具；</li>
<li>XLOG：通用日志模块，充分考虑移动终端的特点，提供高性能、高可用、安全性、容错性的日志功能；（详情点击：高性能日志模块xlog）</li>
<li>SDT：网络诊断模块；</li>
<li>STN：信令传输网络模块，负责终端与服务器的小数据信令通道。包含了微信终端在移动网络上的大量优化经验与成果，经历了微信海量用户的考验。</li>
</ul>
<p>Mars 系列开始，将为大家介绍 STN（信令传输网络模块）。由于 STN 的复杂性，该模块将被分解为多个篇章进行介绍。本文主要介绍微信中关于 socket 连接及 IP&amp;Port 选择的思考与设计。</p>
<h2 id="你需要知道的TCP连接"><a href="#你需要知道的TCP连接" class="headerlink" title="你需要知道的TCP连接"></a>你需要知道的TCP连接</h2><p>TCP 协议应该是目前使用的最广泛的传输层协议，它提供了可靠的端到端的传输，为应用的设计节省了大量的工作。TCP 建立连接的”三次握手”与连接终止的“四次挥手”也广为人知。在这简单的 connect 调用中，还能做怎样的思考与设计呢？
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int connect(int sockfd, const struct *addr, socklen_t addrlen)</div></pre></td></tr></table></figure></p>
<h3 id="连接的超时重传"><a href="#连接的超时重传" class="headerlink" title="连接的超时重传"></a>连接的超时重传</h3><p>超时与重传是 TCP 协议最核心的部分，在不稳定的移动网络中，超时重传的设计尤为重要。在连接建立的过程中，由于网络本身的不可靠特性，不可避免的需要重传的机制来保障可靠服务。在《TCP/IP详解 卷1》的描述中，在大多数 BSD 实现中，若主动 connect 方没有收到 SYN 的回应，会在第6秒发送第2个 SYN 进行重试，第3个 SYN 则是与第2个间隔24秒。在第75秒还没有收到回应，则 connect 调用返回 ETIMEOUT。</p>
<p>这就意味着，在不能立刻确认失败（例如 unreachable 等）的情况下，需要75秒的时间，才能获得结果。如果真相并不是用户的网络不可用，而是某台服务器故障、繁忙、网络不稳定等因素，那75秒的时间只能尝试1个 IP&amp;Port 资源，对于大多数移动应用而言，是不可接受的。我们需要更积极的超时重传机制！！！</p>
<p>然而，我们并不能修改 TCP 的协议栈，我们只能在应用层进行干预，设计应用层的超时机制。说干就干，这个时候你是否已经在构思新的、应用层的连接超时重传机制了呢？应用层的超时重传，典型做法就是提前结束 connect 的阻塞调用，使用新的 IP&amp;Port 资源进行 connect 重试。但是，我们应该选择怎样的连接超时值呢？4秒？10秒？20秒？30秒？不同的应用场景会有不同的选择。我们来看一下常见的几种场景：</p>
<ul>
<li>连不同 or 网络不可用等</li>
<li>服务器繁忙 or 中间路由故障等</li>
<li>基站繁忙 or 连接信号弱 or 丢包率高等</li>
</ul>
<p>在第一种场景中，连接超时设置不会带来什么区别。在第二种场景中，部分服务器资源或路由不可用，我们希望连接超时能稍微短一些，使得我们能尽快的发现故障，并且通过更换 IP&amp;Port 的方式获得可用资源或路由路径。而第三种场景则是在移动网络中经常遇到的弱网络的场景。在这种场景中，我们更换 IP&amp;Port 资源也是无效的，因此希望连接超时能相对长一些，进行更多的TCP层的重传。（当然，也不是超时越长越好，后面的分析可以看到很多等待时长是效果低微的）</p>
<p>不同的场景对连接超时有不同的需求，然而，我们在程序中并没有很好的方法来区分这些场景。在进行连接超时这个阈值的选择前，我们先来看看，当前主流的 android、iOS 操作系统的连接设计。android 的 TCP 层连接超时重传如下图所示（测试机型为 nexus5，android 4.4）。超时间隔依次为（1，2，4，8，16），第5次重试后32秒返回 ETIMEOUT，总用时63秒。超时设置符合 Linux 的常规设置。
<img src="http://images.wodekouwei.com/tips-net-mars-ip-sort-2019312162610.png" alt="tips-net-mars-ip-sort-2019312162610"></p>
<p>但在不同的机型中，偶尔会出现差异性。如下图 android 抓包（三星 android 4.4）。
<img src="http://images.wodekouwei.com/tips-net-mars-ip-sort-2019312162636.png" alt="tips-net-mars-ip-sort-2019312162636"></p>
<p>iOS 的 connect 超时重传如下图所示。超时间隔依次为（1，1，1，1，1，2，4，8，16，32），总共是67s。
<img src="http://images.wodekouwei.com/tips-net-mars-ip-sort-2019312162711.png" alt="tips-net-mars-ip-sort-2019312162711"></p>
<p>经过 tcpdump 的调研分析后，我们发现：</p>
<ol>
<li>在 iOS 系统中对 connect 的超时重传进行了一定的修改，在 connect 初期使用更积极的策略，以适应移动网络的不稳定特征。而在 android 系统中，connect 超时重传则使用了较为“懒惰”、适用于有线网络的超时重传间隔；</li>
<li>不管什么平台，连接总超时时长都需要1分钟左右，这个时长在大多数移动应用中，都是不符合用户体验要求的；</li>
<li>连接的初始阶段，TCP 超时重传会更积极一些，越到后面，重传间隔越大。</li>
</ol>
<p>因此，在实际的连接超时设置上，我们根据不同的系统特征，结合应用能接受的“用户体验”范围，可以设置不同的连接超时间隔。例如在 iOS 系统中，由于采用了较为积极的超时间隔，我们可以将 connect 调用的超时设置为10s。在10s内，iOS 会自动进行6次的重发。在 android 系统中，系统会在第7秒发起第3次重发，之后需要在第15秒才会重发。在不同的用户体验要求下，应用可以将 connect 的调用超时设置为不同的值。例如也可以设置为10s（意味着给第3次重发3s的等待时间），从而避免无效的等待时长。同时通过更换 IP&amp;Port 后，重新调用 connect 操作的方式，来获得更积极的重发策略，更快的查找到可用的 IP&amp;Port 组合。</p>
<h3 id="连接的终止"><a href="#连接的终止" class="headerlink" title="连接的终止"></a>连接的终止</h3><p>“四次挥手”的连接终止协议已经口熟能详。过程如下图所示。需要关注的是，图中主动关闭的一方会进入 TIME_WAIT 状态，在此状态中通常将停留2倍的 MSL 时长。MSL 时长在不同的操作系统中有不同的设置，通常在30秒到60秒。TIME_WAIT 的数量太多会导致耗尽主动关闭方的 socket 端口和句柄，导致无法再发起新的连接，进而严重影响主动关闭方的并发性能。虽然在实际的使用中，可以通过 tcp_tw_recycle，tcp_tw_reuse，tcp_max_tw_buckets 等方式缓解该问题，但也会带来一些副作用。最好的解决方案是在协议的设计上，尽量的由终端来发起关闭的操作，避免服务器的大量 TIME_WAIT 状态。例如，使用长连接避免频繁的关闭；在短连接的协议设计上，务必加上终止标记（例如 http 头部加上 content-length ）使得可以由终端来发起关闭的操作。
<img src="http://images.wodekouwei.com/tips-net-mars-ip-sort-2019312162922.png" alt="tips-net-mars-ip-sort-2019312162922"></p>
<h3 id="串行连接-VS-并发连接-VS-复合连接"><a href="#串行连接-VS-并发连接-VS-复合连接" class="headerlink" title="串行连接 VS 并发连接 VS 复合连接"></a>串行连接 VS 并发连接 VS 复合连接</h3><p>在上述的连接超时策略中，我们选择10秒的连接超时。这就意味着我们需要10秒的时间来确认一个 IP&amp;Port 组合的 connect 超时。当我们有多个 IP&amp;Port 资源时，遍历的效率偏低。那我们是否能设置 connect 的超时为更短呢？例如4秒。我们知道移动互联网具有不稳定的特征，超时时间设置过短，会导致在弱网络的情况下，connect 总是失败，导致不可用。串行连接的策略在超时选择上，由于需要兼顾高性能与高可用的设计目标，使得该策略是一个相对“慢”的连接策略。</p>
<p>与此相应，我们会想到并发连接的策略。并发连接，同时发起对N个 IP&amp;Port 的连接调用，可以让我们第一时间发现可用的连接，并且还顺带发现了 connect 最快的 IP&amp;Port 配置。并发连接可以一举解决了“高性能”、“高可用”的设计目标，看起来很完美。然而，这个时候，服务端的同学“跳”起来了。在并发连接的策略下，服务器需要提供的连接能力是串行连接的N倍，对服务器连接资源是极大的浪费。同时，并发连接是否会引起连接资源的竞争，从而影响网络正常用户的常规体验，也是个未知的因素。</p>
<p>让我们来回顾串行连接与并行连接的优缺点。</p>
<h4 id="串行连接"><a href="#串行连接" class="headerlink" title="串行连接"></a>串行连接</h4><ul>
<li>资源占用少</li>
<li>无服务器负载问题</li>
<li>超时选择困难</li>
<li>最慢可用</li>
</ul>
<h4 id="并行连接"><a href="#并行连接" class="headerlink" title="并行连接"></a>并行连接</h4><ul>
<li>网络资源竞争</li>
<li>服务器负载高</li>
<li>最快可用</li>
</ul>
<p>那么，有没有一种策略，能同时满足高性能、高可用、低负载的目标呢？在微信的连接设计中，我们使用了”复合连接“的策略。如下图所示。
<img src="http://images.wodekouwei.com/tips-net-mars-ip-sort-2019312163133.png" alt="tips-net-mars-ip-sort-2019312163133"></p>
<p>初始阶段，应用发起对 IP1 &amp;Port1 的 connect 调用。在第4秒的时候，如果第一个 connect 还没有返回，则发起对 IP2 &amp;Port2 的 connect 调用。以此类推，直至发起了5组 IP&amp;Port 的 connect 调用。 </p>
<ul>
<li>对比串行连接与并行连接，复合连接有以下特点：</li>
<li>常规情况下，服务器负载与串行连接策略相同，实现了低负载的目标；</li>
<li>异常情况下，每4s发起新（IP，Port）组合的 connect 调用，使得应用可以快速的查找可用 IP&amp;Port，实现高性能的目标；</li>
<li>在超时时间的选择上，复合方式的“并发”已经实现了高性能、低负载的目标，因此在超时时间的选择上可以相对宽松，以保障高可用为重。</li>
</ul>
<p>综合对比，复合连接能够维持低资源消耗的情况下，能同时实现低负载、高性能、高可用的目标。</p>
<h2 id="微信-IP-amp-Port-排序算法的演进"><a href="#微信-IP-amp-Port-排序算法的演进" class="headerlink" title="微信 IP&amp;Port 排序算法的演进"></a>微信 IP&amp;Port 排序算法的演进</h2><p>在建立连接的调用中，除了超时时间的设置外，IP&amp;Port是连接的最重要参数。IP&amp;Port 的排序、选择对于 connect 的性能也是有着重大的影响。本节主要讨论在已知 IP 列表、Port 列表的情况下，如何排序、组合的问题，而不讨论如何获得就近接入等问题。</p>
<h3 id="IP-amp-Port-的组成"><a href="#IP-amp-Port-的组成" class="headerlink" title="IP&amp;Port 的组成"></a>IP&amp;Port 的组成</h3><p>在微信中，IP有多种来源类型。优先级从上而下分别为：</p>
<ul>
<li>WXDNS IP</li>
<li>DNS IP</li>
<li>Auth IP</li>
<li>Hardcode IP</li>
</ul>
<p>WXDNS IP 是通过微信自建的 DNS 服务获得的IP列表，自建 DNS 对防劫持、有效期控制等有重要作用。DNS IP 则是通过常规的 DNS 解析获得的 IP 列表。Auth IP 是微信动态下发的保底IP列表。而Hardcode IP 则是最终的保底IP列表。总体而言，分为常规IP列表、保底IP列表两个类别。WXDNS IP、DNS IP 为常规列表，Auth IP，Hardcode IP 为保底列表。同时，在组成实际使用的 IP&amp;Port 列表时，由于 WXDNS 与 DNS 的功能近似，因此通常只出现其中一种类型的IP列表。Auth IP 与Hardcode IP 的功能近似，也是同时只能出现两者中的一种类型。 
在 Port 的选择上，微信服务在常规情况下提供2个端口，预防端口被封锁的情况。特别情况下，可以通过配置下发进行端口更新。</p>
<h3 id="IP-amp-Port排序算法（一）：随机组合排序算法"><a href="#IP-amp-Port排序算法（一）：随机组合排序算法" class="headerlink" title="IP&amp;Port排序算法（一）：随机组合排序算法"></a>IP&amp;Port排序算法（一）：随机组合排序算法</h3><p>每个TCP连接都是以 IP&amp;Port 的组合为唯一标识。在 IP&amp;Port 的选择上，我们初步归纳为2个目标：</p>
<ul>
<li>高可用：尽快的找到可用的 IP&amp;Port 资源</li>
<li>高性能：优先使用质量好的 IP&amp;Port</li>
<li>负载均衡：IP的排序算法不带任何偏向因子，避免造成人为的负载不均衡</li>
</ul>
<p>在微信早期的排序选择上，我们使用了一种随机组合的排序算法。即将 WXDNS or DNS IP 列表与 Port 列表进行组合，组合后的结果进行随机排序。在随机排序的结果列表中，使用下述步骤进行排序：</p>
<ol>
<li>选取IP1+Port1；</li>
<li>选取IP2+Port2，尽量使得IP1与IP2不相等，Port1与Port2不相等；</li>
<li>选取IP3+Port3，尽量使得IP3与IP1、IP2都不相等，Port3与Port1、Port2都不相等；</li>
<li>以此类推，形成常规列表。</li>
</ol>
<p>同理，使用 Auth IP or Hardcode IP 列表与 Port 列表的组合，我们按照相同算法生成另外一份保底列表，并将保底列表排序在常规列表的后面，从而组成完整的 IP&amp;Port 列表。随机组合排序的算法有着以下的特点：</p>
<ul>
<li>高性能：每一次尝试都尽量使用完全不同的资源，使得能最快的发现可用资源；</li>
<li>初始随机，从而避免列表顺序的固化；</li>
<li>保底列表在最后，形成最后的保护屏障；</li>
<li>在不同的网络下，维护着不同的资源列表。</li>
</ul>
<p>在使用中，如果发现 IP&amp;Port 访问失败，则在列表中 ban 掉该资源。这里有个小优化，即当 IP1&amp;Port1 的上一次访问成功时，需要连续失败2次才 ban 该资源。目的是为了减小偶然的网络抖动造成的影响。</p>
<p>随机组合排序算法的设计初衷，是为了以最快的速度尝试不同的资源组合，从而快速寻找到可用的资源。然而，在微信的实际使用中，却发现这种算法存在着诸多的问题。例如：</p>
<ul>
<li>网络不可用或网络较大波动情况下，列表被ban的速度较快；</li>
<li>Auth IP or Hardcode IP 列表太容易被访问到：随着常规资源陆续被ban，保底资源总是会被访问到，造成对保底资源的访问量大。保底资源是为了微信服务这不符合保底资源的设计初衷。</li>
<li>当引入复合连接策略后，IP资源不足。这是因为 ban 的策略简单粗暴的丢弃失败的 IP，导致 IP 资源越来越少；</li>
<li>每次缓存超时或列表轮空后，对于新列表没有经验信息可用</li>
</ul>
<p>在随机组合排序算法的基础上，为了解决遇到的新问题，微信使用了新的“以史为鉴”的算法。</p>
<h3 id="IP-amp-Port-排序算法（二）：以史为鉴"><a href="#IP-amp-Port-排序算法（二）：以史为鉴" class="headerlink" title="IP&amp;Port 排序算法（二）：以史为鉴"></a>IP&amp;Port 排序算法（二）：以史为鉴</h3><p>由于复合连接的引入，在每次复合连接的尝试中，微信可以伪“并发”的对N个 IP&amp;Port 进行 connect（微信中目前N=5）。简单的ban丢弃的策略会使得 IP 资源越来越少。 针对这个特点，我们对IP&amp;Port算法进行了以下修改：</p>
<ul>
<li>初始资源列表分为两类列表：常规列表，保底列表，分别使用方案（一）随机组合排序算法生成初始顺序；</li>
<li>对每次复合连接使用的列表，规定5个资源的组成是4个常规资源+1个保底资源，并且保底资源在最后（完全无法获取常规资源的情况除外）。这种资源组成方式一方面解决了“保底资源太容易被访问到”的问题，一方面也保障了保底资源的作用；</li>
<li>在不同网络中，分别记录每个 IP&amp;Port 的使用情况，并根据使用记录进行评分、排序；</li>
<li>区分连续记录：对每个 IP&amp;Port 的更新，10秒内的连续成功或失败，不进行使用情况的记录。这种处理方式一方面是为了避免网络不可用或网络出现较大波动时，IP资源被过快的错误标记；一方面也避免失败历史被快速的覆盖；</li>
<li>最近的8条使用记录中，如果有超过3条失败记录，且最新一次失败记录时间为10分钟内，则本次排序ban该记录。这种处理方式的目的是避免历史分数较高的 IP&amp;Port 在突然出现故障时很难被排序算法排除的问题；</li>
<li>无历史的记录使用随机评分排序。</li>
</ul>
<p>通过上述方法，我们保证了保底资源不会被轻易访问到，解决了列表被快速标记的问题，同时也保证了历史记录好的资源在出现故障时也能被快速替换。</p>
<h3 id="IP-amp-Port-排序算法（三）：遗忘历史"><a href="#IP-amp-Port-排序算法（三）：遗忘历史" class="headerlink" title="IP&amp;Port 排序算法（三）：遗忘历史"></a>IP&amp;Port 排序算法（三）：遗忘历史</h3><p>“以史为鉴”的方案在微信中使用了一段时间，看起来运行良好。直至某一天，微信的部分服务集群出现了故障。虽然微信客户端快速的切换到可用的服务器资源，但当故障服务器恢复后，微信客户端却迟迟没有分流到已恢复服务的集群，导致部分微信服务器负载过高，而部分微信服务器却负载较低的情况。通过分析，发现“以史为鉴”的排序方案存在着一些问题：</p>
<ul>
<li>初始阶段排在前面的资源容易获得较多的成功记录，从而分数始终维持在较高的水平；</li>
<li>出灾情况下，故障机器由于有失败记录，使得很难获得“被原谅”的机会，从而也很难更新使用历史；</li>
<li>采用了无历史记录随机评分，破坏了原有的“相邻记录尽量不相同”的随机性设计；
因此，好的 IP&amp;Port 排序算法，不仅应该快速的发现可用的资源，使得在出灾情况下能快速的响应，同时，也应该具备一定的“遗忘性”、“容灾性”，使得灾情恢复后能较快的发现“灾情恢复”这一事实，并且进行重排序，使得服务器资源得到更合理的使用。在综合考虑“以史为鉴”和“遗忘历史”后，新的 方案具有以下特征：</li>
<li>内存历史、文件历史双层记录历史：反映资源使用的近期情况及历史情况；</li>
<li>初始化状态：每次进程重启或网络切换后，从文件历史中“压缩”出内存历史作为初始状态；</li>
<li>旁路检测：额外更新历史的渠道，更有助于挑选高性能的资源，并且帮助“灾情恢复”的资源获得使用的机会；</li>
<li>文件历史的遗忘性：文件历史每24小时强制刷新，避免高分数的记录长期“占有”队列；</li>
<li>无历史、有历史的混合排序。</li>
</ul>
<p>具体实现查看 Mars 源代码中的 simple_ipport_sort。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>连接是信令传输的前提，一个简单的连接操作蕴含着不少的优化空间。在连接超时的选择上，我们要兼顾性能与可用性，过短的连接超时可能导致弱网络下的低可用性，但过长的连接超时又影响用户体验。在 STN 中，我们结合系统本身的 TCP 连接重传特性，进行了相应的设计考量。即使如此，串行的连接方案仍然不能满足高性能的需求。并发连接的方案获得高性能的同时，也带来了服务器负载剧增的损失。综合考虑下，STN 使用了“复合连接”的方案，获得高性能的同时，也保证通常情况下的服务器低负载。</p>
<p>IP&amp;Port 是连接的最重要资源，IP&amp;Port 的排序选择是连接过程的重要部分。在微信的实际使用中，我们依次使用了“随机组合”、“以史为鉴”、“遗忘历史”三种方案，综合的考虑了查找性能、移动互联网的不稳定性、容灾及容灾恢复等。</p>
<p>连接超时、连接策略及 IP&amp;Port 排序是连接的是三个重要组成部分，相关的方案也随着微信实践在不断的发展中。相信在不同的应用场景中，我们可能会遇到更多的不同问题及需求。随着Mars的开源，也能有机会参考、吸收其他应用中的实战经验，使得网络优化持续的深入。</p>
<blockquote>
<p>转自<a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286458&amp;idx=1&amp;sn=320f690faa4f97f7a49a291d4de174a9&amp;chksm=8334c3b8b4434aae904b6d590027b100283ef175938610805dd33ca53f004bd3c56040b11fa6#rd" target="_blank" rel="external">微信终端跨平台组件 Mars 系列（三）连接超时与IP&amp;Port排序</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/12/tips-net-mars-timeout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/12/tips-net-mars-timeout/" itemprop="url">
                  微信终端跨平台组件 mars 系列(二) - 信令传输超时设计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T15:53:08+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>mars 是微信官方使用 C++ 编写的业务性无关、平台性无关的终端基础组件，目前在微信 Android、iOS、Windows、Mac、Windows Phone 等多个平台中使用，并正在筹备开源，它主要包含以下几个独立的部分：</p>
<ol>
<li>COMM：基础库，包括 socket、线程、消息队列、协程等基础工具；</li>
<li>XLOG：通用日志模块，充分考虑移动终端的特点，提供高性能、高可用、安全性、容错性的日志功能；（详情点击：高性能日志模块xlog ）</li>
<li>SDT：网络诊断模块；</li>
<li>STN：信令传输网络模块，负责终端与服务器的小数据信令通道。包含了微信终端在移动网络上的大量优化经验与成果，经历了微信海量用户的考验。</li>
</ol>
<p>本篇文章将为大家介绍 STN（信令传输网络模块），由于 STN 的复杂性，该模块将被分解为多个篇章进行介绍，本文主要内容为微信中关于读写超时的思考与设计。</p>
<h2 id="读写超时与设计目标"><a href="#读写超时与设计目标" class="headerlink" title="读写超时与设计目标"></a>读写超时与设计目标</h2><h3 id="TCP-IP中的超时设计"><a href="#TCP-IP中的超时设计" class="headerlink" title="TCP/IP中的超时设计"></a>TCP/IP中的超时设计</h3><p>微信信令通信主要使用 TCP/IP 协议，数据经过应用层、传输层、网络层、链路层（见图1）。其中，链路层与传输层，协议提供了超时重传的机制。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-201931215560.png" alt="图1 使用 TCP/IP 协议"></p>
<h3 id="链路层的超时与重传"><a href="#链路层的超时与重传" class="headerlink" title="链路层的超时与重传"></a>链路层的超时与重传</h3><p>在链路层，一般使用混合自动重传请求（即 HARQ）。HARQ 是一种结合 FEC（前馈式错误修正）与 ARQ（自动重传请求）的技术，原理如图2所示。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312155629.png" alt="图2 HARQ 原理"></p>
<p>通过使用确认和超时这两个机制，链路层在不可靠物理设备的基础上实现可靠的信息传输。这个方案需要手机和 RNC 都支持，目前在 EDGE、HSDPA、HSUPA、UMTS和 LTE 上都已实现支持。</p>
<h3 id="传输层的超时与重传"><a href="#传输层的超时与重传" class="headerlink" title="传输层的超时与重传"></a>传输层的超时与重传</h3><p>传输层（即 TCP 层）提供可靠的传输，然而，TCP 层依赖的链路本身是不可靠的，TCP 是如何在不可靠的环境中提供可靠服务的呢？答案是超时和重传。TCP 在发送数据时设置一个定时器，当定时器溢出还没有收到 ACK，则重传该数据。因此，超时与重传的关键之处在于如何决定定时器间隔与重传频率。</p>
<p>传统 Unix 实现中，定时器的间隔取决于数据的往返时间（即 RTT），根据 RTT 进行一定的计算得到重传超时间隔（即 RTO）。由于网络路由、流量等的变化，RTT 是经常发生变化的，RTT 的测量也极为复杂（平滑算法、Karn 算法、Jacbson 算法等）。在《TCP/IP详解》中，实际测量的重传机制如图3所示，重传的时间间隔，取整后分别为1、3、6、12、24、48和多个64秒。这个倍乘的关系被称为“指数退避”。</p>
<p><img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312155711.png" alt="图3 实际测量的重传机制"></p>
<p>在移动终端中，RTO 的设计以及重试频率的设计是否与传统实现一致呢？对此我们进行了实测，实测数据如下：</p>
<p>图4所示为OPPO手机TCP超时重传的间隔，依次为[ 0.25s，0.5s，1s，2s，4s，8s，16s，32s，64s，64s，64s …]：
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312155757.png" alt="图4 OPPO 手机 TCP 超时重传间隔"></p>
<p>而 SamSung 中 TCP 超时重传的间隔依次为[0.42s, 0.9s, 1.8s, 3.7s, 7.5s, 15s, 30s, 60s, 120s, 120s …]，见图5。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312155816.png" alt="图5 三星手机 TCP 超时重传间隔"></p>
<p>经过多次实际测试我们可以看出虽然由于不同厂商的 Android 系统实现，RTO 的值可能会有不同的设定，但都基本符合“指数退避”原则。</p>
<p>接下来再看 iOS 系统中，TCP RTO 的实验数据，图6所示为实验中第一次的数据[ 1s，1s，1s，2s，4.5s，9s，13.5s，26s，26s … ]。</p>
<p><img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312155855.png" alt="图6 iOS 系统 TCP RTO 第一次实验数据"></p>
<p>上面的数据看起来并不完全符合指数退避，开始阶段的重试会较为频繁且 RTO 最终固定在 26s 这一较小的值上。</p>
<p>进行第二次测试后发现数据有了新的变化[1s，1s，1s，2s，3.5s，8.5s，12.5s，24s，24s …]，如图7所示。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312155936.png" alt="图7 iOS 系统 TCP RTO 第二次实验数据"></p>
<p>RTO 终值由26秒缩减至24秒，最终经过多次测试并未发现 iOS 中 TCP RTO 的规律，但可以看出 iOS 确实采用了较为激进的超时时间设定，对重试更为积极。</p>
<h3 id="读写超时的目标"><a href="#读写超时的目标" class="headerlink" title="读写超时的目标"></a>读写超时的目标</h3><p>通过上述的调研与实验，可以发现在 TCP/IP 中，协议栈已经帮助我们进行了超时与重传的控制。并且在 Android、iOS 的移动操作系统中进行了优化，使用了更为积极的策略，以适应移动网络不稳定的特征。</p>
<p>那是否意味着我们的应用层已经不需要超时与重传的控制了呢？其实不然。在链路层，HARQ 提供的是节点之间每一数据帧的可靠传输；在传输层，TCP 超时重传机制提供的是端与端之间每个 TCP 数据包的可靠传输；同理，在微信所处的应用层中，我们仍然需要提供以“请求”为粒度的可靠传输。</p>
<p>那么，应用层的超时重传机制应该提供怎样的服务呢？</p>
<p>首先，我们来看一下应用层重传的做法。在应用层中，重传的做法是：断掉当前连接，重新建立连接并发送请求。这种重传方式能带来怎样的作用呢？回顾 TCP 层的超时重传机制可以发现，当发生超时重传时，重传的间隔以“指数退避”的规律急剧上升。在 Android 系统中，直到16分钟，TCP 才确认失败；在 iOS 系统中，直到1分半到3分半之间，TCP 才确认失败。这些数值在大部分应用中都是不为“用户体验”所接受的。因此，应用层的超时重传的目标首先应是：
<strong>在用户体验的接受范围内，尽可能地提高成功率</strong>
尽可能地增加成功率，是否意味着在有限的时间内，做尽可能多的重试呢？其实不然。当网络为高延迟/低速率的网络时，较快的应用层重传会导致“请求”在这种网络下很难成功。因此，应用层超时重传的目标二：
<strong>保障弱网络下的可用性</strong>
TCP连接是有固定物理线路的连接，当已 Connect 的线路中，如果中间设备出现较大波动或严重拥塞，即使在限定时间内该请求能成功，但带来的却是性能低下，反应迟钝的用户体验。通过应用层重连，期待的目标三是：
<strong>具有网络敏感性，快速的发现新的链路</strong></p>
<p>我们总结应用层超时重传，可以带来以下作用：</p>
<ol>
<li>减少无效等待时间，增加重试次数：当 TCP 层的重传间隔已经太大的时候，断连重连，使得 TCP 层保持积极的重连间隔，提高成功率；</li>
<li>切换链路：当链路存在较大波动或严重拥塞时，通过更换连接（一般会顺带更换IP&amp;Port）获得更好的性能。</li>
</ol>
<h2 id="微信读写超时"><a href="#微信读写超时" class="headerlink" title="微信读写超时"></a>微信读写超时</h2><h3 id="方案一：总读写超时"><a href="#方案一：总读写超时" class="headerlink" title="方案一：总读写超时"></a>方案一：总读写超时</h3><p>在TCP层的超时重传设计中，超时间隔取决于RTT，RTT即TCP包往返的时间。同理，在微信的早期设计中，我们分析应用层“请求”的往返时间，将其RTT分解为：</p>
<ul>
<li>请求发送耗时 - 类比TCP包传输耗时；</li>
<li>响应信令接收耗时 - 类比ACK传输耗时；</li>
<li>服务器处理请求耗时 - TCP接收端接收和处理数据包的时间相对固定，而微信服务器由于信令所属业务的不同，逻辑处理的耗时会差异明显，所以无法类比；</li>
<li>等待耗时 - 受应用中请求并发数影响。</li>
</ul>
<p>因此，我们提出了应用层的总读写超时如图8所示，最低网速根据不同的网络取不同的值。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-201931216249.png" alt="图8 应用层的总读写超时"></p>
<h3 id="方案二：分步的读写超时"><a href="#方案二：分步的读写超时" class="headerlink" title="方案二：分步的读写超时"></a>方案二：分步的读写超时</h3><p>在实际的使用过程中，我们发现这仅仅是一个可用的方案，并不是一个高性能的解决方案：超时时长的设置使用了差网络下、完整的完成单次信令交互的时间估值。这使得超时时间过长，在网络波动或拥塞时，无法敏感地发现问题并重试。进一步分析可以发现，我们无法预知服务器回包的大小，因此使用了最大的回包进行估算（微信中目前最大回包可到 128KB）。然而，TCP 传输中当发送数据大于 MSS 时，数据将被分段传输，分段到达接收端后重新组合。如果服务器的回包较大，客户端可能会收到多个数据段。因此，我们可以对首个数据分段的到达时间进行预期，从而提出首包超时，如图9所示。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-201931216413.png" alt="图9 首包超时计算"></p>
<p>首包超时缩短了发现问题的周期，但是我们发现如果首个数据分段按时到达，而后续数据包丢失的情况下，仍然要等待整个读写超时才能发现问题。为此我们引入了包包超时，即两个数据分段之间的超时时间。因为包包超时在首包超时之后，这个阶段已经确认服务器收到了请求，且完成了请求的处理，因此不需要计算等待耗时、请求传输耗时、服务器处理耗时，只需要估算网络的 RTT。</p>
<p>在目前方案中，使用了不同网络下的固定 RTT。由于有了“首包已收到”的上下文，使得包包超时的间隔大大缩短，从而提高了对网络突然波动、拥塞、突发故障的敏感性，使得应用获得较高的性能。</p>
<h3 id="方案三：动态的读写超时"><a href="#方案三：动态的读写超时" class="headerlink" title="方案三：动态的读写超时"></a>方案三：动态的读写超时</h3><p>在上述的方案中，总读写超时、首包超时都使用了一些估值，使得这两个超时是较大的值。假如我们能获得实时的动态网速等，我们能获得更好的超时机制，如图10所示。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312161353.png" alt="图10 实时动态网速下的超时估算"></p>
<p>但是，理想是丰满的，现实是残酷的：</p>
<ul>
<li>动态网速需要通过工具方法测定，实时性要求高，并且要考虑网络波动的影响；</li>
<li>服务器动态耗时需要服务器下发不同业务信令的处理耗时；</li>
<li>真实回包大小则只能靠服务器通知。</li>
</ul>
<p>上述的三种途径对客户端和服务器都是巨大的流量、性能的消耗，所以动态化这些变量看起来并不可行。</p>
<p>因此，这里需要换个角度思考动态优化，手机的网络状况可以大概地归为优质、正常、差三种情况，针对三种网络状况进行不同程度的调整，也是动态优化的一种手段。这里选择优质网络状况进行分析：</p>
<ul>
<li>如何判定网络状况好？网速快、稳定，网络模块中与之等价的是能够短时间完成信令收发，并且能够连续长时间地完成短时间内信令收发。</li>
<li>即使出现网络波动，也可以预期会很快恢复。
<img src="http://images.wodekouwei.com/tips-net-mars-timeout-2019312161536.png" alt="图11 优质网络状况优化"></li>
</ul>
<p>根据对网络状况好的分析，我们可以做出这样的优化（如图11所示）：</p>
<ul>
<li>将客户端网络环境区分为优良（Excellent）、评估（Evaluating）两种状态；</li>
<li>网速快、稳定就是条件1，信令失败或网络类型切换是条件2。</li>
</ul>
<p>进入Exc状态后，就缩短信令收发的预期，即减小首包超时时间，这样做的原因是我们认为用户的网络状况好，可以设置较短的超时时间，当遇到网络波动时预期它能够快速恢复，所以可以尽快超时然后进行重试，从而改善用户体验。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>虽然 TCP/IP 协议栈中的链路层、传输层都已经提供了超时重传，保障了传输的可靠性。但应用层有着不同的可靠性需求，从而需要额外的应用层超时重传机制来保障应用的高性能、高可用。应用层超时重传的设计目标，笔者从自身经验出发，总结为：</p>
<ul>
<li>在用户体验的接受范围内，尽可能地提高成功率；</li>
<li>保障弱网络下的可用性；</li>
<li>具有网络敏感性，快速地发现新的链路。</li>
</ul>
<p>依从这些目标，mars STN 的超时重传机制在使用中不断的精细化演进，使用了包含总读写超时、首包超时、包包超时、动态超时等多种方案的综合。即使如此，STN 的超时重传机制也有着不少的缺点与局限性，例如相对适用于小数据传输的信令通道、局限于一来一回的通信模式等。mars STN 也会不断发现新的问题持续演进，并且所有的演进都将在微信的海量用户中进行验证。同时也期待随着 mars STN 的开源，能收获更多、更广的经验交流、问题反馈、新想法的碰撞等。</p>
<blockquote>
<p>转自<a href="https://mp.weixin.qq.com/s/PnICVDyVuMSyvpvTrdEpSQ?" target="_blank" rel="external">微信终端跨平台组件 mars 系列(二) - 信令传输超时设计</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/12/tips-net-applicationlayer-diff/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/12/tips-net-applicationlayer-diff/" itemprop="url">
                  tips-net-applicationlayer-diff
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-12T15:09:49+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="I-协议优化演进"><a href="#I-协议优化演进" class="headerlink" title="I. 协议优化演进"></a>I. 协议优化演进</h3><h4 id="1-带宽与拥塞"><a href="#1-带宽与拥塞" class="headerlink" title="1. 带宽与拥塞"></a>1. 带宽与拥塞</h4><p><strong>现状</strong></p>
<p>目前的网络基建越来越好，因此带宽的已经不再是瓶颈， 但是由于相关协议(如TCP)的拥塞窗口(CWND, congestion window)控制算法，很多时候并没有将带宽有效的利用，因此更有效的利用带宽是一个优化方向，特别针对视频、游戏等领域。</p>
<p><strong>应对</strong></p>
<ul>
<li><strong>QUIC:</strong> 基于UDP，QUIC可以支持无序的递交，因此通常单个丢包最多只会影响1个请求stream，并且QUIC中一定程度上拆分拥塞窗口来更好的适配多个多路复用的连接，来尽可能的利用带宽，目前已经在Youtube以及一些Google通用库(如字体库)上应用</li>
<li><strong>HTTP:</strong> 通过同时建立多个连接通道，由于每个通道有单独的拥塞窗口保证一个丢包最多只拥塞一个连接通道</li>
<li><strong>BBR:</strong> Google推出的全新的阻塞拥塞控制算法，从根本上解决该问题，通过交替测量带宽和激进的估算算法尽可能的占满带宽与降低延迟（此方式极大的提高了带宽利用率），目前已经在Youtube上应用</li>
</ul>
<p><strong>存在该缺陷的协议</strong></p>
<ul>
<li><strong>TCP:</strong> 由于采用”加性增，乘性减”的拥塞控制算法，错误的将网络中的错误丢包也认为是拥塞丢包，导致拥塞窗口被收敛的很小，带宽无法有效利用</li>
<li><strong>SPDY:</strong> 由于SPDY基于TCP，因此存在TCP相同的缺陷问题，并且虽然SPDY采用了多路复用，也做个各类优化，但是由于一个TCP连接只有一个拥塞窗口，因此一个请求stream丢包，就会导致整个通道被阻塞</li>
</ul>
<h4 id="2-握手的N-RTT的开销"><a href="#2-握手的N-RTT的开销" class="headerlink" title="2. 握手的N-RTT的开销"></a>2. 握手的N-RTT的开销</h4><p><strong>现状</strong></p>
<p>目前TCP与SSL/TLS(1.0,1.1,1.2)，每次建连需要TCP三次握手+安全握手需要: <code>4~5-RRT</code>，导致建连效率低下，Google、Facebook、Tencent(Wechat)等公司推出了各类优化策略。</p>
<p><strong>应对</strong></p>
<ul>
<li><strong>TLS1.3:</strong> 安全握手提出了0-RTT草案</li>
<li><strong>QUIC:</strong> 通过实现自己的安全模块，整个握手过程(TCP + TLS)采用全新的0-RTT方案，并计划当完成时适配到TLS1.3中</li>
<li><strong>Proxygen:</strong> Facebook基于QUIC的0-RTT协议进行优化，保证安全握手最多只有1-RTT，并运用在TCP中 ，并将贡献各类优化成果给TLS1.3</li>
<li><strong>mmtls:</strong> Wechat基于TLS1.3草案中的0-RTT，进行优化推出自己的mmtls，其对于长连接保障安全握手1-RTT，对于短连接安全握手尽可能使用0-RTT</li>
</ul>
<p><strong>存在该缺陷的协议</strong></p>
<ul>
<li><strong>SSL、TLS1.3之前版本:</strong>  在TLS1.2中，需要2~1-RTT(全握手需要2-RTT)</li>
</ul>
<h4 id="3-冗余数据"><a href="#3-冗余数据" class="headerlink" title="3. 冗余数据"></a>3. 冗余数据</h4><p><strong>现状</strong></p>
<p>通常的一般的HTTP请求，每次请求header基本上没什么变化；在一些情况下多个页面使用相同静态资源(js、logo等)，却每次都重复下载。</p>
<p><strong>应对</strong></p>
<ul>
<li><strong>SPDY:</strong> 采用<a href="http://zh.wikipedia.org/wiki/DEFLATE" target="_blank" rel="external">DEFLATE</a>对请求头/响应头进行压缩</li>
<li><strong>HTTP/2:</strong> 采用<a href="http://http2.github.io/http2-spec/compression.html" target="_blank" rel="external">HPACK</a>算法对请求头/响应头进行压缩，并且通讯双方各自cache一份header fields表，避免了重复header的传输</li>
<li><strong>QUIC:</strong> 目前版本采用<a href="http://http2.github.io/http2-spec/compression.html" target="_blank" rel="external">HPACK</a>算法对请求头/响应头进行压缩</li>
<li><strong>HTTP/1.1、HTTP/2:</strong> 支持<code>Cache-Control</code>用于控制资源有效时间,支持<code>Last-Modified</code>来控制资源是否可复用</li>
<li><strong>Facebook geek方案:</strong>  将<code>expiration time</code>全部设置为1年，所有的资源请求链接，都采用概念性的连接(在请求链接后加上资源名的md5，再做mapping)(只要资源不变化链接就不变化)，保证已下载资源能被有效利用的同时，避免重复检测资源有效性</li>
<li><strong>浏览器优化:</strong> Facebook联系Chrome与Firefox，针对复用资源可复用检测频率进行调整(如firefox支持在<code>cache-control</code>中的<code>immutable</code>关键字表示资源不可变不用重复检测)</li>
</ul>
<p><strong>存在该缺陷的协议</strong></p>
<ul>
<li><strong>HTTP/1:</strong> 请求头未做压缩，不支持<code>Cache-Control</code>与<code>Last-Modified</code>因此存在冗余资源重复下载问题</li>
<li><strong>HTTP/1.1:</strong> 请求头未做压缩</li>
</ul>
<h4 id="4-预准备"><a href="#4-预准备" class="headerlink" title="4. 预准备"></a>4. 预准备</h4><ul>
<li><strong>Taobao:</strong> DNS-Prefetch、Preconnect、Prefetch、Flush HTML early、PreRender</li>
<li><strong>SPDY、HTTP/2、QUIC:</strong>: 允许服务端主动推服务端认为客户端需要的静态资源</li>
</ul>
<h4 id="5-负载均衡、超时策略优化与其他"><a href="#5-负载均衡、超时策略优化与其他" class="headerlink" title="5. 负载均衡、超时策略优化与其他"></a>5. 负载均衡、超时策略优化与其他</h4><ul>
<li><strong>负载均衡:</strong> 收益较小的长连接，带来服务端没必要的性能开销</li>
<li><strong>超时策略:</strong> 策略性的调整建连与维连时的超时重连的频率、时间、IP/端口，来应对弱网状况，何时快速放弃节约资源(无网状态)，何时找到可用资源快速恢复连接(被劫持、服务器某端口/IP故障、基站繁忙、连接信号弱、丢包率高)</li>
<li><strong>策略性阻塞:</strong> 根据网络情况、请求数目动态调整连接数来保证吞吐量与稳定性（如SPDY、HTTP/2、QUIC中的多路复用）</li>
<li><strong>DNS:</strong> 结合TTL有效管理本地DNS缓存的有效时间、以及缓存大小来减少DNS查询的阻塞，以及可以通过HTTPDNS优化DNS请求的线路以及来避免DNS被篡改等问题(如果使用okhttp3，可以指定DNS，并且可以为请求设定缓存大小与时间，可以很轻易的实现自己的HTTPDNS)</li>
</ul>
<h3 id="II-常见协议区分"><a href="#II-常见协议区分" class="headerlink" title="II. 常见协议区分"></a>II. 常见协议区分</h3><h4 id="1-TCP"><a href="#1-TCP" class="headerlink" title="1. TCP"></a>1. TCP</h4><blockquote>
<p>关于TCP窗口的研究与学习，请移步<a href="/tcp-window/">TCP窗口</a></p>
</blockquote>
<p>目前应用最广泛的可靠的、有序的、自带问题校验修复(<a href="https://en.wikipedia.org/wiki/Error_detection_and_correction" target="_blank" rel="external">error-checked</a>)、传输协议，通常情况下发送端与接收端通过TCP协议来保障数据的可靠到达，中间层通过IP协议来路由数据的传递。</p>
<p><img src="http://images.wodekouwei.com/tips-net-applicationlayer-diff-2019312152553.png" alt="tips-net-applicationlayer-diff-2019312152553"></p>
<ul>
<li><strong>建连:</strong> 通过三次握手，保障连接已可靠连接</li>
<li><strong>超时重试:</strong> 通过连接超时重试、读写超时重试机制，来保障连接的稳定性</li>
<li><strong>拥塞控制:</strong> 通过”加性增，乘性减”算法，来保障尽量少的报文传输尽量多的数据的同时，减少丢包重传的概率</li>
<li><strong>校验和:</strong> 通过对TCP/IP头进行”校验和”检查，来保障传输数据与地址信息的可靠</li>
<li><strong>有序性:</strong> 通过”序列号”来鉴别每个字节数据，保证接收端能够有序的重建传输数据，以及校验数据完整性</li>
<li><strong>应答机制:</strong> 每次接收端会发送Acks(Acknowledgements)给发送端告知数据以被接收</li>
<li><strong>断连:</strong> 通过四次挥手，保障连接已可靠断开</li>
</ul>
<h4 id="2-HTTP"><a href="#2-HTTP" class="headerlink" title="2. HTTP"></a>2. HTTP</h4><p><strong><code>HTTP1.1</code> vs <code>HTTP1.0</code></strong></p>
<ul>
<li><strong>更灵活缓存处理:</strong> 引入Etag(Entity tag)等目前常用的缓存相关策略</li>
<li><strong>优化带宽使用:</strong> 引入<code>range</code>头域，支持206(Partial Content)，用于数据断点续传。</li>
<li><strong>错误机制更完善:</strong> 引入24个错误状态码，如409(Conflict)请求资源与当前状态冲突； 410(Gone)资源在服务器上被永久删除</li>
<li><strong>Host头处理:</strong> 请求头中必须带上<code>host</code>，否则会报400 Bad Request，为了支持一台服务器上有多台虚拟主机，因此通常一个IP对应了多个域名</li>
<li><strong>长连接:</strong> 默认<code>Connection: keep-alive</code>，以复用已建连通道，不像<code>http1.0</code>每个请求都需要重新创建</li>
</ul>
<h4 id="3-HTTPS"><a href="#3-HTTPS" class="headerlink" title="3. HTTPS"></a>3. HTTPS</h4><p>1994年由 <strong>网景</strong> 提出，并应用在网景导航者浏览器中。最新的HTTPS协议在2000年5月公布的<code>RFC 2818</code>正式确定。</p>
<p>HTTPS协议是基于TLS(Transport Layer Security)/SSL(Secure Sockets Layer)对数据进行加密校验，保障了网络通信中的数据安全。</p>
<p>在当前大陆的网络环境而言，是有效避免运营商劫持的手段。</p>
<p><img src="http://images.wodekouwei.com/tips-net-applicationlayer-diff-2019312152610.png" alt="image_1b8ji5se91a1kvn431umcc2vk9.png-44.3kB"></p>
<ul>
<li><strong>SSL与TLS:</strong> 早期HTTPS是通过SSL对数据验证加密，后SSL逐渐演变为现在的TLS，所以大多数为了有效的支持加密，都同时支持了SSL与STL</li>
<li><strong>TLS提高了SSL:</strong> 虽然最早的TLS1.0与SSL3.0非常类似，但是TLS采用HMAC(keyed-Hashing for Message Authentication Code)算法对数据验证相比SSL的MAC(Message Authentication Code)算法会更难破解，并且在其他方面也有一些小的改进</li>
<li><strong>请求端口:</strong> 443</li>
</ul>
<h4 id="4-SPDY"><a href="#4-SPDY" class="headerlink" title="4. SPDY"></a>4. SPDY</h4><blockquote>
<p>读音speedy</p>
</blockquote>
<p>是谷歌开发为了加快网页加载速度的网络协议。</p>
<p>SPDY兼容性: <a href="http://caniuse.com/#feat=spdy" target="_blank" rel="external">http://caniuse.com/#feat=spdy</a></p>
<p><img src="http://images.wodekouwei.com/tips-net-applicationlayer-diff-2019312152616.png" alt="image_1b8jj8l511lag13eslpm1al918krm.png-23.8kB"></p>
<ul>
<li><strong>采用多路复用(multiplexing):</strong> 多个请求stream共享一个tcp连接， 降低延时、提高带宽利用率</li>
<li><strong>请求优先级:</strong> 允许给每个请求设置优先级，使得重要的请求得到优先响应</li>
<li><strong>TLS/SSL的加密传输:</strong> 强制要求使用TLS/SSL提高数据安全可靠性</li>
<li><strong>压缩<code>请求头/响应头</code>:</strong> 通过DEFLATE或gzip算法进行对<code>请求头/响应头</code>进行压缩</li>
<li><strong>支持Server Push:</strong> 允许服务端主动的推送资源(js、css)给客户端，当分析获知客户端将会需要时，以此利用起空闲带宽</li>
<li><strong>支持Server Hints:</strong> 允许服务端可以在客户端还没有发现将需要哪些资源的时候，主动通知客户端，以便于客户端实现准备好相关资源的缓存</li>
</ul>
<h4 id="5-HTTP-2"><a href="#5-HTTP-2" class="headerlink" title="5. HTTP/2"></a>5. HTTP/2</h4><blockquote>
<p>HTTP/2基于SPDY设计</p>
</blockquote>
<p><img src="http://images.wodekouwei.com/tips-net-applicationlayer-diff-2019312152623.png" alt="image_1b90ik3e01di41tgr16hc12ks19uvp.png-129.5kB">
<img src="http://images.wodekouwei.com/tips-net-applicationlayer-diff-2019312152632.png" alt="image_1b8jku3ol1rbveu4es1tp8rk61j.png-125kB"></p>
<p><strong>HTTP/2 vs SPDY</strong></p>
<ul>
<li><strong>SSL/TLS:</strong> SPDY强制使用SSL/TLS，HTTP/2非强制(但是部分浏览器(如Chrome)不允许，所以目前如果使用HTTP/2最好都配置SSL/TLS)</li>
<li><strong>消息头压缩算法:</strong> HTTP/2消息头压缩算法采用<a href="http://http2.github.io/http2-spec/compression.html" target="_blank" rel="external">HPACK</a>，SPDY采用<a href="http://zh.wikipedia.org/wiki/DEFLATE" target="_blank" rel="external">DEFLATE</a>，一般情况下HPACK的压缩率会高于DEFLATE</li>
<li><strong>传输格式:</strong> HTTP/2传输采用二进制而非文本，因此HTTP/2中的基本单位是帧, 文本形式众多很难权衡健壮、性能与复杂度，二进制弥补了这个缺陷，并且是无序的帧，最终根据头帧重新组装</li>
<li><strong>继承与优化:</strong> HTTP/2继承并优化了SPDY的多路复用与Server Push</li>
</ul>
<h4 id="6-QUIC"><a href="#6-QUIC" class="headerlink" title="6. QUIC"></a>6. QUIC</h4><ul>
<li>发音<code>quick</code></li>
<li>QUIC 参考了HTTP/2与SPDY</li>
<li>Google在2013年10月第一次在IETF展示QUIC, 2016年7月启动工作群</li>
<li>可靠的，多路复用的基于UDP的网络协议，内置安全加密模块，低延迟、运行在用户空间、开源的新一代网络协议。Google计划在完成后将其服务于所有的Google服务。</li>
</ul>
<p><img src="http://images.wodekouwei.com/tips-net-applicationlayer-diff-2019312152640.png" alt="">
<img src="http://images.wodekouwei.com/tips-net-applicationlayer-diff-2019312152646.png" alt=""></p>
<ul>
<li><strong>减少建连延迟:</strong> 从未访问过服务的情况下1-RTT，其他的可以立马开始传输数据(0-RTT)</li>
<li><strong>拥塞控制:</strong> 提升TCP Cubic拥塞控制</li>
<li><strong>HOL阻塞:</strong> 消除多路复用中的HOL阻塞(head-of-line blocking)</li>
<li><strong>更少的帧消耗:</strong> Quic数据包包含更少的帧，因此更多的数据包可以携带数据</li>
<li><strong>提升丢包重试:</strong> 丢包重试时使用新的序列号以及采用重新加密</li>
<li><strong>安全加密:</strong> 内置的加密模块(支持SNI，因此支持一个IP部署多个证书)，并且是默认打开的，相比TLS更高效的向前加密 - 完成以后，将计划适配到TLS 1.3中</li>
<li><strong>端口:</strong> 使用443端口来处理UDP协议数据 - <a href="https://community.spiceworks.com/topic/601177-port-80-443-udp-traffic-to-google" target="_blank" rel="external">Port 80/443 UDP Traffic to Google?</a></li>
<li><strong>其他:</strong> 更好的FEC(Forward error correction)机制、与Connection migration机制</li>
</ul>
<hr>
<ul>
<li><a href="http://lovestblog.cn/blog/2014/05/20/tcp-broken-pipe/" target="_blank" rel="external">从tcp原理角度理解Broken pipe和Connection Reset by Peer的区别</a></li>
<li><a href="http://velocity.oreilly.com.cn/2015/ppts/lizhenyu.pdf" target="_blank" rel="external">淘宝HTTPS探索</a></li>
<li><a href="http://www.alloyteam.com/2016/07/httphttp2-0spdyhttps-reading-this-is-enough/" target="_blank" rel="external">HTTP,HTTP/2,SPDY,HTTPS你应该知道的一些事</a></li>
<li><a href="https://docs.google.com/document/d/1lmL9EF6qKrk7gbazY8bIdvq3Pno2Xj_l_YShP40GLQE" target="_blank" rel="external">QUIC Geek FAQ</a></li>
<li><a href="https://github.com/google/bbr" target="_blank" rel="external">google/bbr</a></li>
<li><a href="http://www.cnblogs.com/mydomain/archive/2013/04/18/3027668.html" target="_blank" rel="external">滑动窗口和拥塞窗口简述</a></li>
<li><a href="https://www.zhihu.com/question/53559433" target="_blank" rel="external">BBR算法原理 - 李博杰</a></li>
<li><a href="https://www.nanog.org/sites/default/files/meetings/NANOG64/1051/20150603_Rogan_Quic_Next_Generation_v1.pdf" target="_blank" rel="external">QUIC - Next generation multiplexed transport over UDP</a></li>
<li><a href="https://code.facebook.com/posts/608854979307125/building-zero-protocol-for-fast-secure-mobile-connections/" target="_blank" rel="external">Building Zero protocol for fast, secure mobile connections</a></li>
<li><a href="https://github.com/WeMobileDev/article/blob/master/%E5%9F%BA%E4%BA%8ETLS1.3%E7%9A%84%E5%BE%AE%E4%BF%A1%E5%AE%89%E5%85%A8%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AEmmtls%E4%BB%8B%E7%BB%8D.md" target="_blank" rel="external">基于TLS1.3的微信安全通信协议mmtls介绍</a></li>
<li><a href="https://docs.google.com/document/d/1WJvyZflAO2pq77yOLbp9NsGjC1CHetAXV8I0fQe-B_U/edit" target="_blank" rel="external">QUIC Wire Layout Specification</a></li>
<li><a href="https://en.wikipedia.org/wiki/SPDY" target="_blank" rel="external">SPDY - Wiki</a></li>
<li><a href="https://code.facebook.com/posts/557147474482256/this-browser-tweak-saved-60-of-requests-to-facebook/" target="_blank" rel="external">This browser tweak saved 60% of requests to Facebook</a></li>
<li><a href="http://jiaolonghuang.github.io/2015/08/16/http2/" target="_blank" rel="external">HTTP2学习(四)—HTTP2的新特性</a></li>
<li><a href="https://www.chromium.org/spdy/link-headers-and-server-hint" target="_blank" rel="external">Server Push and Server Hints</a></li>
<li><a href="https://technet.microsoft.com/en-us/library/cc784450(v=ws.10" target="_blank" rel="external">What is TLS/SSL?</a>.aspx)</li>
<li><a href="http://peering.google.com/#/learn-more/quic" target="_blank" rel="external">QUIC - Google-peering</a></li>
<li><a href="https://www.chromium.org/quic" target="_blank" rel="external">QUIC教材</a></li>
<li><a href="https://www.youtube.com/watch?v=hQZ-0mXFmk8" target="_blank" rel="external">QUIC视频介绍</a></li>
<li><a href="https://tools.keycdn.com/http2-test" target="_blank" rel="external">Http2-test</a></li>
<li><a href="https://community.akamai.com/community/web-performance/blog/2015/06/05/useful-tools-for-http2-debugging" target="_blank" rel="external">Http2-debug</a></li>
</ul>
<hr>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2019/03/11/tips-net-summarize/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/03/11/tips-net-summarize/" itemprop="url">
                  tips-net-summarize
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-11T18:42:21+08:00">
                2019-03-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg"
               alt="轻口味" />
          <p class="site-author-name" itemprop="name">轻口味</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">167</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">62</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/qingkouwei" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/LightTaste" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/turnpp/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  豆瓣
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/shen-jun-wei-9/" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/ossrs/srs" title="SRS" target="_blank">SRS</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">轻口味</span>
</div>

<div>
<a href="http://www.miitbeian.gov.cn/">京ICP备17018543号</a>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "bb46b146831e4e34808d09cd94c85f50",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

</body>
</html>
