<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="老司机种菜" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="老司机种菜">
<meta property="og:url" content="http://wodekouwei.com/page/5/index.html">
<meta property="og:site_name" content="老司机种菜">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="老司机种菜">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wodekouwei.com/page/5/"/>





  <title> 老司机种菜 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2021aa5f03a4203621d42ef374e0d5f7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">老司机种菜</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/09/13/tips-qt-audiooutput/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/13/tips-qt-audiooutput/" itemprop="url">
                  关于QT QAudioOutput push模式问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-13T11:52:14+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/QT/" itemprop="url" rel="index">
                    <span itemprop="name">QT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在MAC上基于QT和ffmpeg实现最简单播放器,在完成声音播放模块后导致无法正常播放,QAudioOutput start后state仍是idel,将QAudioOutput buffer写满后就不能继续写数据了,导致播放被卡死.</p>
<p>QAudioOutput创建代码:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">QAudioFormat fmt;</div><div class="line">fmt.setSampleRate(this-&gt;sampleRate);</div><div class="line">fmt.setSampleSize(this-&gt;sampleSize);</div><div class="line">fmt.setChannelCount(this-&gt;channel);</div><div class="line">fmt.setCodec(&quot;audio/pcm&quot;);</div><div class="line">fmt.setByteOrder(QAudioFormat::LittleEndian);</div><div class="line">fmt.setSampleType(QAudioFormat::UnSignedInt);</div><div class="line">QAudioDeviceInfo info = QAudioDeviceInfo::defaultOutputDevice();</div><div class="line">printf(&quot;deviceName:%s\n&quot;,qPrintable(info.deviceName()));</div><div class="line">if (!info.isFormatSupported(fmt)) &#123;</div><div class="line">    printf(&quot;default format not supported try to use nearest\n&quot;);</div><div class="line">    fmt = info.nearestFormat(fmt);</div><div class="line">&#125;</div><div class="line">output = new QAudioOutput(fmt);</div><div class="line">//connect(output, SIGNAL(stateChanged(QAudio::State)), this, SLOT(handleStateChanged(QAudio::State)));</div><div class="line">io = output-&gt;start();</div><div class="line">printf(&quot;io:%p\n&quot;, io);</div><div class="line">//printf(&quot;state:%s&quot;,output-&gt;state());</div><div class="line">QAudio::State stat = output-&gt;state();</div></pre></td></tr></table></figure></p>
<p>在stackoverflow <a href="https://stackoverflow.com/questions/15651407/qt-qaudiooutput-push-mode" target="_blank" rel="external">Qt QAudioOutput push mode</a>看到别人的问题和解释,发现是setSampleType引起的,代码在window上可以正常跑,只是在mac上失败.</p>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><p>I’ve got a question about using QAudioOutput to directly write samples at a specific sample rate to the sound output device. I’m writing an emulator that emualates sound chips on a per-frame basis, and then gets a buffer containing a frame’s worth of audio samples, which I would like to write to the audio output. Currently, to test my audio output routine, I allocate a huge (5 minute) buffer to put random numbers into, like so:</p>
<p>Header:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">uint16_t *audio_outputBuffer;</div><div class="line">uint32_t audio_bytesRemainingToRead;</div><div class="line">QAudioOutput *audio_outputStream;</div><div class="line">QIODevice *audio_outputDevice;</div></pre></td></tr></table></figure></p>
<p>Implementation:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">audio_outputBuffer = (uint16_t *) malloc((96000 * 4) * 300);</div><div class="line">int i = 0;</div><div class="line"></div><div class="line">uint16_t *tempAudioBuffer = audio_outputBuffer;</div><div class="line">for(i = 0; i &lt; ((96000 * 4) * 150); i++) &#123;</div><div class="line">    *tempAudioBuffer = (uint16_t) rand() &amp; 0xFFFF;</div><div class="line">    tempAudioBuffer++;</div><div class="line">&#125;</div><div class="line"></div><div class="line">audio_bytesRemainingToRead = (96000 * 4) * 300;</div></pre></td></tr></table></figure></p>
<p>Next, I set up my audio device with some basic parameters:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// Set up the format</div><div class="line">QAudioFormat format;</div><div class="line">format.setFrequency(96000); // Usually this is specified through an UI option</div><div class="line">format.setChannels(2);</div><div class="line">format.setSampleSize(16);</div><div class="line">format.setCodec(&quot;audio/pcm&quot;);</div><div class="line">format.setByteOrder(QAudioFormat::LittleEndian);</div><div class="line">format.setSampleType(QAudioFormat::UnSignedInt);</div><div class="line"></div><div class="line">// There&apos;s code here to notify the user of inability to match the format and choose an action, which is omitted for clarity</div><div class="line"></div><div class="line">// Create audio output stream, set up signals</div><div class="line">audio_outputStream = new QAudioOutput(format, this);</div><div class="line"></div><div class="line">connect(audio_outputStream, SIGNAL(stateChanged(QAudio::State)), this, SLOT(audio_stateChanged(QAudio::State)));</div><div class="line"></div><div class="line">audio_outputDevice = audio_outputStream-&gt;start();</div></pre></td></tr></table></figure></p>
<p>Then, in my timer tick routine, which is called by a QTimer at 60 FPS, I do the following code to write a ‘chunk’ of audio data to the QAudioOutput’s buffer:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">if(audio_outputDevice-&gt;isOpen() &amp;&amp; audio_outputStream-&gt;state() != QAudio::StoppedState) &#123;</div><div class="line">    qint64 bytesOfAudioWrittenToDevice = audio_outputDevice-&gt;write((char *) audio_outputBuffer, audio_outputStream-&gt;periodSize());</div><div class="line">    audio_bytesRemainingToRead -= bytesOfAudioWrittenToDevice;</div><div class="line">    qDebug() &lt;&lt; &quot;Wrote&quot; &lt;&lt; bytesOfAudioWrittenToDevice &lt;&lt; &quot;bytes of audio to output device. Remaining bytes to read:&quot; &lt;&lt; audio_bytesRemainingToRead;</div><div class="line">    qDebug() &lt;&lt; &quot;Free bytes in audio output:&quot; &lt;&lt; audio_outputStream-&gt;bytesFree();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Once I start the audio output process, I get the following output on the console:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Current audio state: 3 Error: 0</div><div class="line">Wrote 2048 bytes of audio to output device. Remaining bytes to read: 115197952</div><div class="line">Free bytes in audio output: 6144</div><div class="line">Current audio state: 0 Error: 0</div><div class="line">Wrote 2048 bytes of audio to output device. Remaining bytes to read: 115195904</div><div class="line">Free bytes in audio output: 4096</div><div class="line">Wrote 2048 bytes of audio to output device. Remaining bytes to read: 115193856</div><div class="line">Free bytes in audio output: 2048</div><div class="line">Wrote 2048 bytes of audio to output device. Remaining bytes to read: 115191808</div><div class="line">Free bytes in audio output: 0 (This and the above line is repeated forever)</div></pre></td></tr></table></figure></p>
<p>To me, it looks like QAudioOutput isn’t flushing it’s internal buffer to the sound card, which goes along with the entire “no sound coming out of my computer” thing.</p>
<p>What would cause this issue, and how could I fix it?</p>
<p>(By the way, I’m compiling my code against Qt 4.8.1, on Mac OS X 10.7.4.)</p>
<p>Thanks for any answers.</p>
<h5 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h5><p>Upfront just wanna point out: This is not a Qt bug. Why? The answer is that in the WAV spec’, 8-bit samples are always unsigned, whereas 16-bit samples are always signed. Any other combination does not work. This is device related, the framework can not do anything about it.</p>
<p>So this will not work because you have set 16 bit sample size and unsigned integer format. And yes, the solution is: you have to set the sample type to signed for 16-bit resolution:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">format.setSampleType(QAudioFormat::SignedInt);</div></pre></td></tr></table></figure></p>
<p>Inversely for 8-bit samples you would have to put:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">format.setSampleType(QAudioFormat:UnsignedInt);</div></pre></td></tr></table></figure></p>
<p>Also this very similar question (same problem but with 8-bit) shows you that it is not a particular problem of using signed or unsigned samples in Qt, but that it is the combination of samples size and type that matters (for the audio device, not for Qt ;) QAudioOutput in Qt5 is not producing any sound</p>
<p>IMHO the fact that Qt does not take care of handling these cases by forcing the correct format is a flaw but not a lack in functionnality.</p>
<p>You can learn more about this in the notes section of this page: <a href="https://ccrma.stanford.edu/courses/422/projects/WaveFormat/" target="_blank" rel="external">https://ccrma.stanford.edu/courses/422/projects/WaveFormat/</a></p>
<p>I’ve figured this out — apparently Qt has issues with UNSIGNED samples. If you set the sample type to signed, everything works fine, regardless of platform.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/09/13/ffmpeg-arch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/13/ffmpeg-arch/" itemprop="url">
                  FFMPEG api使用流程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-13T10:04:15+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FFMPEG/" itemprop="url" rel="index">
                    <span itemprop="name">FFMPEG</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ffmpeg接口使用流程比较固定:</p>
<ol>
<li><code>av_register_all()</code>:注册所有模块</li>
<li><code>int ret = avformat_open_input(&amp;ic, ofn, 0, 0);</code>:获取AVFormatContext ic(ofn为输入文件地址)</li>
<li><code>for(i = 0; i &lt; ic-&gt;nb_streams; i++)</code>:遍历AVFormatContext中所有stream,分别找到Audio与Video对应的AVCodecContext;</li>
<li><code>AVCodec *codec = avcodec_find_decoder(enc-&gt;codec_id);</code>:根据AVCodecContext中codec_id获取到AVCodec;</li>
<li><code>avcodec_open2(enc, codec,NULL)</code>:打开AVCodec;</li>
<li>接下来分配AVPacket与AVFrame</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/09/13/ffmpeg-codec/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/13/ffmpeg-codec/" itemprop="url">
                  FFMPEG编解码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-13T10:03:37+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FFMPEG/" itemprop="url" rel="index">
                    <span itemprop="name">FFMPEG</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h3><p>ffmpeg3版本的解码接口做了调整,之前的视频解码接口<code>avcodec_decode_video2</code>和音频解码接口<code>avcodec_decode_audio4</code>被设置为deprecated,对这两个接口做了合并,使用同一的接口.并且将音视频解码步骤分成了两步,第一步<code>avcodec_send_packet</code>,第二步<code>avcodec_receive_frame</code>,</p>
<h4 id="旧版本avcodec-decode-video2"><a href="#旧版本avcodec-decode-video2" class="headerlink" title="旧版本avcodec_decode_video2"></a>旧版本<code>avcodec_decode_video2</code></h4><h4 id="旧版本avcodec-decode-audio4"><a href="#旧版本avcodec-decode-audio4" class="headerlink" title="旧版本avcodec_decode_audio4"></a>旧版本<code>avcodec_decode_audio4</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">int got_picture;</div><div class="line">            ret = avcodec_decode_audio4(enc, pcm,&amp;got_picture, pkt);</div><div class="line">            if ( ret &lt; 0 ) &#123;</div><div class="line">                char buf[1024] = &#123;0&#125;;</div><div class="line">                av_strerror(err, buf, sizeof(buf));</div><div class="line">                printf(buf);</div><div class="line">                printf(&quot;avcodec_decode_audio4 failed:%d&quot; ,got_picture);</div><div class="line">                av_packet_unref(pkt);</div><div class="line">                av_frame_free(&amp;pcm);</div><div class="line">                if(ic) avformat_close_input(&amp;ic);</div><div class="line">                return -1;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>将AVPacket的pkt解码成AVFrame的pcm</p>
<h4 id="新版本avcodec-send-packet"><a href="#新版本avcodec-send-packet" class="headerlink" title="新版本avcodec_send_packet"></a>新版本<code>avcodec_send_packet</code></h4><h5 id="接口源码"><a href="#接口源码" class="headerlink" title="接口源码:"></a>接口源码:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Supply raw packet data as input to a decoder.</div><div class="line"> *</div><div class="line"> * Internally, this call will copy relevant AVCodecContext fields, which can</div><div class="line"> * influence decoding per-packet, and apply them when the packet is actually</div><div class="line"> * decoded. (For example AVCodecContext.skip_frame, which might direct the</div><div class="line"> * decoder to drop the frame contained by the packet sent with this function.)</div><div class="line"> *</div><div class="line"> * @warning The input buffer, avpkt-&gt;data must be AV_INPUT_BUFFER_PADDING_SIZE</div><div class="line"> *          larger than the actual read bytes because some optimized bitstream</div><div class="line"> *          readers read 32 or 64 bits at once and could read over the end.</div><div class="line"> *</div><div class="line"> * @warning Do not mix this API with the legacy API (like avcodec_decode_video2())</div><div class="line"> *          on the same AVCodecContext. It will return unexpected results now</div><div class="line"> *          or in future libavcodec versions.</div><div class="line"> *</div><div class="line"> * @note The AVCodecContext MUST have been opened with @ref avcodec_open2()</div><div class="line"> *       before packets may be fed to the decoder.</div><div class="line"> *</div><div class="line"> * @param avctx codec context</div><div class="line"> * @param[in] avpkt The input AVPacket. Usually, this will be a single video</div><div class="line"> *                  frame, or several complete audio frames.</div><div class="line"> *                  Ownership of the packet remains with the caller, and the</div><div class="line"> *                  decoder will not write to the packet. The decoder may create</div><div class="line"> *                  a reference to the packet data (or copy it if the packet is</div><div class="line"> *                  not reference-counted).</div><div class="line"> *                  Unlike with older APIs, the packet is always fully consumed,</div><div class="line"> *                  and if it contains multiple frames (e.g. some audio codecs),</div><div class="line"> *                  will require you to call avcodec_receive_frame() multiple</div><div class="line"> *                  times afterwards before you can send a new packet.</div><div class="line"> *                  It can be NULL (or an AVPacket with data set to NULL and</div><div class="line"> *                  size set to 0); in this case, it is considered a flush</div><div class="line"> *                  packet, which signals the end of the stream. Sending the</div><div class="line"> *                  first flush packet will return success. Subsequent ones are</div><div class="line"> *                  unnecessary and will return AVERROR_EOF. If the decoder</div><div class="line"> *                  still has frames buffered, it will return them after sending</div><div class="line"> *                  a flush packet.</div><div class="line"> *</div><div class="line"> * @return 0 on success, otherwise negative error code:</div><div class="line"> *      AVERROR(EAGAIN):   input is not accepted right now - the packet must be</div><div class="line"> *                         resent after trying to read output</div><div class="line"> *      AVERROR_EOF:       the decoder has been flushed, and no new packets can</div><div class="line"> *                         be sent to it (also returned if more than 1 flush</div><div class="line"> *                         packet is sent)</div><div class="line"> *      AVERROR(EINVAL):   codec not opened, it is an encoder, or requires flush</div><div class="line"> *      AVERROR(ENOMEM):   failed to add packet to internal queue, or similar</div><div class="line"> *      other errors: legitimate decoding errors</div><div class="line"> */</div><div class="line">int avcodec_send_packet(AVCodecContext *avctx, const AVPacket *avpkt);</div></pre></td></tr></table></figure>
<h5 id="参数分析"><a href="#参数分析" class="headerlink" title="参数分析"></a>参数分析</h5><ul>
<li><code>AVCodecContext *avctx</code>：第一个参数与旧的接口一致，是视频解码的上下文，包含解码器。</li>
<li><code>const AVPacket *avpkt</code>： 编码的音视频帧数据</li>
</ul>
<p>为什么要传递空的avpkt
这里有一个说明是可以传递NULL，什么情况下需要传递NULL，你平时看一些视频播放器，播放经常会少最后几帧，很多情况就是因为没有处理好缓冲帧的问题，ffmpeg内部会缓冲几帧，要想取出来就需要传递空的AVPacket进去。</p>
<h4 id="新版本avcodec-receive-frame"><a href="#新版本avcodec-receive-frame" class="headerlink" title="新版本avcodec_receive_frame"></a>新版本<code>avcodec_receive_frame</code></h4><h5 id="接口源码-1"><a href="#接口源码-1" class="headerlink" title="接口源码"></a>接口源码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Return decoded output data from a decoder.</div><div class="line"> *</div><div class="line"> * @param avctx codec context</div><div class="line"> * @param frame This will be set to a reference-counted video or audio</div><div class="line"> *              frame (depending on the decoder type) allocated by the</div><div class="line"> *              decoder. Note that the function will always call</div><div class="line"> *              av_frame_unref(frame) before doing anything else.</div><div class="line"> *</div><div class="line"> * @return</div><div class="line"> *      0:                 success, a frame was returned</div><div class="line"> *      AVERROR(EAGAIN):   output is not available right now - user must try</div><div class="line"> *                         to send new input</div><div class="line"> *      AVERROR_EOF:       the decoder has been fully flushed, and there will be</div><div class="line"> *                         no more output frames</div><div class="line"> *      AVERROR(EINVAL):   codec not opened, or it is an encoder</div><div class="line"> *      other negative values: legitimate decoding errors</div><div class="line"> */</div><div class="line">int avcodec_receive_frame(AVCodecContext *avctx, AVFrame *frame);</div></pre></td></tr></table></figure>
<h5 id="参数分析-1"><a href="#参数分析-1" class="headerlink" title="参数分析"></a>参数分析</h5><ul>
<li><code>AVCodecContext *avctx</code>：第一个参数视频解码的上下文，与上面接口一致。</li>
<li><code>AVFrame *frame</code>：解码后的视频帧数据。</li>
</ul>
<h5 id="空间申请和释放问题"><a href="#空间申请和释放问题" class="headerlink" title="空间申请和释放问题"></a>空间申请和释放问题</h5><p>解码后图像空间由函数内部申请，你所做的只需要分配 AVFrame 对象空间，如果你每次调用avcodec_receive_frame传递同一个对象，接口内部会判断空间是否已经分配，如果没有分配会在函数内部分配。
avcodec_send_packet和avcodec_receive_frame调用关系并不一定是一对一的，比如一些音频数据一个AVPacket中包含了1秒钟的音频，调用一次avcodec_send_packet之后，可能需要调用25次 avcodec_receive_frame才能获取全部的解码音频数据，所以要做如下处理：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">int re = avcodec_send_packet(codec, pkt);</div><div class="line">if (re != 0)</div><div class="line">&#123;</div><div class="line">    return;</div><div class="line">&#125;</div><div class="line">while( avcodec_receive_frame(codec, frame) == 0)</div><div class="line">&#123;</div><div class="line">    //读取到一帧音频或者视频</div><div class="line">    //处理解码后音视频 frame</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>参考
<a href="http://ffmpeg.org/doxygen/trunk/group__lavc__encdec.html" target="_blank" rel="external">send/receive encoding and decoding API overview</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/09/13/ffmpeg-util/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/13/ffmpeg-util/" itemprop="url">
                  FFMPEG工具方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-13T10:03:27+08:00">
                2017-09-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/FFMPEG/" itemprop="url" rel="index">
                    <span itemprop="name">FFMPEG</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="av-strerror"><a href="#av-strerror" class="headerlink" title="av_strerror"></a>av_strerror</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">int av_strerror	(	int 	errnum,</div><div class="line">char * 	errbuf,</div><div class="line">size_t 	errbuf_size</div><div class="line">)</div></pre></td></tr></table></figure>
<h4 id="ffmpeg获取与设置mp4文件旋转方向方法"><a href="#ffmpeg获取与设置mp4文件旋转方向方法" class="headerlink" title="ffmpeg获取与设置mp4文件旋转方向方法"></a>ffmpeg获取与设置mp4文件旋转方向方法</h4><p>设置与获取都是对AVStream的dict操作.
<strong>设置</strong>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">for (i = 0; i &lt; ifmt_ctx_v-&gt;nb_streams; i++) &#123;  </div><div class="line">        //Create output AVStream according to input AVStream  </div><div class="line">        if(ifmt_ctx_v-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO)&#123;  </div><div class="line">            AVStream *in_stream = ifmt_ctx_v-&gt;streams[i];  </div><div class="line">            AVStream *out_stream = avformat_new_stream(ofmt_ctx, in_stream-&gt;codec-&gt;codec);  </div><div class="line">            videoindex_v=i;  </div><div class="line">            if (!out_stream) &#123;  </div><div class="line">                printf( &quot;Failed allocating output stream\n&quot;);  </div><div class="line">                ret = AVERROR_UNKNOWN;  </div><div class="line">                goto end;  </div><div class="line">            &#125;  </div><div class="line">            videoindex_out=out_stream-&gt;index;  </div><div class="line">            //Copy the settings of AVCodecContext  </div><div class="line">            ret = av_dict_set(&amp;out_stream-&gt;metadata,&quot;rotate&quot;,&quot;90&quot;,0); //设置旋转角度  </div><div class="line">            if(ret&gt;=0)  </div><div class="line">            &#123;  </div><div class="line">                printf(&quot;=========yes=====set rotate success!===\n&quot;);  </div><div class="line">            &#125;  </div><div class="line"></div><div class="line">            if (avcodec_copy_context(out_stream-&gt;codec, in_stream-&gt;codec) &lt; 0) &#123;  </div><div class="line">                printf( &quot;Failed to copy context from input to output stream codec context\n&quot;);  </div><div class="line">                goto end;  </div><div class="line">            &#125;  </div><div class="line">            out_stream-&gt;codec-&gt;codec_tag = 0;  </div><div class="line">            if (ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)  </div><div class="line">                out_stream-&gt;codec-&gt;flags |= CODEC_FLAG_GLOBAL_HEADER;  </div><div class="line">            break;  </div><div class="line">        &#125;  </div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p><strong>读取</strong>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">for (i = 0; i &lt; ifmt_ctx_v-&gt;nb_streams; i++) &#123;  </div><div class="line">        //Create output AVStream according to input AVStream  </div><div class="line">        if(ifmt_ctx_v-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO)&#123;  </div><div class="line">            AVStream *in_stream = ifmt_ctx_v-&gt;streams[i];  </div><div class="line">            AVStream *out_stream = avformat_new_stream(ofmt_ctx, in_stream-&gt;codec-&gt;codec);  </div><div class="line">            videoindex_v=i;  </div><div class="line">            if (!out_stream) &#123;  </div><div class="line">                printf( &quot;Failed allocating output stream\n&quot;);  </div><div class="line">                ret = AVERROR_UNKNOWN;  </div><div class="line">                goto end;  </div><div class="line">            &#125;  </div><div class="line">            videoindex_out=out_stream-&gt;index;  </div><div class="line">            //Copy the settings of AVCodecContext  </div><div class="line">            ret = av_dict_set(&amp;out_stream-&gt;metadata,&quot;rotate&quot;,&quot;90&quot;,0); //设置旋转角度  </div><div class="line">            if(ret&gt;=0)  </div><div class="line">            &#123;  </div><div class="line">                printf(&quot;=========yes=====set rotate success!===\n&quot;);  </div><div class="line">            &#125;  </div><div class="line"></div><div class="line">            if (avcodec_copy_context(out_stream-&gt;codec, in_stream-&gt;codec) &lt; 0) &#123;  </div><div class="line">                printf( &quot;Failed to copy context from input to output stream codec context\n&quot;);  </div><div class="line">                goto end;  </div><div class="line">            &#125;  </div><div class="line">            out_stream-&gt;codec-&gt;codec_tag = 0;  </div><div class="line">            if (ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)  </div><div class="line">                out_stream-&gt;codec-&gt;flags |= CODEC_FLAG_GLOBAL_HEADER;  </div><div class="line">            break;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line"></div><div class="line"></div><div class="line">double g_rotate_theta = get_rotation(decoder-&gt;is_video);//is_video是video的AVStream</div><div class="line">        int rotate = 0;</div><div class="line">        if (fabs(g_rotate_theta - 90) &lt; 1.0)</div><div class="line">        &#123;</div><div class="line">            rotate = 90;</div><div class="line">        &#125;</div><div class="line">        else if(fabs(g_rotate_theta - 180) &lt; 1.0||fabs(g_rotate_theta + 180) &lt; 1.0)</div><div class="line">        &#123;</div><div class="line">            rotate = 180;</div><div class="line">        &#125;</div><div class="line">        else if(fabs(g_rotate_theta - 270) &lt; 1.0||fabs(g_rotate_theta + 90) &lt; 1.0)</div><div class="line">        &#123;</div><div class="line">            rotate = 270;</div><div class="line">        &#125;</div><div class="line">        LOGI(&quot;get rotate is : %d&quot; , rotate);</div><div class="line">        metadata-&gt;rotate = rotate;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/09/12/tips-media-profile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/12/tips-media-profile/" itemprop="url">
                  音视频参数之Profile
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-12T12:12:19+08:00">
                2017-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/media/" itemprop="url" rel="index">
                    <span itemprop="name">media</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前两天发现公司产品 <strong>触发</strong> 有导入从微信等下载的外部小视频时失败的情况, <strong>触发</strong> 导入视频时使用开源库<a href="https://github.com/INDExOS/media-for-mobile" target="_blank" rel="external">media-for-mobile</a>对视频进行重新编码.media-for-mobile使用android系统接口<code>android.media.MediaExtractor</code>对mp4文件解复用,使用android硬件编解码接口<code>android.media.MediaCodec</code>对视频解码-处理-编码操作,最后通过Android系统API<code>android.media.MediaMuxer</code>将视频写成文件.</p>
<p>反馈的两个有问题视频,一个视频导入时报<code>BufferOverFlowException</code>错误,另一个视频不报错但是导入时进度一直为0%.</p>
<p>经分析出问题的两个视频的Video profile为High,普通视频为<code>Baseline</code>,报<code>BufferOverFlowException</code>错误的视频的Audio profile为<code>HE-AAC</code>,普通视频的Audio profile为<code>LC</code>.
详细了解了一下H264 与AAC profile:</p>
<h4 id="H264各种profile"><a href="#H264各种profile" class="headerlink" title="H264各种profile"></a>H264各种profile</h4><p>作为行业标准，H.264编码体系定义了4种不同的Profile(类)：Baseline(基线类),Main(主要类), Extended(扩展类)和High Profile(高端类)（它们各自下分成许多个层）：</p>
<ol>
<li><code>Baseline Profile</code>: 提供I/P帧，仅支持progressive(逐行扫描)和CAVLC；</li>
<li><code>Extended Profile</code>: 提供I/P/B/SP/SI帧，仅支持progressive(逐行扫描)和CAVLC；</li>
<li><code>Main Profile:</code> 提供I/P/B帧，支持progressive(逐行扫描)和interlaced(隔行扫描)，提供CAVLC或CABAC；</li>
<li><code>High Profile</code>: （也就是FRExt）在Main Profile基础上新增：8x8 intra prediction(8x8 帧内预测), custom quant(自定义量化), lossless video coding(无损视频编码), 更多的yuv格式（4:4:4…）；</li>
</ol>
<p>H.264在高清中具有最小体积。在同等图像质量下，采用H.264技术压缩后的数据量只有MPEG2的1/8，MPEG4的1/3，相对Xvid、Divx等属于MPEG4编码而言，其体积优势明显，在互联网上，H.264资源处在爆发趋势。而High Profile是H.264解码中的高端类型，拥有最完善的支持程度、最优秀的特性，可以说是高清视频编码中的劳斯莱斯，只有征服了这个优秀的编码，MP4才能将H.264完全掌控，也才能充分享受到高清视频带来的视觉震撼，意义非凡。</p>
<p>针对当前高清是视频会议行业的主流发展趋势，而目前高清普及的主要阻力之一就是带宽的限制。而High Profile H.264技术在同等视频质量的情况下可节省50%的带宽，为客户节省大量的网络带宽成本。据业内专家介绍，此次H.264 High Profile的推出是视频技术的一个巨大进步，其意义不亚于2003年从H.263向H.264过渡的价值。它将为目前正在推广的高清视频通信应用扫清了令人头疼的网络带宽障碍，不仅如此，这些变化对于包括CIF、标清等品质的视频通信应用也同样适用。</p>
<p>鉴于High Profile H.264对于视频会议行业的非凡影响，目前已有国内外厂商尝鲜，宣布其旗下产品全面支持该项技术，包括宝利通、华平、华腾网讯。从这一趋势来看，未来视频会议产品全面支持High Profile H.264也经成为不可逆转的潮流，而高清普及也在技术层面更近了一步。</p>
<blockquote>
<p>参考:
<a href="http://blog.csdn.net/qiaoliang328/article/details/10153313" target="_blank" rel="external">H264 各种profile</a></p>
</blockquote>
<h4 id="AAC各种profile"><a href="#AAC各种profile" class="headerlink" title="AAC各种profile"></a>AAC各种profile</h4><h5 id="AAC历史"><a href="#AAC历史" class="headerlink" title="AAC历史"></a>AAC历史</h5><p>如果说目前H.264是视频CODEC的实际霸主，那么AAC就是音频CODEC的女王。主流的音视频格式都是H.264搭配AAC，无论是非实时的媒体文件还是实时的媒体流。
Advanced Audio Coding (AAC) 是一个有损压缩的音频编码集（其实新的编码工具也支持无损）。其设计目标是替代原有MP3编码标准，在与MP3在相似的码率下希望质量优于MP3。这一目标已达到并且由ISO和IEC标准组织标准化在MPEG-2和MPEG-4中。</p>
<p>AAC已被广泛支持并应用到各种设备和系统中 YouTube, iPhone, iPod, iPad, Nintendo DSi, Nintendo 3DS, iTunes,DivX Plus Web Player and PlayStation 3. It is supported on PlayStation Vita,Wii (with the Photo Channel 1.1 update installed), Sony Walkman MP3 series andlater, Android and BlackBerry等等。</p>
<ol>
<li>1997年，AAC第一次出现在标准MPEG-2 Part 7,（ISO/IEC 13818-7:1997）。和视频CODEC标准类似，AAC在MPEG-2 Part 7就有三个profiles他们分别是。<ul>
<li>Low-Complexity profile(AAC-LC / LC-AAC)</li>
<li>Main profile (AAC Main)</li>
<li>Scalable Sampling Rateprofile (AAC-SSR)
从此可知AAC-LC出现最早，所以AAC-LC的应用最广泛，兼容性最好。</li>
</ul>
</li>
<li>1999年, AAC从原有标准升级并且合入标准MPEG-4Part 3（ISO/IEC14496-3:1999）
这次升级一个重要变化是引入 <strong>Audio Object Types(AOT)</strong> 并且把AOT概念合并到profiles中。这时profile也变成4个。<ul>
<li>Main (which includes most of the MPEG-4 Audio Object Types)</li>
<li>Scalable (AAC LC, AAC LTP, CELP, HVXC, TwinVQ, Wavetable Synthesis,TTSI),</li>
<li>Speech (CELP, HVXC, TTSI)</li>
<li>Low Rate Synthesis (Wavetable Synthesis, TTSI)合成语音。</li>
</ul>
</li>
<li>2000年，版本更新到2，MPEG-4 AudioVersion 2 (ISO/IEC 14496-3:1999/Amd 1:2000)，标准定义了一种新的AOT, 低时延AAC，the low delay AAC(AAC-LD)。</li>
<li>2001年，标准化High-Efficiency Advanced Audio Coding (HE-AAC) ISO/IEC 14496-3:2001。</li>
<li>2003年，标准化HE-AAC v2 Profile (AAC LC with SBR and Parametric Stereo) ISO/IEC14496-3:2005</li>
<li>目前AAC的标准化的版本是 ISO/IEC 14496-3:2009。</li>
</ol>
<p>从上面标准化历史可知，AAC不在一单纯的一个编码器了，而是一个庞大的音频编码工具集合。</p>
<h5 id="AOT-Audio-Object-Types"><a href="#AOT-Audio-Object-Types" class="headerlink" title="AOT(Audio Object Types)"></a>AOT(Audio Object Types)</h5><p>AOT就是MPEG-4 Audio Object Types的缩写。能力集协商时用的是AOT ID。
也正是由于AAC的AOT繁多，导致识别使用AAC的用户很困扰。
AAC-LC 可认为是AOT为2的AAC。
下表是AOT的对应表。</p>
<table>
<thead>
<tr>
<th>object type ID</th>
<th>Audio Object Type</th>
<th>z</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Null</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>AAC Main</td>
<td>1999</td>
<td>contains AACLC</td>
</tr>
<tr>
<td>2</td>
<td>AAC LC (Low Complexity)</td>
<td>1999</td>
<td>used in the “AAC Profile”.MPEG-4 AAC LC Audio Object Type is based on the MPEG-2 Part7 Low Complexity profile(LC)combined with Perceptual Noise Subsitution(PNS)(define in MPEG-4 part 3 Subpart 4)</td>
</tr>
<tr>
<td>3</td>
<td>AAC SSR (Scalable Sample Rate)</td>
<td>1999</td>
<td>Mpeg4 AAC SSR Audio Object Type is based on the MPEG-2 Parg 7 Scalable Sampling Rate profile(SSR)combined with Perceptual Noise Subsitution(PNS)(defined in MPEG-4 Parg 3 Subpart 4)</td>
</tr>
<tr>
<td>4</td>
<td>AAC LTP (Long Term Prediction)</td>
<td>1999</td>
<td>contains AAC LC</td>
</tr>
<tr>
<td>5</td>
<td>SBR (Spectral Band Replication)</td>
<td>2003</td>
<td>used with AAC LC in the “High Efficiency AAC Profile”(HE-AAC v1)</td>
</tr>
<tr>
<td>6</td>
<td>AAC Scalable</td>
<td>1999</td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>TwinVQ</td>
<td>1999</td>
<td>audio coding at very low bitrates</td>
</tr>
<tr>
<td>8</td>
<td>CELP (Code Excited Linear Prediction)</td>
<td>1999</td>
<td>speech coding</td>
</tr>
<tr>
<td>9</td>
<td>HXVC (Harmonic Vector eXcitation Coding)</td>
<td>speech coding</td>
</tr>
<tr>
<td>10</td>
<td>Reserved</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>Reserved</td>
<td></td>
<td></td>
</tr>
<tr>
<td>12</td>
<td>TTSI (Text-To-Speech Interface)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>13</td>
<td>Main Synthesis</td>
<td></td>
<td></td>
</tr>
<tr>
<td>14</td>
<td>Wavetable Synthesis</td>
<td></td>
<td></td>
</tr>
<tr>
<td>15</td>
<td>General MIDI</td>
<td></td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>Algorithmic Synthesis and Audio Effects</td>
<td></td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>ER (Error Resilient) AAC LC</td>
<td></td>
<td></td>
</tr>
<tr>
<td>18</td>
<td>Reserved</td>
<td></td>
<td></td>
</tr>
<tr>
<td>19</td>
<td>ER AAC LTP</td>
<td></td>
<td></td>
</tr>
<tr>
<td>20</td>
<td>ER AAC Scalable</td>
<td></td>
<td></td>
</tr>
<tr>
<td>21</td>
<td>ER TwinVQ</td>
<td></td>
<td></td>
</tr>
<tr>
<td>22</td>
<td>ER BSAC (Bit-Sliced Arithmetic Coding)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>23</td>
<td>ER AAC LD (Low Delay)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>24</td>
<td>ER CELP</td>
<td></td>
<td></td>
</tr>
<tr>
<td>25</td>
<td>ER HVXC</td>
<td></td>
<td></td>
</tr>
<tr>
<td>26</td>
<td>ER HILN (Harmonic and Individual Lines plus Noise)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>27</td>
<td>ER Parametric</td>
<td></td>
<td></td>
</tr>
<tr>
<td>28</td>
<td>SSC (SinuSoidal Coding)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>29</td>
<td>PS (Parametric Stereo)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>30</td>
<td>MPEG Surround</td>
<td></td>
<td></td>
</tr>
<tr>
<td>31</td>
<td>(Escape value)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>32</td>
<td>Layer-1</td>
<td></td>
<td></td>
</tr>
<tr>
<td>33</td>
<td>Layer-2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>34</td>
<td>Layer-3</td>
<td></td>
<td></td>
</tr>
<tr>
<td>35</td>
<td>DST (Direct Stream Transfer)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>36</td>
<td>ALS (Audio Lossless)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>37</td>
<td>SLS (Scalable LosslesS)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>38</td>
<td>SLS non-core</td>
<td></td>
<td></td>
</tr>
<tr>
<td>39</td>
<td>ER AAC ELD (Enhanced Low Delay)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>40</td>
<td>SMR (Symbolic Music Representation) Simple</td>
<td></td>
<td></td>
</tr>
<tr>
<td>41</td>
<td>SMR Main</td>
<td></td>
<td></td>
</tr>
<tr>
<td>42</td>
<td>USAC (Unified Speech and Audio Coding) (no SBR)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>43</td>
<td>SAOC (Spatial Audio Object Coding)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>44</td>
<td>LD MPEG Surround</td>
<td></td>
<td></td>
</tr>
<tr>
<td>45</td>
<td>USAC</td>
<td></td>
</tr>
</tbody>
</table>
<h5 id="MPEG-4-Audio-Profile"><a href="#MPEG-4-Audio-Profile" class="headerlink" title="MPEG-4 Audio Profile"></a>MPEG-4 Audio Profile</h5><p>  MPEG-4在音频编码方向对音频能力集合的描述称为Audio Profiles，音频能力描述基于AOT
  <img src="http://images.wodekouwei.com/media/mpeg_audio_profile.jpg" alt="image"></p>
<ol>
<li><code>MPEG-2 AAC LC</code>: Advanced Audio Coding Low-Complexity，(AAC-LC / LC-AAC)格式是MPEG-2格式，设计用于数字电视。AAC-LC用于存储空间和计算能力有限的情况。这种类型没有使用预测和增益控制这两种工具，瞬时噪声整形的阶数也比较低。
AAC-LC是充分利用心理声学原理，对人类对音频信号的感知存在不相干性和统计冗余的特性，最大程度的减少用于表达信号的比特数据 ，实现音频信号快速有效地压缩，而不再追求输出信号和原始信号相似度。
AAC-LC的重要技术点有如下一些。</li>
</ol>
<ul>
<li>Temporal Noise Shaping：瞬时噪声整形是用来控制量化噪声的瞬时形态，解决掩蔽阈值和量化噪声的错误匹配的问题。TNS利用时频对偶性，即时域平稳的信号会在频域上变比剧烈，而频域平稳的信号会在时域上变化剧烈。对时域的瞬态信号可以对频谱系数进行预测编码。对频谱系数进行预测，可以及时调节量化器以适应输入信号的时域状态，可以有效的控制量化噪声，</li>
<li>Intensity Stereo：利用心理声学原理提高编码效率的一种方法。由于人耳对高频信号的相位不敏感，只要信号的能量和频谱相似，在感知上没有什么区别，所以当一对声道的信号相关性较高时，可以对高频部分进行一定的处理，只在一个声道中编码传输数据，而不会影响解码后的重建音质。
AAC-LC把6kHz作为声强立体声处理的起始频率，在这个频率上的都进行声强立体声处理。计算出左右声道各个子带的能量和总能量，然后计算左声道能量和总能量的比值并换算成一个强度因子，按照这个强度因子对了带内的所有频谱进行左右声道求和并归一化，右声道的数据则全部置零，这样只需要对左声道数据进行量化编码。</li>
<li>Perceptual Noise Substitution：感知噪声替代用于频谱成分分类似噪声（功率谱密度是均匀的）时，用人造噪声代替。当判断某个频带需要进行感知噪声替代后，只用把该频带的能量作为参数编码传输，而不需要对子带内的频谱值进行编码，解码时解出子带能量和随机矢量生成函数产生的类似噪声。
Middle/Side：立体声编码，是利用一对声道的信号之间的相关性去冗余，降低编码比特率的方法。AAC-LD编码器中对左右声道的数据相关性较大时，可以用Middle=（L+R）/ 2，Side = (L-R)/2来代替左右声道的数据进行编码。这样能量集中在一个声道数据中，而另外一个声道只要少量比特数据，这样实现了数据压缩。</li>
</ul>
<ol>
<li><code>MPEG-2 AAC Main</code>: 主规格    </li>
<li><code>MPEG-2 AAC SSR</code>: 可变采样率规格（Scaleable Sample Rate）</li>
<li><code>MPEG-4 AAC LC</code>: 低复杂度规格（Low Complexity）——现在的手机比较常见的MP4文件中的音频部份就包括了该规格音频文件</li>
<li><code>MPEG-4 AAC Main</code>: 主规格   ——包含了除增益控制之外的全部功能，其音质最好</li>
<li><code>MPEG-4 AAC SSR</code>: 可变采样率规格（Scaleable Sample Rate）</li>
<li><code>MPEG-4 AAC LTP</code>: 长时期预测规格（Long Term Predicition）</li>
<li><code>MPEG-4 AAC LD</code>: AAC是感知型音频编解码器，可以在较低的比特率下提供很高质量的主观音质。但是这样的编解码器在低比特率下的算法延时往往超过100ms，所以并不适合实时的双向通信。而基于G.722的语音编解码方案因为其较小的算法延时而适合于双向通信。但是这种基于语音的编解码方案只能针对语音信号提供较好的主观质量，并不适合更为复杂的音频信号，而且即使在很高的比特率下，该编解码方案给出的结果也很难达到良好的音质。
常用的感知音频编码器的延时包括：</li>
</ol>
<ul>
<li>Framing delay：进行块变换需要的块长；</li>
<li>Filterbank delay：分析-综合滤波器所需要的延时；</li>
<li>Look-ahead delay for block switching：块切换为检测瞬态而需要的延时；</li>
<li>Use of bit reservoir：比特池大小相对于平均比特率所需要的延时。
总延时计算公式：
<img src="http://images.wodekouwei.com/media/aac_ld1.jpg" alt="image">
如下面的AAC-LC为例：
<img src="http://images.wodekouwei.com/media/aac_ld2.jpg" alt="iamge">
在AAC-LD中，为了减少延时，将原来的1024的帧长改为512；没有了窗切换功能，减少了为进行窗切换所需要的前瞻延时；同时为了增强对瞬态信号的编码质量，引入了窗型切换机制，窗型包括一般的SINE窗和一个少重叠的窗，该窗与后面的窗有很少的重叠，这样通过对TNS工具的优化来消除瞬态信号产生的预回声效应。
MPEG-4 Low Delay Audio Coder (AAC-LD)是直接源于MPEG-2 AAC，并且结合了感知音频编码和双向通信必须的低延时要求。它可以保证最大的20ms的算法延时和包括语音和音乐的信号的很好的音质。现在的MPEG-4 AAC LD支持最大采样率48kHz，最大声道数目是2（可以扩展为多声道）。</li>
</ul>
<ol>
<li><code>MPEG-4 AAC HE</code>: 高效率规格（High Efficiency）—–这种规格适合用于低码率编码，有Nero ACC 编码器支持</li>
</ol>
<p>14496-3标准，里面定义的profile除了上述的一些规格，还有如Scalable 、 TwinVQ、  CELP、  HVXC等更多其他的profile。</p>
<p>目前听到用的比较多的应该是LC和HE(适合低码率)。流行的Nero AAC的命令行编码程序就支持LC，HE，HEv2这三种，试用后，用MediaInfo分析了编码后的AAC音频，发现规格显示都是LC，当时就感到奇怪，不是说支持三种规格吗？然后才又查资料发现，原来HE其实就是AAC（LC）+SBR技术，HEv2就是AAC（LC）+SBR+PS技术，难怪用MediaInfo分析后，HE规格的文件即显示:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">格式简介:LC</div><div class="line">格式设置,SBR:是</div><div class="line">格式设置,PS:否</div></pre></td></tr></table></figure></p>
<h6 id="关于HE与HEv2"><a href="#关于HE与HEv2" class="headerlink" title="关于HE与HEv2"></a>关于HE与HEv2</h6><ul>
<li><p>HE：“high efficiency”（高效性）。HE-AAC v1（又称AACPlusV1，SBR)用容器的方法加了原AAC（LC）+SBR技术。SBR其实代表的是Spectral Band Replication(频段复制)。简单概括一下，音乐的主要频谱集中在低频段，高频段幅度很小（但很重要，决定了音质），如果对整个频段编码，要么为了保护高频造成低频段编码过细以致文件巨大，要么为了保存了低频的主要成分而失去高频成分以致丧失音质。SBR把频谱切割开来，低频单独编码保存主要成分，高频单独放大编码保存音质，“统筹兼顾”了，在减少文件大小的情况下还保存了音质，完美的化解了一对矛盾</p>
</li>
<li><p>HEv2 它用容器的方法包含了HE-AAC v1和PS技术。PS指“parametric stereo”（参数立体声）。这个其实好理解，原来的立体声文件，文件大小是一个声道的两倍。但是两个声道的声音存在某种相似性，根据香农信息熵编码定理，相关性应该被去掉才能减小文件大小。所以PS技术存储了一个声道的全部信息，然后，花很少的字节用参数描述另一个声道和它不同的地方
这样，HEv1和HEv2用个图简单表示下就是：(图中的AAC即指的是原来的AAC-LC)
<img src="http://images.wodekouwei.com/media/aac-he.jpg" alt="image">
由于NERO AAC编码后产生的是经过MP4容器封装后的，而我们的decoder需要处理的是未经封装的AAC流，因此还需要处理从MP4封装格式中extract出AAC流的步骤；哦，这里提到了MP4容器封装，就再把我看到的一些关于MP4容器的心得插入在此也说下：</p>
</li>
</ul>
<p>其实.mp4格式规范是MPEG4 Part 1标准定义的。但是这个格式本身相当通用，并不是只能用来存贮MPEG4视频格式。举个例子，一个.mp4文件中包含的可能是H.263的视频轨及AMR的音频轨。这样它和MPEG4视频压缩算法就半点边都沾不上。但它绝对是一个合法的.mp4文件。从这个意义上讲，.mp4是一个独立的封包格式。也许它的原始设计意图是仅用于MPEG4，但事实上大家觉得它很好用，已经把它扩展成可以包容其它格式了。现在市场上比如某产品号称“支持MP4播放”，到底是什么意思呢？如果它是指可以播放<em>.mp4这种文件，那里面的音频和视频格式它能支持多少种组合呢？没说清楚吧。举个极端的例子，假设一台设备仅支持“视频为未压缩YUV以及不带音频轨的.mp4文件，但它的文件名确实可以是</em>.mp4，是不是也可以在盒子上印上“支持MP4”呢？那么，买回去，复制一个网上下载的.mp4文件（MPEG4视频和AAC音频应该是个比较流行的组合），结果却发现根本不能播放。就算不举这么极端的例子，一般.mp4文件中常见的视频音频格式也有多种，一个产品要做到支持所有的格式是很难的。所以，如果要准确的描述，应该写清楚类似“支持视频格式为MPEG4或H.264/AVC，音频为AMR或AAC的*.mp4文件”。其实更严格一些，还应该写清楚MPEG4支持到哪种profile, AMR是NB还是WB，AAC是LC还是HE等更多细节。当然，这种误导型的说明应该在减少，不过如果有比较确切的格式需求，最好还是先搞清楚这些细节。看到网上还有人说到N73，其实只支持视频为MPEG4 Simple Profile / Advanced Simple Profile及H.263 Profile 0 &amp; 3，音频为AMR-NB/WB或者AAC-LC, HE-AAC的mp4文件。如果你放一个视频格式为H.264/AVC的mp4上去，是无法播放出画面来的。</p>
<p>在网上找了一些工具，如MP4UI,MP4BOX,Yamb(mp4box的GUI程序),采用它们进行extract操作后发现，原来的SBR和PS等信息咋没有了，都变成LC规格的AAC文件啦。好容易准备的测试流，难道还是不能用？于是一番苦寻发现，可能是SBR和PS等信息在ADTS头中是无法体现的，所以分析ADTS格式头的AAC，就无法判别是否是HE和HEv2啦。但是我总觉得SBR和PS等技术信息在AAC流中应该还是存在的。因为我还在一个国外的论坛上看到这么几句话：There’s no requirement for MP4 with AAC to have SBR indicated in the headers. It’s still correct not to have it marked and have SBR or PS data in the stream anyway. Likewise, decoding a frame and not seeing any SBR or PS info doesn’t mean you can’t find it further up in the stream anyway（我理解就是说SBR OR PS信息不一定在Header中有，但是并不意味着你不能进一步在stream中发现它）。</p>
<p><strong>HE-AAC的.mp4码流，经过extract出AAC(ADTS)后，44.1KHZ的变成了22.05KHZ。HEv2-AAC的.mp4码流，经过extract出AAC(ADTS)后，不但44.1KHZ的变成了22.05KHZ(一半)，连2channels也变成了1channels</strong>，这个问题更奇怪了，在论坛上找，发现也有人有此问题：“I get 22050Hz, 1 channel for audio that is in fact 44100Hz, 2channels and having both SBR and PS”。</p>
<p>后来看到MSDN中的AAC Decoder的描述中有这么一小段话：
The media type gives the sample rate and number of channels prior to the application of spectral band replication (SBR) and parametric stereo (PS) tools, if present. The effect of the SBR tool is to double the decoded sample rate relative to the core AAC-LC sample rate. The effect of the PS tool is to decode stereo from a mono-channel core AAC-LC stream.
我的理解是AAC的decoder如果支持SBR和PS，会将AAC-HEV1(SBR)中的sample rate提高一倍，而会将AAC-HEV2(SBR+PS)中不仅sample rate提高一倍，单声道也提高至双声道了。结合前面提到的SBR(频段复制)和PS(参数立体声）技术的简单介绍，好像觉得这样是有点儿道理的哦~~
用IPP example提供的解码工具simple_player简单试了下，对于44.1khz，stereo的HEv2-AAC的.mp4码流，经过extract出22.05KHZ，mono 的AAC(ADTS)后，再使用simple_player进行音频解码测试，解完后，果然发现又恢复了44.1khz和stereo。（但目前也测试了好几种extract出的HE和HEv2的aac码流，有的能将sample rate和channel 又double回来，有的又不能，这个具体原因是不是由于Ipp example提供的解码器的问题还不确定）。</p>
<p>另外，用simple_player如果直接decoder编码出的经过封装的.mp4格式的AAC音频的话，发现：其它都正常，只AAC-HEv2格式的.mp4音频解码后变成了单声道。难道是解码器中的PS tools没能发挥作用？初步估计应该是IPP 的那个小解码器的问题吧。</p>
<h5 id="AAC封装格式"><a href="#AAC封装格式" class="headerlink" title="AAC封装格式"></a>AAC封装格式</h5><p><img src="http://images.wodekouwei.com/media/aac_format.jpg" alt="image">
以常用的两个格式为例:</p>
<ul>
<li><strong>ADIF</strong>：Audio Data Interchange Format 音频数据交换格式。这种格式的特征是可以确定的找到这个音频数据的开始，不需进行在音频数据流中间开始的解码，即它的解码必须在明确定义的开始处进行。故这种格式常用在磁盘文件中。</li>
<li><strong>ADTS</strong>：Audio Data Transport Stream 音频数据传输流。这种格式的特征是它是一个有同步字的比特流，解码可以在这个流中任何位置开始。它的特征类似于mp3数据流格式。
简单说，ADTS可以在任意帧解码，也就是说它每一帧都有头信息。ADIF只有一个统一的头，所以必须得到所有的数据后解码。且这两种的header的格式也是不同的，具体的组织结构在这里就不详说了。</li>
</ul>
<blockquote>
<p>参考:
<a href="http://blog.csdn.net/axdc_qa_team/article/details/4271043" target="_blank" rel="external">AAC的各种规格</a></p>
</blockquote>
<h6 id="AAC格式和M4A格式"><a href="#AAC格式和M4A格式" class="headerlink" title="AAC格式和M4A格式"></a>AAC格式和M4A格式</h6><p>AAC（Advanced Audio Coding），中文称为“高级音频编码”，出现于1997年，基于 MPEG-2的音频编码技术。由Fraunhofer IIS、杜比实验室、AT&amp;T、Sony（索尼）等公司共同开发，目的是取代MP3格式。2000年，MPEG-4标准出现后，AAC 重新集成了其特性，加入了SBR技术和PS技术，为了区别于传统的 MPEG-2 AAC 又称为 MPEG-4 AAC。AAC编码的主要扩展名有三种：</p>
<ul>
<li>.AAC - 使用MPEG-2 Audio Transport Stream( ADTS，参见MPEG-2 )容器，区别于使用MPEG-4容器的MP4/M4A格式，属于传统的AAC编码（FAAC默认的封装，但FAAC亦可输出 MPEG-4 封装的AAC）</li>
<li>.MP4 - 使用了MPEG-4 Part 14（第14部分）的简化版即3GPP Media Release 6 Basic (3gp6，参见3GP ) 进行封装的AAC编码（Nero AAC 编码器仅能输出MPEG-4封装的AAC）；</li>
<li>.M4A - 为了区别纯音频MP4文件和包含视频的MP4文件而由苹果(Apple)公司使用的扩展名，Apple iTunes 对纯音频MP4文件采用了”.M4A”命名。M4A的本质和音频MP4相同，故音频MP4文件亦可直接更改扩展名为M4A。是 MPEG-4 Audio 标准容器，而 AAC 作为一个容器是 MPEG-2 标准的。现在的 AAC-LC 就是以前制定的 MPEG-2 时代的 AAC 的更名延续，而 MPEG-4 时代的 AAC 叫 AAC-HE .AAC-LC 可以用 AAC (ADTS) 作容器也可以用 MP4 做容器，两者可以用 MP4Box 的一个命令直接转换，而 AAC-HE 只能用 MP4 做容器。</li>
</ul>
<h5 id="Sampling-Frequencies"><a href="#Sampling-Frequencies" class="headerlink" title="Sampling Frequencies"></a>Sampling Frequencies</h5><p>There are 13 supported frequencies:</p>
<ul>
<li>0: 96000 Hz</li>
<li>1: 88200 Hz</li>
<li>2: 64000 Hz</li>
<li>3: 48000 Hz</li>
<li>4: 44100 Hz</li>
<li>5: 32000 Hz</li>
<li>6: 24000 Hz</li>
<li>7: 22050 Hz</li>
<li>8: 16000 Hz</li>
<li>9: 12000 Hz</li>
<li>10: 11025 Hz</li>
<li>11: 8000 Hz</li>
<li>12: 7350 Hz</li>
<li>13: Reserved</li>
<li>14: Reserved</li>
<li>15: frequency is written explictly</li>
</ul>
<h5 id="Channel-Configurations"><a href="#Channel-Configurations" class="headerlink" title="Channel Configurations"></a>Channel Configurations</h5><p>These are the channel configurations:</p>
<ul>
<li>0: Defined in AOT Specifc Config</li>
<li>1: 1 channel: front-center</li>
<li>2: 2 channels: front-left, front-right</li>
<li>3: 3 channels: front-center, front-left, front-right</li>
<li>4: 4 channels: front-center, front-left, front-right, back-center</li>
<li>5: 5 channels: front-center, front-left, front-right, back-left, back-right</li>
<li>6: 6 channels: front-center, front-left, front-right, back-left, back-right, LFE-channel</li>
<li>7: 8 channels: front-center, front-left, front-right, side-left, side-right, back-left, back-right, LFE-channel</li>
<li>8-15: Reserved</li>
</ul>
<h5 id="术语说明"><a href="#术语说明" class="headerlink" title="术语说明"></a>术语说明</h5><ul>
<li>AAC: Advanced Audio Coding 高级音频编码</li>
<li>AAC LC: AAC with Low Complexity AAC的低复杂度配置</li>
<li>AAC plus: 也叫HE-AAC, AAC+,MPEG4 AAC LC加入SBR模块后形成的一个AAC版本</li>
<li>MPEG：Motion Picture Expert Group</li>
<li>IMDCT：反离散余弦变换</li>
<li>ADIF：Audio Data Interchange Format 音频数据交换格式</li>
<li>ADTS：Audio Data Transport Stream 音频数据传输流</li>
<li>SCE: Single Channel Element单通道元素</li>
<li>CPE: Channel Pair Element 双通道元素</li>
<li>CCE: Coupling Channel Element 藕合通道元素</li>
<li>DSE: Data Stream Element 数据流元素</li>
<li>PCE: Program Config Element 程序配置元素</li>
<li>FIL: Fill Element 填充元素</li>
<li>ICS: Individual Channel Stream 独立通道流</li>
<li>PNS: Perceptual Noise Substitution 知觉噪声替换</li>
<li>SBR: Spectral Band Replication 频段复制</li>
<li>TNS: Temporal Noise Shaping 瞬时噪声整形</li>
<li>ch：channel 通道</li>
</ul>
<h5 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h5><p>AAC-LC 是什么格式？和 AAC 有什么区别？
AAC是标准化在MPEG2和MPEG4的音频编码集合的总称。
AAC-LC是标准化AAC中AOT为2的一种音频编解码，它的特点是运算复杂度低，对内存占用小，标准化的时间早，对通性好，兼容性好，使用广。不足是算法时延高，不利于实时的音频通讯。</p>
<h4 id="问题原因分析"><a href="#问题原因分析" class="headerlink" title="问题原因分析"></a>问题原因分析</h4><p>首先<code>BufferOverFlowException</code>问题,由于音频采用AAC-HE导致MediaExtractor解析出的音频采样率为本身采样率的一半,同时创建出的解码OutputBuffer的大小是编码InputBuffer的2倍,而media-for-mobile开源项目直接将从解码器OutputBuffer取出的数据塞入编码器InputBuffer中,2倍的数据放入一倍的Buffer导致溢出,暂时的解决办法手动指定编码器InputBuffer max-size为一个较大值(10*1024).同时,由于MediaExtractor不能获取正确的audio profile,也无法确认获取到的采样率是否不正确采样率的一半,所以采用ffmpeg接口获取profile,但是ffmpeg调用<code>avcodec_open2</code>获取到的profile为-99,而且采样率依然为正常采样率一半,只有在解码一帧音频后才能得到正确的profile与采样率.</p>
<p>其次,转码进度不增加的问题,主要是High的H264视频,media-for-mobile使用一个MediaExtractor一次抽取音视频帧,如果是音频则交音频解码器,如果为视频则交视频解码器,解码后将解码帧转交编码器,编码后将数据写入MediaMuxer,将数据写入MediaMuxer的前提是吊用过addTrack,将音视频track加入到Muxer中,而addTrack需要在音视频解码若干帧后产生<code>INFO_OUTPUT_FORMAT_CHANGED</code>,若没有addTrack会导致编码后数据如法写入Muxer,卡死编码器,Baseline视频只需要少量帧就可以产生<code>INFO_OUTPUT_FORMAT_CHANGED</code>,但High视频产生<code>INFO_OUTPUT_FORMAT_CHANGED</code>需要更多的帧,而media-for-mobile中,MediaExtractor首先一直获取到的是音频数据,音频一直解码编码,但是输出的muxer时,videotrack未被添加,所以无法将音频编码器的数据写入muxer,音频解码器被卡死,而mediasource一直被产生的audio数据无法被消费,无法获取到视频数据导致视频<code>INFO_OUTPUT_FORMAT_CHANGED</code>一直无法产生,最终产生死锁,导致audio等待video的<code>INFO_OUTPUT_FORMAT_CHANGED</code>,video等待audio被读完后读到video解码产生<code>INFO_OUTPUT_FORMAT_CHANGED</code>.</p>
<p>最后将audio和video使用两个<code>MediaExtractor</code>各读取各自内容.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/08/30/at-android-start/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/30/at-android-start/" itemprop="url">
                  android自动化测试(一):UiAutomator官方介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-30T21:43:15+08:00">
                2017-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/autotest/" itemprop="url" rel="index">
                    <span itemprop="name">autotest</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>了解android测试需要查询android官方文档,android官方培训教程<a href="https://developer.android.com/training/testing/start/index.html" target="_blank" rel="external">Getting Started with Testing</a>介绍了android提供的测试类型,测试接口等,相较与网上总结的android自动化测试框架,官方文档显然分类更合理,定位更准确.</p>
<h3 id="两种测试类型"><a href="#两种测试类型" class="headerlink" title="两种测试类型"></a>两种测试类型</h3><p>在使用Android Studio创建模块时会在<code>src</code>下生成<code>androidTest</code>和<code>test</code>两个用于测试的的目录,对应下面两种测试类型.
<img src="http://images.wodekouwei.com/technology/at_sum.png" alt="image"></p>
<h4 id="本地单元测试-Local-unit-tests"><a href="#本地单元测试-Local-unit-tests" class="headerlink" title="本地单元测试(Local unit tests)"></a>本地单元测试(Local unit tests)</h4><p>位于<code>module-name/src/test/java/.</code>下,运行在PC端本地的JVM虚拟机上,并且不能访问Android框架的接口.
参考<a href="https://developer.android.com/training/testing/unit-testing/local-unit-tests.html" target="_blank" rel="external">Building Local Tests</a></p>
<h4 id="设备化测试"><a href="#设备化测试" class="headerlink" title="设备化测试"></a>设备化测试</h4><p>位于<code>module-name/src/androidTest/java/.</code>下,必须运行在Android物理设备和虚拟机上.
参考<a href="https://developer.android.com/training/testing/unit-testing/instrumented-unit-tests.html" target="_blank" rel="external">Building Instrumented Unit Tests</a></p>
<p>Instrumented unit tests are tests that run on physical devices and emulators, and they can take advantage of the Android framework APIs and supporting APIs, such as the Android Testing Support Library. You should create instrumented unit tests if your tests need access to instrumentation information (such as the target app’s Context) or if they require the real implementation of an Android framework component (such as a Parcelable or SharedPreferences object).</p>
<p>Using instrumented unit tests also helps to reduce the effort required to write and maintain mock code. You are still free to use a mocking framework, if you choose, to simulate any dependency relationships.</p>
<p>设备化单元测试分为:</p>
<ul>
<li>设备化单元测试(Instrumented Unit Test):<a href="https://developer.android.com/training/testing/unit-testing/instrumented-unit-tests.html" target="_blank" rel="external">Building Instrumented Unit Tests</a>: Build complex unit tests with Android dependencies that cannot be satisfied with mock objects.</li>
<li>组件集成测试:<a href="https://developer.android.com/training/testing/ui-testing/index.html" target="_blank" rel="external">Automating User Interface Tests</a>: Create tests to verify that the user interface behaves correctly for user interactions within a single app or for interactions across multiple apps.</li>
<li>app集成测试:<a href="https://developer.android.com/training/testing/integration-testing/index.html" target="_blank" rel="external">Testing App Component Integrations</a>: Verify the behavior of components that users do not directly interact with, such as a Service or aContent Provider.</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/08/30/at-android-uiautomator-official/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/30/at-android-uiautomator-official/" itemprop="url">
                  android自动化测试(N):UiAutomator官方介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-30T15:58:35+08:00">
                2017-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/autotest/" itemprop="url" rel="index">
                    <span itemprop="name">autotest</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Automating-User-Interface-Tests"><a href="#Automating-User-Interface-Tests" class="headerlink" title="Automating User Interface Tests"></a><a href="https://developer.android.com/training/testing/ui-testing/index.html" target="_blank" rel="external">Automating User Interface Tests</a></h3><p>User interface (UI) testing lets you ensure that your app meets its functional requirements and achieves a high standard of quality such that it is more likely to be successfully adopted by users.</p>
<p>One approach to UI testing is to simply have a human tester perform a set of user operations on the target app and verify that it is behaving correctly. However, this manual approach can be time-consuming, tedious, and error-prone. A more efficient approach is to write your UI tests such that user actions are performed in an automated way. The automated approach allows you to run your tests quickly and reliably in a repeatable manner.</p>
<blockquote>
<p>Note: It is strongly encouraged that you use Android Studio for building your test apps, because it provides project setup, library inclusion, and packaging conveniences. This class assumes you are using Android Studio.</p>
</blockquote>
<p>To automate UI tests with Android Studio, you implement your test code in a separate Android test folder (src/androidTest/java). The Android Plug-in for Gradle builds a test app based on your test code, then loads the test app on the same device as the target app. In your test code, you can use UI testing frameworks to simulate user interactions on the target app, in order to perform testing tasks that cover specific usage scenarios.</p>
<p>For testing Android apps, you typically create these types of automated UI tests:</p>
<ul>
<li>UI tests that span a single app: This type of test verifies that the target app behaves as expected when a user performs a specific action or enters a specific input in its activities. It allows you to check that the target app returns the correct UI output in response to user interactions in the app’s activities. UI testing frameworks like Espresso allow you to programmatically simulate user actions and test complex intra-app user interactions.</li>
<li>UI tests that span multiple apps: This type of test verifies the correct behavior of interactions between different user apps or between user apps and system apps. For example, you might want to test that your camera app shares images correctly with a 3rd-party social media app, or with the default Android Photos app. UI testing frameworks that support cross-app interactions, such as UI Automator, allow you to create tests for such scenarios.
The lessons in this class teach you how to use the tools and APIs in the Android Testing Support Library to build these types of automated tests. Before you begin building tests using these APIs, you must install the Android Testing Support Library, as described in Downloading the Android Testing Support Library.</li>
</ul>
<h3 id="UI-Testing"><a href="#UI-Testing" class="headerlink" title="UI Testing"></a><a href="https://stuff.mit.edu/afs/sipb/project/android/docs/tools/testing/testing_ui.html" target="_blank" rel="external">UI Testing</a></h3><p>In addition to unit testing the individual components that make up your Android application (such as activities, services, and content providers), it is also important that you test the behavior of your application’s user interface (UI) when it is running on a device. UI testing ensures that your application returns the correct UI output in response to a sequence of user actions on a device, such as entering keyboard input or pressing toolbars, menus, dialogs, images, and other UI controls.</p>
<p>Functional or black-box UI testing does not require testers to know the internal implementation details of the app, only its expected output when a user performs a specific action or enters a specific input. This approach allows for better separation of development and testing roles in your organization.</p>
<p>One common approach to UI testing is to run tests manually and verify that the app is behaving as expected. However, this approach can be time-consuming, tedious, and error-prone. A more efficient and reliable approach is to automate the UI testing with a software testing framework. Automated testing involves creating programs to perform testing tasks (test cases) to cover specific usage scenarios, and then using the testing framework to run the test cases automatically and in a repeatable manner.</p>
<h4 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h4><p>he Android SDK provides the following tools to support automated, functional UI testing on your application:</p>
<ul>
<li>uiautomatorviewer - A GUI tool to scan and analyze the UI components of an Android application.</li>
<li><p>uiautomator - A Java library containing APIs to create customized functional UI tests, and an execution engine to automate and run the tests.
To use these tools, you must have the following versions of the Android development tools installed:</p>
</li>
<li><p>Android SDK Tools, Revision 21 or higher</p>
</li>
<li>Android SDK Platform, API 16 or higher</li>
</ul>
<p><strong>Workflow for the the uiautomator testing framework</strong>
Here’s a short overview of the steps required to automate UI testing:</p>
<ol>
<li>Prepare to test by installing the app on a test device, analyzing the app’s UI components, and ensuring that your application is accessible by the test automation framework.</li>
<li>Create automated tests to simulate specific user interactions on your application.</li>
<li>Compile your test cases into a JAR file and install it on your test device along with your app.</li>
<li>Run the tests and view the test results.</li>
<li>Correct any bugs or defects discovered in testing.</li>
</ol>
<h4 id="Analyzing-Your-Application’s-UI"><a href="#Analyzing-Your-Application’s-UI" class="headerlink" title="Analyzing Your Application’s UI"></a>Analyzing Your Application’s UI</h4><p>Before you start writing your test cases, it’s helpful to familiarize yourself with the UI components (including the views and controls) of the targeted application. You can use the uiautomatorviewer tool to take a snapshot of the foreground UI screen on any Android device that is connected to your development machine. The uiautomatorviewer tool provides a convenient visual interface to inspect the layout hierarchy and view the properties of the individual UI components that are displayed on the test device. Using this information, you can later create uiautomator tests with selector objects that target specific UI components to test.</p>
<p>To analyze the UI components of the application that you want to test:</p>
<ol>
<li>Connect your Android device to your development machine.</li>
<li>Open a terminal window and navigate to <android-sdk>/tools/.</android-sdk></li>
<li><p>Run the tool with this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ uiautomatorviewer</div></pre></td></tr></table></figure>
</li>
<li><p>To capture a screen for analysis, click the Device Screenshot button in the GUI of the uiautomatorviewer tool.</p>
<blockquote>
<p>Note: If you have more than one device connected, specify the device for screen capture by setting the ANDROID_SERIAL environment variable:</p>
</blockquote>
</li>
</ol>
<p>a. Find the serial numbers for your connected devices by running this command:
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ adb devices</div><div class="line">```  </div><div class="line">b. Set the ANDROID_SERIAL environment variable to select the device to test:</div></pre></td></tr></table></figure></p>
<p>#In Windows:
set ANDROID_SERIAL=<device serial="" number=""></device></p>
<p>#In UNIX:
export ANDROID_SERIAL=<device serial="" number="">
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">If you are connected to only a single device, you do not need to set the ANDROID_SERIAL environment variable.</div><div class="line"></div><div class="line">5. View the UI properties for your application:</div><div class="line">- Hover over the snapshot in the left-hand panel to see the UI components identified by the uiautomatorviewer tool. You can view the component’s properties listed in the lower right-hand panel, and the layout hierarchy in the upper right-hand panel.</div><div class="line">- Optionally, click on the Toggle NAF Nodes button to see UI components that are not accessible to the uiautomator testing framework. Only limited information may be available for these components.</div><div class="line"></div><div class="line">#### Preparing to Test</div><div class="line">Before using the uiautomator testing framework, complete these pre-flight tasks:</div><div class="line"></div><div class="line">##### Load the application to a device</div><div class="line"></div><div class="line">If you are reading this document, chances are that the Android application that you want to test has not been published yet. If you have a copy of the APK file, you can install the APK onto a test device by using the adb tool. To learn how to install an APK file using the adb tool, see the [adb](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/adb.html#move) documentation.</div><div class="line"></div><div class="line">##### Identify the application’s UI components</div><div class="line"></div><div class="line">Before writing your `uiautomator` tests, first identify the UI components in the application that you want to test. Typically, good candidates for testing are UI components that are visible and that users can interact with. The UI components should also have visible text labels, `android:contentDescription` values, or both.</div><div class="line"></div><div class="line">You can inspect the visible screen objects in an application conveniently by using the `uiautomatorviewer` tool. For more information about how to analyze an application screen with this tool, see the section [Analyzing Your Application’s UI](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/testing/testing_ui.html#uianalaysis). For more information about the common types of UI components provided by Android, see [User Interface](https://stuff.mit.edu/afs/sipb/project/android/docs/guide/topics/ui/index.html).</div><div class="line"></div><div class="line">##### Ensure that the application is accessible</div><div class="line"></div><div class="line">This step is required because the `uiautomator` tool depends on the accessibility features of the Android framework to execute your functional UI tests. You should include these minimum optimizations to support the `uiautomator` tool:</div><div class="line">- Use the `android:contentDescription` attribute to label the `ImageButton`, `ImageView`, `CheckBox` and other user interface controls.</div><div class="line">- Provide an `android:hint` attribute instead of a content description for `EditText` fields</div><div class="line">- Associate an `android:hint` attribute with any graphical icons used by controls that provide feedback to the user (for example, status or state information).</div><div class="line">- Make sure that all the user interface elements are accessible with a directional controller, such as a trackball or D-pad.</div><div class="line">- Use the `uiautomatorviewer` tool to ensure that the UI component is accessible to the testing framework. You can also test the application by turning on accessibility services like TalkBack and Explore by Touch, and try using your application using only directional controls.</div><div class="line"></div><div class="line">For more information about implementing and testing accessibility, see [Making Applications Accessible](https://stuff.mit.edu/afs/sipb/project/android/docs/guide/topics/ui/accessibility/apps.html).</div><div class="line"></div><div class="line">&gt; Note: To identify the non-accessible components in the UI, click on the Toggle NAF Nodes option in the `uiautomatorviewer` tool.</div><div class="line"></div><div class="line">Generally, Android application developers get accessibility support for free, courtesy of the `View` and `ViewGroup` classes. However, some applications use custom view components to provide a richer user experience. Such custom components won&apos;t get the accessibility support that is provided by the standard Android UI components. If this applies to your application, ensure that the application developer exposes the custom drawn UI components to Android accessibility services, by implementing the `AccessibilityNodeProvider` class. For more information about making custom view components accessible, see [Making Applications Accessible](https://stuff.mit.edu/afs/sipb/project/android/docs/guide/topics/ui/accessibility/apps.html#custom-views).</div><div class="line"></div><div class="line">##### Configure your development environment</div><div class="line">If you&apos;re developing in Eclipse, the Android SDK provides additional tools that help you write test cases using `uiautomator` and buiild your JAR file. In order to set up Eclipse to assist you, you need to create a project that includes the `uiautomator` client library, along with the Android SDK library. To configure Eclipse:</div><div class="line"></div><div class="line">1. Create a new Java project in Eclipse, and give your project a name that is relevant to the tests you’re about to create (for example, &quot;MyAppNameTests&quot;). In the project, you will create the test cases that are specific to the application that you want to test.</div><div class="line">2. From the Project Explorer, right-click on the new project that you created, then select Properties &gt; Java Build Path, and do the following:</div><div class="line">    - Click Add Library &gt; JUnit then select JUnit3 to add JUnit support.</div><div class="line">    - Click Add External JARs... and navigate to the SDK directory. Under the platforms directory, select the latest SDK version and add both the uiautomator.jar and android.jar files.</div><div class="line">If you did not configure Eclipse as your development environment, make sure that the `uiautomator.jar` and `android.jar` files from the `&lt;android-sdk&gt;/platforms/&lt;sdk&gt;` directory are in your Java class path.</div><div class="line"></div><div class="line">Once you have completed these prerequisite tasks, you&apos;re almost ready to start creating your `uiautomator` tests.</div><div class="line"></div><div class="line">#### Creating uiautomator Tests</div><div class="line">To build a test that runs in the `uiautomator` framework, create a test case that extends the `UiAutomatorTestCase` class. In Eclipse, the test case file goes under the `src` directory in your project. Later, you will build the test case as a JAR file, then copy this file to the test device. The test JAR file is not an APK file and resides separately from the application that you want to test on the device.</div><div class="line"></div><div class="line">Because the `UiAutomatorTestCase` class extends `junit.framework.TestCase`, you can use the `JUnit` Assert class to test that UI components in the app return the expected results. To learn more about JUnit, you can read the documentation on the `junit.org` home page.</div><div class="line"></div><div class="line">The first thing your test case should do is access the device that contains the target app. It’s also good practice to start the test from the Home screen of the device. From the Home screen (or some other starting location you’ve chosen in the target app), you can use the classes provided by the `uiautomator` API to simulate user actions and to test specific UI components. For an example of how to put together a `uiautomator` test case, see the sample test case.</div><div class="line"></div><div class="line">##### uiautomator API</div><div class="line">The `uiautomator` API is bundled in the `uiautomator.jar` file under the `&lt;android-sdk&gt;/platforms/` directory. The API includes these key classes that allow you to capture and manipulate UI components on the target app:</div><div class="line">- [UiDevice](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/uiautomator/UiDevice.html)</div><div class="line">Represents the device state. In your tests, you can call methods on the UiDevice instance to check for the state of various properties, such as current orientation or display size. Your tests also can use the UiDevice instance to perform device level actions, such as forcing the device into a specific rotation, pressing the d-pad hardware button, or pressing the Home and Menu buttons.</div><div class="line">To get an instance of UiDevice and simulate a Home button press:</div></pre></td></tr></table></figure></device></p>
<p>getUiDevice().pressHome();
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- [UiSelector](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/uiautomator/UiSelector.html)</div><div class="line">Represents a search criteria to query and get a handle on specific elements in the currently displayed UI. If more than one matching element is found, the first matching element in the layout hierarchy is returned as the target UiObject. When constructing a UiSelector, you can chain together multiple properties to refine your search. If no matching UI element is found, a `UiAutomatorObjectNotFoundException` is thrown. You can use the childSelector() method to nest multiple UiSelector instances. For example, the following code example shows how to specify a search to find the first ListView in the currently displayed UI, then search within that ListView to find a UI element with the text property Apps.</div></pre></td></tr></table></figure></p>
<p>UiObject appItem = new UiObject(new UiSelector()
   .className(“android.widget.ListView”).instance(1)
   .childSelector(new UiSelector().text(“Apps”)));
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- [UiObject](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/uiautomator/UiObject.html)</div><div class="line">Represents a UI element. To create a UiObject instance, use a UiSelector that describes how to search for, or select, the UI element.</div><div class="line">The following code example shows how to construct UiObject instances that represent a Cancel button and a OK button in your application.</div></pre></td></tr></table></figure></p>
<p>UiObject cancelButton = new UiObject(new UiSelector().text(“Cancel”));
UiObject okButton = new UiObject(new UiSelector().text(“OK”));
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You can reuse the UiObject instances that you have created in other parts of your app testing, as needed. Note that the `uiautomator` test framework searches the current display for a match every time your test uses a UiObject instance to click on a UI element or query a property.</div><div class="line">In the following code example, the `uiautomator` test framework searches for a UI element with the text property OK. If a match is found and if the element is enabled, the framework simulates a user click action on the element.</div></pre></td></tr></table></figure></p>
<p>if(okButton.exists() &amp;&amp; okButton.isEnabled())
{
  okButton.click();
}
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">You can also restrict the search to find only elements of a specific class. For example, to find matches of the Button class:</div></pre></td></tr></table></figure></p>
<p>UiObject cancelButton = new UiObject(new UiSelector().text(“Cancel”)
   .className(“android.widget.Button”));
UiObject okButton = new UiObject(new UiSelector().text(“OK”)
   .className(“android.widget.Button”));
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- [UiCollection](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/uiautomator/UiCollection.html)</div><div class="line">Represents a collection of items, for example songs in a music album or a list of emails in an inbox. Similar to a UiObject, you construct a UiCollection instance by specifying a UiSelector. The UiSelector for a UiCollection should search for a UI element that is a container or wrapper of other child UI elements (such as a layout view that contains child UI elements). For example, the following code snippet shows how to construct a UiCollection to represent a video album that is displayed within a FrameLayout:</div></pre></td></tr></table></figure></p>
<p>UiCollection videos = new UiCollection(new UiSelector()
   .className(“android.widget.FrameLayout”));
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">If the videos are listed within a LinearLayout view, and you want to to retrieve the number of videos in this collection:</div></pre></td></tr></table></figure></p>
<p>int count = videos.getChildCount(new UiSelector()
   .className(“android.widget.LinearLayout”));
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">If you want to find a specific video that is labeled with the text element Cute Baby Laughing from the collection and simulate a user-click on the video:</div></pre></td></tr></table></figure></p>
<p>UiObject video = videos.getChildByText(new UiSelector()
   .className(“android.widget.LinearLayout”), “Cute Baby Laughing”);
video.click();
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Similarly, you can simulate other user actions on the UI object. For example, if you want to simulate selecting a checkbox that is associated with the video:</div></pre></td></tr></table></figure></p>
<p>UiObject checkBox = video.getChild(new UiSelector()
   .className(“android.widget.Checkbox”));
if(!checkBox.isSelected()) checkbox.click();
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- [UiScrollable](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/uiautomator/UiScrollable.html)</div><div class="line">Represents a scrollable collection of UI elements. You can use the UiScrollable class to simulate vertical or horizontal scrolling across a display. This technique is helpful when a UI element is positioned off-screen and you need to scroll to bring it into view.</div><div class="line">For example, the following code shows how to simulate scrolling down the Settings menu and clicking on an About tablet option:</div></pre></td></tr></table></figure></p>
<p>UiScrollable settingsItem = new UiScrollable(new UiSelector()
   .className(“android.widget.ListView”));
UiObject about = settingsItem.getChildByText(new UiSelector()
   .className(“android.widget.LinearLayout”), “About  tablet”);
about.click()
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">For more information about these APIs, see the uiautomator reference.</div><div class="line"></div><div class="line">##### A sample uiautomator test case</div><div class="line">The following code example shows a simple test case which simulates a user bringing up the Settings app in a stock Android device. The test case mimics all the steps that a user would typically take to perform this task, including opening the Home screen, launching the All Apps screen, scrolling to the Settings app icon, and clicking on the icon to enter the Settings app.</div></pre></td></tr></table></figure></p>
<p>package com.uia.example.my;</p>
<p>// Import the uiautomator libraries
import com.android.uiautomator.core.UiObject;
import com.android.uiautomator.core.UiObjectNotFoundException;
import com.android.uiautomator.core.UiScrollable;
import com.android.uiautomator.core.UiSelector;
import com.android.uiautomator.testrunner.UiAutomatorTestCase;</p>
<p>public class LaunchSettings extends UiAutomatorTestCase {   </p>
<p>   public void testDemo() throws UiObjectNotFoundException {   </p>
<pre><code>// Simulate a short press on the HOME button.
getUiDevice().pressHome();

// We’re now in the home screen. Next, we want to simulate
// a user bringing up the All Apps screen.
// If you use the uiautomatorviewer tool to capture a snapshot
// of the Home screen, notice that the All Apps button’s
// content-description property has the value “Apps”.  We can
// use this property to create a UiSelector to find the button.
UiObject allAppsButton = new UiObject(new UiSelector()
   .description(&quot;Apps&quot;));

// Simulate a click to bring up the All Apps screen.
allAppsButton.clickAndWaitForNewWindow();

// In the All Apps screen, the Settings app is located in
// the Apps tab. To simulate the user bringing up the Apps tab,
// we create a UiSelector to find a tab with the text
// label “Apps”.
UiObject appsTab = new UiObject(new UiSelector()
   .text(&quot;Apps&quot;));

// Simulate a click to enter the Apps tab.
appsTab.click();

// Next, in the apps tabs, we can simulate a user swiping until
// they come to the Settings app icon.  Since the container view
// is scrollable, we can use a UiScrollable object.
UiScrollable appViews = new UiScrollable(new UiSelector()
   .scrollable(true));

// Set the swiping mode to horizontal (the default is vertical)
appViews.setAsHorizontalList();

// Create a UiSelector to find the Settings app and simulate      
// a user click to launch the app.
UiObject settingsApp = appViews.getChildByText(new UiSelector()
   .className(android.widget.TextView.class.getName()),
   &quot;Settings&quot;);
settingsApp.clickAndWaitForNewWindow();

// Validate that the package name is the expected one
UiObject settingsValidation = new UiObject(new UiSelector()
   .packageName(&quot;com.android.settings&quot;));
assertTrue(&quot;Unable to detect Settings&quot;,
   settingsValidation.exists());   
</code></pre><p>  }<br>}
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### Building and Deploying Your uiautomator Tests</div><div class="line">1. Once you have coded your test, follow these steps to build and deploy your test JAR to your target Android test device:</div><div class="line">Create the required build configuration files to build the output JAR. To generate the build configuration files, open a terminal and run the following command:</div></pre></td></tr></table></figure></p>
<p><android-sdk>/tools/android create uitest-project -n <name> -t 1 -p <path></path>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">The &lt;name&gt; is the name of the project that contains your uiautomator test source files, and the &lt;path&gt; is the path to the corresponding project directory.</div><div class="line">2. From the command line, set the ANDROID_HOME variable:</div><div class="line">- In Windows:`set ANDROID_HOME=&lt;path_to_your_sdk&gt;`</div><div class="line">- In UNIX:`export ANDROID_HOME=&lt;path_to_your_sdk&gt;`</div><div class="line">3. Go to the project directory where your build.xml file is located and build your test JAR.</div></pre></td></tr></table></figure></name></android-sdk></p>
<p>ant build
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">4. Deploy your generated test JAR file to the test device by using the adb push command:</div></pre></td></tr></table></figure></p>
<p>adb push <path_to_output_jar> /data/local/tmp/
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Here’s an example:</div></pre></td></tr></table></figure></path_to_output_jar></p>
<p>adb push ~/dev/workspace/LaunchSettings/bin/LaunchSettings.jar /data/local/tmp/
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### Running uiautomator Tests</div><div class="line">Here’s an example of how to run a test that is implemented in the `LaunchSettings.jar` file. The tests are bundled in the `com.uia.example.my` package:</div></pre></td></tr></table></figure></p>
<p>adb shell uiautomator runtest LaunchSettings.jar -c com.uia.example.my.LaunchSettings
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">To learn more about the syntax, subcommands, and options for uiautomator, see the [uiautomator](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/uiautomator/index.html) reference.</div><div class="line"></div><div class="line">#### Best Practices</div><div class="line">Here are some best practices for functional UI testing with the uiautomator framework:</div><div class="line"></div><div class="line">- Ensure that you validate the same UI functions on your application across the various types of devices that your application might run on (for example, devices with different screen densities).</div><div class="line">- You should also test your UI against common scenarios such as in-coming phone calls, network interruptions, and user-initiated switching to other applications on the device.</div><div class="line"></div><div class="line">### [uiautomator tools](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/help/uiautomator/index.html)</div><div class="line">The uiautomator testing framework lets you test your user interface (UI) efficiently by creating automated functional UI testcases that can be run against your app on one or more devices.</div><div class="line"></div><div class="line">For more information on testing with the uiautomator framework, see [UI Testing](https://stuff.mit.edu/afs/sipb/project/android/docs/tools/testing/testing_ui.html).</div><div class="line"></div><div class="line">#### Syntax</div><div class="line">To run your testcases on the target device, you can use the `adb shell` command to invoke the `uiautomator` tool. The syntax is:</div></pre></td></tr></table></figure></p>
<p>adb shell uiautomator runtest <jar> -c <test_class_or_method> [options]
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Here’s an example:</div></pre></td></tr></table></figure></test_class_or_method></jar></p>
<p>adb shell uiautomator runtest LaunchSettings.jar -c com.uia.example.my.LaunchSettings
```</p>
<h4 id="Command-line-Options"><a href="#Command-line-Options" class="headerlink" title="Command-line Options"></a>Command-line Options</h4><p>The following table describes the subcommands and options for uiautomator.
Table 1. Command-line options for uiautomator</p>
<table>
<thead>
<tr>
<th>Subcommand</th>
<th>Option</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>runtest</td>
<td><code>&lt;jar&gt;</code></td>
<td>Required. The <jar> argument is the name of one or more JAR files that you deployed to the target device which contain your uiautomator testcases. You can list more than one JAR file by using a space as a separator.</jar></td>
</tr>
<tr>
<td></td>
<td><code>-c &lt;test_class_or_method&gt;</code></td>
<td>Required. The <test_class_or_method> argument is a list of one or more specific test classes or test methods from the JARs that you want uiautomator to run.Each class or method must be fully qualified with the package name, in one of these formats: package_name.class_name package_name.class_name#method_name You can list multiple classes or methods by using a space as a separator.</test_class_or_method></td>
</tr>
<tr>
<td></td>
<td>–nohup</td>
<td>Runs the test to completion on the device even if its parent process is terminated (for example, if the device is disconnected).</td>
</tr>
<tr>
<td></td>
<td>-e</td>
<td><name> <value></value></name></td>
<td>Specify other name-value pairs to be passed to test classes. May be repeated.Note: The -e options cannot be combined; you must prefix each option with a separate -e flag.</td>
</tr>
<tr>
<td></td>
<td>-e debug [true</td>
<td>false]</td>
<td>Wait for debugger to connect before starting.</td>
</tr>
<tr>
<td></td>
<td>dump    [file]</td>
<td>Generate an XML file with a dump of the current UI hierarchy. If a filepath is not specified, by default, the generated dump file is stored on the device in this location <code>/storage/sdcard0/window_dump.xml</code>.</td>
</tr>
<tr>
<td>events</td>
<td></td>
<td>Prints out accessibility events to the console until the connection to the device is terminated</td>
</tr>
</tbody>
</table>
<h3 id="UiAutomation-api"><a href="#UiAutomation-api" class="headerlink" title="UiAutomation api"></a><a href="https://developer.android.com/reference/android/app/UiAutomation.html" target="_blank" rel="external">UiAutomation api</a></h3><p>Class for interacting with the device’s UI by simulation user actions and introspection of the screen content. It relies on the platform accessibility APIs to introspect the screen and to perform some actions on the remote view tree. It also allows injecting of arbitrary raw input events simulating user interaction with keyboards and touch devices. One can think of a UiAutomation as a special type of AccessibilityService which does not provide hooks for the service life cycle and exposes other APIs that are useful for UI test automation.
这是一个通过模拟用户操作来与设备用户界面交互以及获取屏幕内容的类。它依赖于平台的辅助功能APIs来在远程的控件树上获取屏幕内容以及执行一些操作。同时它也允许通过注入原生事件(译者注:指的就是InputEvent. KeyEvent也是继承于InputEvent的，所以说它是原生事件)来模拟用户的按键和触屏操作。我们可以认为UiAutomation就是一个特殊类型的AccessibilityService,其既不会为控制服务的生命周期而提供钩子函数，也不会暴露任何其他可以直接用于用户界面测试自动化的APIs.</p>
<p>The APIs exposed by this class are low-level to maximize flexibility when developing UI test automation tools and libraries. Generally, a UiAutomation client should be using a higher-level library or implement high-level functions. For example, performing a tap on the screen requires construction and injecting of a touch down and up events which have to be delivered to the system by a call to injectInputEvent(InputEvent, boolean).
这个类暴露出来的APIs是很低层的，目的就是为了在开发用户界面测试自动化框架和库时提供最大的弹性。总的来说，一个UiAutomation客户端应该使用一些（基于UiAutomation的)更高层次的库或者实现更高层次的方法。比如，模拟一个用户在屏幕上的点击事件需要构造并注入一个按下和一个弹起事件，然后必须调用UiAutomation的一个injectInputEvent(InputEvent, boolean)的调用来发送给操作系统。</p>
<p>The APIs exposed by this class operate across applications enabling a client to write tests that cover use cases spanning over multiple applications. For example, going to the settings application to change a setting and then interacting with another application whose behavior depends on that setting.
这个类暴露出来的APIs可以跨应用，这样用户就可以编写可以跨越多个应用的测试用例脚本了。比如，打开系统的设置应用去修改一些设置然后再与另外一个依赖于该设置的应用进行交互（译者注：这个在instrumentation这个框架可以做不到的）</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/08/30/at-android-support-library/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/30/at-android-support-library/" itemprop="url">
                  android自动化测试之(N):测试支持库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-30T10:14:05+08:00">
                2017-08-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/autotest/" itemprop="url" rel="index">
                    <span itemprop="name">autotest</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="https://developer.android.com/topic/libraries/testing-support-library/index.html#setup" target="_blank" rel="external">Android官方文档-测试支持库</a></p>
</blockquote>
<p>Android 测试支持库提供了大量用于测试 Android 应用的框架。此库提供了一组 API，让您可以为应用快速构建何运行测试代码，包括 JUnit 4 和功能性用户界面 (UI) 测试。您可以从 <a href="https://developer.android.com/tools/studio/index.html" target="_blank" rel="external">Android Studio IDE</a> 或命令行运行使用这些 API 创建的测试。</p>
<p>Android 测试支持库通过 Android SDK 管理器提供。如需了解详细信息，请参阅<a href="https://developer.android.com/topic/libraries/testing-support-library/index.html#setup" target="_blank" rel="external">测试支持库设置</a></p>
<p>本页介绍了 Android 测试支持库提供了哪些工具、如何在测试环境中使用这些工具，以及库版本的相关信息。</p>
<h3 id="测试支持库功能"><a href="#测试支持库功能" class="headerlink" title="测试支持库功能"></a>测试支持库功能</h3><p>Android 测试支持库包括以下自动化测试工具：</p>
<ul>
<li>AndroidJUnitRunner：适用于 Android 且与 JUnit 4 兼容的测试运行器</li>
<li>Espresso：UI 测试框架；适合应用中的功能性 UI 测试</li>
<li>UI Automator：UI 测试框架；适合跨系统和已安装应用的跨应用功能性 UI 测试</li>
</ul>
<h4 id="AndroidJUnitRunner"><a href="#AndroidJUnitRunner" class="headerlink" title="AndroidJUnitRunner"></a>AndroidJUnitRunner</h4><p>AndroidJUnitRunner 类是一个 <a href="http://junit.org/" target="_blank" rel="external">JUnit</a> 测试运行器，可让您在 Android 设备上运行 JUnit 3 或 JUnit 4 样式测试类，包括使用 Espresso 和 UI Automator 测试框架的设备。测试运行器可以将测试软件包和要测试的应用加载到设备、运行测试并报告测试结果。此类将替换 <a href="https://developer.android.com/reference/android/test/InstrumentationTestRunner.html" target="_blank" rel="external">InstrumentationTestRunner</a> 类，后者仅支持 JUnit 3 测试。</p>
<p>此测试运行器的主要功能包括：</p>
<ul>
<li>JUnit 支持</li>
<li>访问仪器信息</li>
<li>测试筛选</li>
<li>测试分片
要求 Android 2.2（API 级别 8）或更高版本。</li>
</ul>
<h5 id="JUnit-支持"><a href="#JUnit-支持" class="headerlink" title="JUnit 支持"></a>JUnit 支持</h5><p>测试运行器与 JUnit 3 和 JUnit 4（最高版本为 JUnit 4.10）测试兼容。不过，请勿在同一软件包中混用 JUnit 3 和 JUnit 4 测试代码，因为这可能会导致意外结果。如果要创建一个 JUnit 4 仪器测试类以在设备或模拟器上运行，则测试类必须以 <code>@RunWith(AndroidJUnit4.class)</code> 注解作为前缀。</p>
<p>以下代码段显示了如何编写 JUnit 4 仪器测试来验证 CalculatorActivity 类中的 add 操作是否正常工作。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">import android.support.test.runner.AndroidJUnit4;</div><div class="line">import android.support.test.runner.AndroidJUnitRunner;</div><div class="line">import android.test.ActivityInstrumentationTestCase2;</div><div class="line"></div><div class="line">@RunWith(AndroidJUnit4.class)</div><div class="line">public class CalculatorInstrumentationTest</div><div class="line">        extends ActivityInstrumentationTestCase2&lt;CalculatorActivity&gt; &#123;</div><div class="line"></div><div class="line">    @Before</div><div class="line">    public void setUp() throws Exception &#123;</div><div class="line">        super.setUp();</div><div class="line"></div><div class="line">        // Injecting the Instrumentation instance is required</div><div class="line">        // for your test to run with AndroidJUnitRunner.</div><div class="line">        injectInstrumentation(InstrumentationRegistry.getInstrumentation());</div><div class="line">        mActivity = getActivity();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void typeOperandsAndPerformAddOperation() &#123;</div><div class="line">        // Call the CalculatorActivity add() method and pass in some operand values, then</div><div class="line">        // check that the expected value is returned.</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @After</div><div class="line">    public void tearDown() throws Exception &#123;</div><div class="line">        super.tearDown();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="访问仪器信息"><a href="#访问仪器信息" class="headerlink" title="访问仪器信息"></a>访问仪器信息</h5><p>您可以使用 <a href="https://developer.android.com/reference/android/support/test/InstrumentationRegistry.html" target="_blank" rel="external">InstrumentationRegistry</a> 类访问与测试运行相关的信息。此类包括 <a href="https://developer.android.com/reference/android/app/Instrumentation.html" target="_blank" rel="external">Instrumentation</a> 对象、目标应用 Context 对象、测试应用 Context 对象，以及传递到测试中的命令行参数。使用 UI Automator 框架编写测试或编写依赖于 Instrumentation 或 Context 对象的测试时，此数据非常有用。</p>
<h5 id="测试筛选"><a href="#测试筛选" class="headerlink" title="测试筛选"></a>测试筛选</h5><p>在 JUnit 4.x 测试中，您可以使用注解对测试运行进行配置。此功能可将向测试中添加样板文件和条件代码的需求降至最低。除了 JUnit 4 支持的标准注解外，测试运行器还支持 Android 特定的注解，包括：</p>
<ul>
<li><code>@RequiresDevice</code>：指定测试仅在物理设备而不在模拟器上运行。</li>
<li><code>@SdkSupress</code>：禁止在低于给定级别的 Android API 级别上运行测试。例如，要禁止在低于 18 的所有 API 级别上运行测试，请使用注解 - - @SDKSupress(minSdkVersion=18)。</li>
<li><code>@SmallTest</code>、<code>@MediumTest</code> 和 <code>@LargeTest</code>：指定测试的运行时长以及运行频率。<h5 id="测试分片"><a href="#测试分片" class="headerlink" title="测试分片"></a>测试分片</h5>测试运行器支持将单一测试套件拆分成多个碎片，因此您可以将属于同一碎片的测试作为一个组在同一 Instrumentation 实例下运行。每个分片由一个索引号进行标识。运行测试时，使用 -e numShards 选项指定要创建的独立分片数量，并使用 -e shardIndex 选项指定要运行哪个分片。</li>
</ul>
<p>例如，要将测试套件拆分成 10 个分片，且仅运行第二个碎片中的测试，请使用以下命令：</p>
<p><code>adb shell am instrument -w -e numShards 10 -e shardIndex 2</code>
要详细了解如何使用此测试运行器，请参阅 <a href="https://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="external">API 参考</a>。</p>
<h4 id="Espresso"><a href="#Espresso" class="headerlink" title="Espresso"></a>Espresso</h4><p>Espresso 测试框架提供了一组 API 来构建 UI 测试，用于测试应用中的用户流。利用这些 API，您可以编写简洁、运行可靠的自动化 UI 测试。Espresso 非常适合编写白盒自动化测试，其中测试代码将利用所测试应用的实现代码详情。</p>
<p>Espresso 测试框架的主要功能包括：</p>
<ul>
<li>灵活的 API，用于目标应用中的视图和适配器匹配。如需了解详细信息，请参阅视图匹配。</li>
<li>一组丰富的操作 API，用于自动化 UI 交互。如需了解详细信息，请参阅操作 API。</li>
<li>UI 线程同步，用于提升测试可靠性。如需了解详细信息，请参阅 UI 线程同步。
要求 Android 2.2（API 级别 8）或更高版本。</li>
</ul>
<h5 id="视图匹配"><a href="#视图匹配" class="headerlink" title="视图匹配"></a>视图匹配</h5><p>利用 Espresso.onView() 方法，您可以访问目标应用中的 UI 组件并与之交互。此方法接受 Matcher 参数并搜索视图层次结构，以找到符合给定条件的相应 View 实例。您可以通过指定以下条件来优化搜索：</p>
<ul>
<li>视图的类名称</li>
<li>视图的内容描述</li>
<li>视图的 R.id</li>
<li>在视图中显示的文本
例如，要找到 ID 值为 my_button 的按钮，可以指定如下匹配器：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">onView(withId(R.id.my_button));</div></pre></td></tr></table></figure>
</li>
</ul>
<p>如果搜索成功，onView() 方法将返回一个引用，让您可以执行用户操作并基于目标视图对断言进行测试。</p>
<h5 id="适配器匹配"><a href="#适配器匹配" class="headerlink" title="适配器匹配"></a>适配器匹配</h5><p>在 AdapterView 布局中，布局在运行时由子视图动态填充。如果目标视图位于某个布局内部，而该布局是从 AdapterView（例如 ListView 或 GridView）派生出的子类，则 onView() 方法可能无法工作，因为只有布局视图的子集会加载到当前视图层次结构中。</p>
<p>因此，请使用 Espresso.onData() 方法访问目标视图元素。Espresso.onData() 方法将返回一个引用，让您可以执行用户操作并根据 AdapterView 中的元素对断言进行测试。</p>
<h5 id="操作-API"><a href="#操作-API" class="headerlink" title="操作 API"></a>操作 API</h5><p>通常情况下，您可以通过根据应用的用户界面执行某些用户交互来测试应用。借助 ViewActions API，您可以轻松地实现这些操作的自动化。您可以执行多种 UI 交互，例如：</p>
<ul>
<li>视图点击</li>
<li>滑动</li>
<li>按下按键和按钮</li>
<li>键入文本</li>
<li>打开链接
例如，要模拟输入字符串值并按下按钮以提交该值，您可以像下面一样编写自动化测试脚本。ViewInteraction.perform() 和 DataInteraction.perform() 方法采用一个或多个 ViewAction 参数，并以提供的顺序运行操作。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// Type text into an EditText view, then close the soft keyboard</div><div class="line">onView(withId(R.id.editTextUserInput))</div><div class="line">    .perform(typeText(STRING_TO_BE_TYPED), closeSoftKeyboard());</div><div class="line"></div><div class="line">// Press the button to submit the text change</div><div class="line">onView(withId(R.id.changeTextBt)).perform(click());</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="UI-线程同步"><a href="#UI-线程同步" class="headerlink" title="UI 线程同步"></a>UI 线程同步</h5><p>由于计时问题，Android 设备上的测试可能随机失败。此测试问题称为测试不稳定。在 Espresso 之前，解决方法是在测试中插入足够长的休眠或超时期或添加代码，以便重试失败的操作。Espresso 测试框架可以处理 Instrumentation 与 UI 线程之间的同步；这就消除了对之前的计时解决方法的需求，并确保测试操作与断言更可靠地运行。</p>
<p>要详细了解如何使用 Espresso，请参阅 <a href="https://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="external">API 参考</a>和<a href="https://developer.android.com/training/testing/ui-testing/espresso-testing.html" target="_blank" rel="external">测试单个应用的 UI </a>培训。</p>
<h4 id="UI-Automator"><a href="#UI-Automator" class="headerlink" title="UI Automator"></a>UI Automator</h4><p>UI Automator 测试框架提供了一组 API 来构建 UI 测试，用于在用户应用和系统应用中执行交互。利用 UI Automator API，您可以执行在测试设备中打开“设置”菜单或应用启动器等操作。UI Automator 测试框架非常适合编写黑盒自动化测试，其中的测试代码不依赖于目标应用的内部实现详情。</p>
<p>UI Automator 测试框架的主要功能包括：</p>
<ul>
<li>用于检查布局层次结构的查看器。如需了解详细信息，请参阅 UI Automator 查看器。</li>
<li>在目标设备上检索状态信息并执行操作的 API。如需了解详细信息，请参阅访问设备状态。</li>
<li>支持跨应用 UI 测试的 API。如需了解详细信息，请参阅 UI Automator API。
要求 Android 4.3（API 级别 18）或更高版本。</li>
</ul>
<h5 id="UI-Automator-查看器"><a href="#UI-Automator-查看器" class="headerlink" title="UI Automator 查看器"></a>UI Automator 查看器</h5><p>uiautomatorviewer 工具提供了一个方便的 GUI，可以扫描和分析 Android 设备上当前显示的 UI 组件。您可以使用此工具检查布局层次结构，并查看在设备前台显示的 UI 组件属性。利用此信息，您可以使用 UI Automator（例如，通过创建与特定可见属性匹配的 UI 选择器）创建控制更加精确的测试。</p>
<p>uiautomatorviewer 工具位于 <code>&lt;android-sdk&gt;/tools/</code>目录中。</p>
<h5 id="访问设备状态"><a href="#访问设备状态" class="headerlink" title="访问设备状态"></a>访问设备状态</h5><p>UI Automator 测试框架提供了一个 UiDevice 类，用于在目标应用运行的设备上访问和执行操作。您可以调用其方法来访问设备属性，如当前屏幕方向或显示尺寸。UiDevice 类还可用于执行以下操作：</p>
<ul>
<li>更改设备旋转</li>
<li>按 D-pad 按钮</li>
<li>按“返回”、“主屏幕”或“菜单”按钮</li>
<li>打开通知栏</li>
<li>对当前窗口进行屏幕截图
例如，要模拟按下“主屏幕”按钮，请调用 <code>UiDevice.pressHome()</code> 方法。</li>
</ul>
<h5 id="UI-Automator-API"><a href="#UI-Automator-API" class="headerlink" title="UI Automator API"></a>UI Automator API</h5><p>利用 UI Automator API，您可以编写稳健可靠的测试，而无需了解目标应用的实现详情。您可以使用这些 API 在多个应用中捕获和操作 UI 组件：</p>
<ul>
<li><a href="https://developer.android.com/reference/android/support/test/uiautomator/UiCollection.html" target="_blank" rel="external">UiCollection</a>：枚举容器的 UI 元素以便计算子元素个数，或者通过可见的文本或内容描述属性来指代子元素。</li>
<li><a href="https://developer.android.com/reference/android/support/test/uiautomator/UiObject.html" target="_blank" rel="external">UiObject</a>：表示设备上可见的 UI 元素。</li>
<li><a href="https://developer.android.com/reference/android/support/test/uiautomator/UiScrollable.html" target="_blank" rel="external">UiScrollable</a>：为在可滚动 UI 容器中搜索项目提供支持。</li>
<li><a href="https://developer.android.com/reference/android/support/test/uiautomator/UiSelector.html" target="_blank" rel="external">UiSelector</a>：表示在设备上查询一个或多个目标 UI 元素。</li>
<li><a href="https://developer.android.com/reference/android/support/test/uiautomator/Configurator.html" target="_blank" rel="external">Configurator</a>：允许您设置运行 UI Automator 测试所需的关键参数。
例如，以下代码显示了如何编写可在设备中调用默认应用启动器的测试脚本：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// Initialize UiDevice instance</div><div class="line">mDevice = UiDevice.getInstance(getInstrumentation());</div><div class="line"></div><div class="line">// Perform a short press on the HOME button</div><div class="line">mDevice.pressHome();</div><div class="line"></div><div class="line">// Bring up the default launcher by searching for</div><div class="line">// a UI component that matches the content-description for the launcher button</div><div class="line">UiObject allAppsButton = mDevice</div><div class="line">        .findObject(new UiSelector().description(&quot;Apps&quot;));</div><div class="line"></div><div class="line">// Perform a click on the button to bring up the launcher</div><div class="line">allAppsButton.clickAndWaitForNewWindow();</div></pre></td></tr></table></figure>
</li>
</ul>
<p>要详细了解如何使用 UI Automator，请参阅 <a href="https://developer.android.com/reference/android/support/test/package-summary.html" target="_blank" rel="external">API 参考</a>和<a href="https://developer.android.com/training/testing/ui-testing/uiautomator-testing.html" target="_blank" rel="external">测试多个应用的 UI </a>培训。</p>
<h3 id="测试支持库设置"><a href="#测试支持库设置" class="headerlink" title="测试支持库设置"></a>测试支持库设置</h3><p>Android 测试支持库软件包在最新版本的 Android 支持存储库中提供，后者可作为辅助组件通过 Android SDK 管理器下载。</p>
<p>要通过 SDK 管理器下载 Android 支持存储库，请执行以下操作：</p>
<ul>
<li>启动 Android SDK 管理器。</li>
<li>在 SDK 管理器窗口中，滚动到 Packages 列表末尾，找到 Extras 文件夹并展开（如有必要）以显示其内容。</li>
<li>选择 Android Support Repository 项。</li>
<li>点击 Install packages… 按钮。</li>
</ul>
<p>下载后，此工具会将支持存储库文件安装到您现有的 Android SDK 目录中。库文件位于 SDK 的以下子目录中：<code>&lt;sdk&gt;/extras/android/m2repository</code> 目录。</p>
<p>Android 测试支持库的类位于 <code>android.support.test</code> 软件包中。</p>
<p>要在 Gradle 项目中使用 Android 测试支持库，请在 build.gradle 文件中添加这些依赖关系：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">  androidTestCompile &apos;com.android.support.test:runner:0.4&apos;</div><div class="line">  // Set this dependency to use JUnit 4 rules</div><div class="line">  androidTestCompile &apos;com.android.support.test:rules:0.4&apos;</div><div class="line">  // Set this dependency to build and run Espresso tests</div><div class="line">  androidTestCompile &apos;com.android.support.test.espresso:espresso-core:2.2.1&apos;</div><div class="line">  // Set this dependency to build and run UI Automator tests</div><div class="line">  androidTestCompile &apos;com.android.support.test.uiautomator:uiautomator-v18:2.1.2&apos;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>要将 AndroidJUnitRunner 设置为 Gradle 项目中的默认测试仪器运行器，请在 build.gradle 文件中指定此依赖关系：</p>
<p>``
android {
    defaultConfig {
        testInstrumentationRunner “android.support.test.runner.AndroidJUnitRunner”
    }
}
```</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/08/29/at-android-adb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/29/at-android-adb/" itemprop="url">
                  android自动化测试之(N):adb工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-29T14:43:09+08:00">
                2017-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/autotest/" itemprop="url" rel="index">
                    <span itemprop="name">autotest</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android手机自动化测试过程离不开adb工具,介绍几个常用的adb命令.</p>
<h3 id="1-adb-forward"><a href="#1-adb-forward" class="headerlink" title="1. adb forward"></a>1. <code>adb forward</code></h3><p>命令示例:
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb forward tcp:8000 tcp:9000</div></pre></td></tr></table></figure></p>
<p>作用:
把PC端8000端口的数据, 转发到Android端的9000端口上,PC端的8000端口会被 adb
监听, 这个时候我们只需要往8000端口写数据, 这个数据就会发送到手机端的9000端口上.</p>
<h3 id="2-adb-connect"><a href="#2-adb-connect" class="headerlink" title="2. adb connect"></a>2. <code>adb connect</code></h3><p>命令示例:
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adb connect + IP</div></pre></td></tr></table></figure></p>
<p>作用:
通过无线网络在PC端adb连接手机端</p>
<p>注意:</p>
<ol>
<li>要链接的IP ，必须和自己的PC的网络在同一个局域网内，adb 不能跨局域网链接设备</li>
<li>如果通过usb链接Android设备，通过adb devices 可以看见设备列表，但是使用不了，可以参考下面的命令说明手机端的服务未开启,需要连接usb开启手机服务,默认端口5555:<code>adb tcpip 5555</code>,开启后拔掉usb通过<code>adb connect 192.168.0.101:5555</code>即可连接</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://wodekouwei.com/2017/08/24/tips-recyclerview-selectable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="轻口味">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="老司机种菜">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/24/tips-recyclerview-selectable/" itemprop="url">
                  RecyclerView实现单选列表
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-24T00:49:31+08:00">
                2017-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>常规方法：
在Javabean里增加一个boolean isSelected字段，
并在Adapter里根据这个字段的值设置“CheckBox”的选中状态。
在每次选中一个新优惠券时，改变数据源里的isSelected字段，
并notifyDataSetChanged()刷新整个列表。
这样实现起来很简单，代码量也很少，唯一不足的地方就是性能有损耗，不是最优雅。
So作为一个有追求 今天比较闲 的程序员，我决心分享一波优雅方案。</p>
<p>本文会列举分析一下在ListView和RecyclerView中, 列表实现单选的几种方案，并推荐采用定向刷新 部分绑定的方案，因为更高效and优雅</p>
<h3 id="1常规方案"><a href="#1常规方案" class="headerlink" title="1常规方案:"></a>1常规方案:</h3><p>常规方案 请光速阅读，直接上码：
Bean结构：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class TestBean extends SelectedBean &#123;</div><div class="line">    private String name;</div><div class="line">    public TestBean(String name,boolean isSelected) &#123;</div><div class="line">        this.name = name;</div><div class="line">        setSelected(isSelected);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我项目里有好多单选需求，懒得写isSelected字段，所以弄了个父类供子类继承。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class SelectedBean &#123;</div><div class="line">    private boolean isSelected;</div><div class="line">    public boolean isSelected() &#123;</div><div class="line">        return isSelected;</div><div class="line">    &#125;</div><div class="line">    public void setSelected(boolean selected) &#123;</div><div class="line">        isSelected = selected;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Acitivity 和Adapter其他方法都是最普通的不再赘述。
Adapter的onBindViewHolder()如下：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">Log.d(&quot;TAG&quot;, &quot;onBindViewHolder() called with: holder = [&quot; + holder + &quot;], position = [&quot; + position + &quot;]&quot;);</div><div class="line">        holder.ivSelect.setSelected(mDatas.get(position).isSelected());//“CheckBox”</div><div class="line">        holder.tvCoupon.setText(mDatas.get(position).getName());//TextView</div><div class="line">        holder.ivSelect.setOnClickListener(new View.OnClickListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onClick(View view) &#123;</div><div class="line">                //实现单选，第一种方法，十分简单， Lv Rv通用,因为它们都有notifyDataSetChanged()方法</div><div class="line">                // 每次点击时，先将所有的selected设为false，并且将当前点击的item 设为true， 刷新整个视图</div><div class="line">                for (TestBean data : mDatas) &#123;</div><div class="line">                    data.setSelected(false);</div><div class="line">                &#125;</div><div class="line">                mDatas.get(position).setSelected(true);</div><div class="line">                notifyDataSetChanged();</div><div class="line"></div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">ViewHolder：</div><div class="line"></div><div class="line">    public static class CouponVH extends RecyclerView.ViewHolder &#123;</div><div class="line">        private ImageView ivSelect;</div><div class="line">        private TextView tvCoupon;</div><div class="line"></div><div class="line">        public CouponVH(View itemView) &#123;</div><div class="line">            super(itemView);</div><div class="line">            ivSelect = (ImageView) itemView.findViewById(R.id.ivSelect);</div><div class="line">            tvCoupon = (TextView) itemView.findViewById(R.id.tvCoupon);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>方案优点：简单粗暴</li>
<li>方案缺点：
其实需要修改的Item只有两项：
一个当前处于选中状态的Item-&gt;普通状态
再将当前手指点击的这个Item-&gt;选中状态
但采用普通方案，则会刷新整个一屏可见的Item，重走他们的getView()/onBindViewHolder()方法。
其实一个屏幕一般最多可见10+个Item，遍历一遍也无伤大雅。
但咱们还是要有追求优雅的心，所以我们继续往下看。</li>
</ul>
<h3 id="2-利用Rv的notifyItemChanged-定向刷新"><a href="#2-利用Rv的notifyItemChanged-定向刷新" class="headerlink" title="2 利用Rv的notifyItemChanged()定向刷新:"></a>2 利用Rv的notifyItemChanged()定向刷新:</h3><p>本方案可以中速阅读</p>
<ol>
<li><p>本方案需要在Adapter里新增一个字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private int mSelectedPos = -1;//实现单选  方法二，变量保存当前选中的position</div></pre></td></tr></table></figure>
</li>
<li><p>在设置数据集时(构造函数，setData()方法等：)，初始化 mSelectedPos 的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//实现单选方法二： 设置数据集时，找到默认选中的pos</div><div class="line">for (int i = 0; i &lt; mDatas.size(); i++) &#123;</div><div class="line">    if (mDatas.get(i).isSelected()) &#123;</div><div class="line">        mSelectedPos = i;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>onClick里代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//实现单选方法二： notifyItemChanged() 定向刷新两个视图</div><div class="line">//如果勾选的不是已经勾选状态的Item</div><div class="line">if (mSelectedPos!=position)&#123;</div><div class="line">    //先取消上个item的勾选状态</div><div class="line">    mDatas.get(mSelectedPos).setSelected(false);</div><div class="line">    notifyItemChanged(mSelectedPos);</div><div class="line">    //设置新Item的勾选状态</div><div class="line">    mSelectedPos = position;</div><div class="line">    mDatas.get(mSelectedPos).setSelected(true);</div><div class="line">    notifyItemChanged(mSelectedPos);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>本方案由于调用了notifyItemChanged()，所以还会伴有“白光一闪”的动画。</p>
<ul>
<li><p>方案优点：
本方案，较优雅了，不会重走一屏可见的Item的getView()/onBindViewHolder()方法，
但仍然会重走需要修改的两个Item的getView()/onBindViewHolder()方法，</p>
</li>
<li><p>方案缺点：
我们实际上需要修改的，只是里面“CheckBox”的值，
按照在DiffUtil一文学习到的姿势，术语应该是“Partial bind “，
（安利时间,没听过DiffUtil和Partial bind的 戳-&gt;：【Android】详解7.0带来的新工具类：DiffUtil）
我们需要的只是部分绑定。</p>
</li>
</ul>
<p>一个疑点：
使用方法2 在第一次选中其他Item时，切换selected状态时，
查看log，并不是只重走了新旧Item的onBindViewHolder()方法，还走了两个根本不在屏幕范围里的Item的onBindViewHolder()方法，
如，本例中 在还有item 0-3 在屏幕里，默认勾选item1，我选中item0后，log显示postion 4,5,0,1 依次执行了onBindViewHolder()方法。
但是再次切换其他Item时， 会符合预期：只走需要修改的两个Item的getView()/onBindViewHolder()方法。
原因未知，有朋友知道烦请告知，多谢。</p>
<h3 id="3-Rv-实现部分绑定（推荐）"><a href="#3-Rv-实现部分绑定（推荐）" class="headerlink" title="3 Rv 实现部分绑定（推荐）:"></a>3 Rv 实现部分绑定（推荐）:</h3><p>利用RecyclerView的 findViewHolderForLayoutPosition()方法，获取某个postion的ViewHolder，按照源码里这个方法的注释，它可能返回null。所以我们需要注意判空，（空即在屏幕不可见）。
与方法2只有onClick里的代码不一样，核心还是利用mSelectedPos 字段搞事情。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">//实现单选方法三： RecyclerView另一种定向刷新方法：不会有白光一闪动画 也不会重复onBindVIewHolder</div><div class="line">CouponVH couponVH = (CouponVH) mRv.findViewHolderForLayoutPosition(mSelectedPos);</div><div class="line">if (couponVH != null) &#123;//还在屏幕里</div><div class="line">    couponVH.ivSelect.setSelected(false);</div><div class="line">&#125;else &#123;</div><div class="line">    //add by 2016 11 22 for 一些极端情况，holder被缓存在Recycler的cacheView里，</div><div class="line">    //此时拿不到ViewHolder，但是也不会回调onBindViewHolder方法。所以add一个异常处理</div><div class="line">    notifyItemChanged(mSelectedPos);</div><div class="line">&#125;</div><div class="line">mDatas.get(mSelectedPos).setSelected(false);//不管在不在屏幕里 都需要改变数据</div><div class="line">//设置新Item的勾选状态</div><div class="line">mSelectedPos = position;</div><div class="line">mDatas.get(mSelectedPos).setSelected(true);</div><div class="line">holder.ivSelect.setSelected(true);</div></pre></td></tr></table></figure></p>
<ul>
<li>方案优点：
定向刷新两个Item，只修改必要的部分，不会重走onBindViewHolder()，属于手动部分绑定。代码量也适中，不多。</li>
<li>方案缺点：
没有白光一闪动画？？？（如果这算缺点）</li>
</ul>
<h3 id="4-Rv-利用payloads实现部分绑定-不推荐"><a href="#4-Rv-利用payloads实现部分绑定-不推荐" class="headerlink" title="4 Rv 利用payloads实现部分绑定(不推荐):"></a>4 Rv 利用payloads实现部分绑定(不推荐):</h3><p>本方案属于开拓思维，是在方案2的基础上，利用payloads和notifyItemChanged(int position, Object payload)搞事情。
不知道payloads是什么的，看不懂此方案的，我又要安利：（戳-&gt;：【Android】详解7.0带来的新工具类：DiffUtil）
onClick代码如下：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//实现单选方法四：</div><div class="line">if (mSelectedPos != position) &#123;</div><div class="line">    //先取消上个item的勾选状态</div><div class="line">    mDatas.get(mSelectedPos).setSelected(false);</div><div class="line">    //传递一个payload</div><div class="line">    Bundle payloadOld = new Bundle();</div><div class="line">    payloadOld.putBoolean(&quot;KEY_BOOLEAN&quot;, false);</div><div class="line">    notifyItemChanged(mSelectedPos, payloadOld);</div><div class="line">    //设置新Item的勾选状态</div><div class="line">    mSelectedPos = position;</div><div class="line">    mDatas.get(mSelectedPos).setSelected(true);</div><div class="line">    Bundle payloadNew = new Bundle();</div><div class="line">    payloadNew.putBoolean(&quot;KEY_BOOLEAN&quot;, true);</div><div class="line">    notifyItemChanged(mSelectedPos, payloadNew);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>需要重写三参数的onBindViewHolder() 方法：
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void onBindViewHolder(CouponVH holder, int position, List&lt;Object&gt; payloads) &#123;</div><div class="line">    if (payloads.isEmpty()) &#123;</div><div class="line">        onBindViewHolder(holder, position);</div><div class="line">    &#125; else &#123;</div><div class="line">        Bundle payload = (Bundle) payloads.get(0);</div><div class="line">        if (payload.containsKey(&quot;KEY_BOOLEAN&quot;)) &#123;</div><div class="line">            boolean aBoolean = payload.getBoolean(&quot;KEY_BOOLEAN&quot;);</div><div class="line">            holder.ivSelect.setSelected(aBoolean);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li><p>方案优点：
同方法3</p>
</li>
<li><p>方案缺点：
代码量多，实现效果和方法三一样，仅做开拓思维用，所以选择方法三。</p>
</li>
</ul>
<p>作者：张旭童
链接：<a href="http://www.jianshu.com/p/1ac13f74da63" target="_blank" rel="external">http://www.jianshu.com/p/1ac13f74da63</a>
來源：简书</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://images.wodekouwei.com/avatar/winnle_the_pooh.jpg"
               alt="轻口味" />
          <p class="site-author-name" itemprop="name">轻口味</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">94</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/qingkouwei" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/LightTaste" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/turnpp/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  豆瓣
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/shen-jun-wei-9/" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/ossrs/srs" title="SRS" target="_blank">SRS</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">轻口味</span>
</div>

<div>
<a href="http://www.miitbeian.gov.cn/">京ICP备17018543号</a>

        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人次
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "bb46b146831e4e34808d09cd94c85f50",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

</body>
</html>
